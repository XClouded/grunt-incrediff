!function(a,b,c){function d(){return{wrap:a("#J_address"),init:function(a,b){var c=this;c.id=a,c.type=b||"",c.address_data=void 0,j=!1,c.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageOut:function(){setTimeout(function(){c.lib.memCache.removeValue("update_delivery")},100)},setAfterPageIn:function(){this._setBtnText(j?"取消":"编辑")},_renderStatic:function(){var a=this,b={swipeid:k.getState().data.referer||"index"},d=c.ui.tmpl(g.html(),b);a.wrap.html(d),e=a.wrap.find("#J_address_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;a.state=k.getState(),a.state_data=a.state.data.data,a.async=!0,lib.mtop.request({api:"mtop.life.diandian.getUserAddressByUserId",v:"1.0",data:{pagenum:30},extParam:{}},function(b){b.data&&(a.address_data=b.data,a.startUp(b.data)),a.async=!1},function(b){c.ui.toast(b,a),a.async=!1})},_setBtnText:function(b){i.supportFunc("setOptionMenu")?i.push("setOptionMenu",{title:b},function(){}):a("#J_address_options").text(b)},startUp:function(b){var d=this,g={addressList:b.addressList,id:d.id,swipeid:k.getState().data.referer||"index",editCls:j?" edit":""},l=c.ui.tmpl(h.html(),g);e.html(l),"checkdelivery"!==d.type&&(i.supportFunc("showOptionMenu")?i.push("showOptionMenu"):a("#J_address_options").show()),f=a("#J_address_list"),!b.addressList.length&&f.addClass("empty"),d._iScrollInit()},events:[[c.event.click,"#J_address_add","_addressAddHandler"],[c.event.click,"#J_address_my","_addressMyHandler"],[c.event.click,"li.J_address_item","_addressItemHandler"],[c.event.click,"#J_address_options","_editHandler"]],_addressAddHandler:function(){var b="address_operate/add/"+this.type,d={push:{ddid:b,obj:{referer:"address/"+this.id,data:{}}}};a("#J_address_operate").removeAttr("data-ddid"),c.lib.ddState(d)},_addressMyHandler:function(b,c){this._getMyAddList(a(c))},_addressItemHandler:function(b,d){var e=this,g=a(d).index(),h=b.target;if("checkdelivery"==e.type){c.lib.memCache.set("update_checkdelivery_address",e.address_data.addressList[g]),c.lib.localStorage.set("default_address",e.address_data.addressList[g]);var i={back:{ddid:"delivery"}};c.lib.ddState(i)}else if(j){if(h!=d){if(a(h).hasClass("edit")||a(h).parent("span.edit")&&a(h).parent("span.edit").length)return void e._pushEdit(a(d));(a(h).hasClass("del")||a(h).parent("span.del")&&a(h).parent("span.edit").length)&&(f.find("li").length>1?e._pushDelete(a(d)):c.ui.toast("至少保留一个外卖地址哦"))}}else e._Use4Delivery(g)},menuEvent:"_editHandler",_editHandler:function(){var a=this;a.async||(j?(f.children().removeClass("edit"),a._setBtnText("编辑"),j=!1):(f.children().addClass("edit"),a._setBtnText("取消"),j=!0),a.mainScroll&&a.mainScroll.refresh())},_Use4Delivery:function(b){var d=this;if(c.lib.localStorage.set("default_address",d.address_data.addressList[b]),c.lib.memCache.set("update_delivery",!0),/deliverycarte/.test(d.type)){var e={back:{ddid:d.type.split("_")[1]}};c.lib.ddState(e)}else if(/carte_/.test(d.type)){var e={push:{ddid:"carte/delivery/"+d.type.split("_")[1]}};c.lib.ddState(e)}else{a("#J_delivery").removeAttr("data-ddid"),c.lib.memCache.removeValue("delivery_filter_data");var e={back:{ddid:"delivery",multi:!0}};c.lib.ddState(e)}},_getMyAddList:function(){var b="my_address/get/"+this.type,d={push:{ddid:b,obj:{referer:"address/"+this.id}}};a("#J_my_address").removeAttr("data-ddid"),c.lib.ddState(d)},_pushDelete:function(a){var b=this,d=a.attr("data-id"),e=c.lib.localStorage.get("default_address");return e&&e.id==d?void c.ui.toast("不能删除当前外卖地址哦"):void lib.mtop.request({api:"mtop.life.diandian.deleteUserAddressById",v:"1.0",data:{id:d},extParam:{}},function(c){c.data&&1==c.data.result&&(b._spliceAddress(a.index()),a.remove())},function(a){console.log(a)})},_spliceAddress:function(a){this.address_data.addressList.splice(a,1)},_pushEdit:function(b){var d=this,e=b.index(),f="address_operate/"+b.data("id")+"/"+d.type;a("#J_address_operate").removeAttr("data-ddid");var g={push:{ddid:f,obj:{data:d.address_data.addressList[e],referer:"address/"+d.id}}};c.lib.ddState(g)},_iScrollInit:function(){this._scroll=c.ui._scroll({wrap:"#J_address_scroll"})},_pullDownAction:function(){this._renderDynamic()}}}var e,f,g=a("#J_tpl_address"),h=a("#J_tpl_address_content"),i=b.bridge,j=!1,k=b.History;c.app.Address=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:i,init:function(a,b){var c=this;c.role=a,c.type=b,c.wrap.on("setAmapLoad",function(){c._renderDynamic()}),c.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageOut:function(){g.addEventListener("touchmove",c.event.touchmoveHandler,!1),f&&(f.destroy()||(f=void 0))},setBeforePageIn:function(){g.removeEventListener("touchmove",c.event.touchmoveHandler,!1),!f&&l&&this._mapInit()},_renderStatic:function(){var b=this,d=c.ui.tmpl(j.html(),{referer:m.getState().data.referer||"index"});b.startUp(d),"show"==b.role&&(a("#J_address_map_cancl").html("返回"),i.find(".hd_title").html("<h2>查看</h2>"),h.push("setTitle",{title:"查看"})),e=b.wrap.find("#J_address_map_content").html(c.ui.tpl.load)},_titleLazy:!0,_renderDynamic:function(){var a=this;if(l){if(e.html(k.html()),"show"!=a.role){var b=m.getState().url,d=b&&c.lib.getUriParam(b,"ddid");d=d||"index",c._menuHandler=c._menuHandler||{},c._menuHandler[d]={context:a,handler:"_saveHandler"}}a._mapInit(),setTimeout(function(){a._setTitleBtn()},300)}else a._loadMapScript()},_setTitleBtn:function(){var b=this;"show"!=b.role&&(h.supportFunc("setOptionMenu")?(h.push("setOptionMenu",{title:"保存"}),h.push("showOptionMenu")):a("#J_address_map_save").show()),a("#J_address_map").find(".pointer").hide()},startUp:function(a){this.wrap.html(a)},events:[[c.event.click,"#J_address_map_save","_saveHandler"]],_saveHandler:function(){var b=this;b.async||(b.async=!0,lib.mtop.request({api:"mtop.life.diandian.insertOrUpdateUserAddress",v:"1.0",data:{posx:f.getCenter().getLng(),posy:f.getCenter().getLat(),id:b.address_data.id,address:b.address_data.address,mobile:b.address_data.mobile,citycode:b.address_data.citycode,userName:b.address_data.name,cityName:b.address_data.cityName},extParam:{}},function(d){var e=d.data;if(a("#J_address").removeAttr("data-ddid"),b.async=!1,c.lib.localStorage.set("default_address",e),c.lib.memCache.set("update_delivery",!0),b.type){/carte_/.test(b.type)&&(ddid="carte/delivery/"+b.type.split("_")[1]);var f={back:{ddid:ddid,multi:!0}};c.lib.ddState(f)}else if("add"==b.role){var f={back:{ddid:"delivery",multi:!0}};c.lib.ddState(f)}else{var f={back:{ddid:"address/"+e.id,multi:!0}};c.lib.ddState(f)}},function(a){c.ui.toast(a),b.async=!1}))},_loadMapScript:function(){var a=g.createElement("script");a.type="text/javascript",a.src="http://webapi.amap.com/maps?v=1.2&key=92243f86c4efa64a75b5aff559f6a7cd&callback=onAmapLoad",g.body.appendChild(a)},_mapInit:function(){var b=this;if(console.log(b.role),"show"!=b.role&&c.ui.toast("亲，请拖动地图确保你的地址准确"),b.address_data=m.getState().data.data,f=new AMap.Map("J_map_container",{center:new AMap.LngLat(b.address_data.posx,b.address_data.posy),level:13}),"show"==b.role){var d=new AMap.Marker({position:f.getCenter()});d.setMap(f)}else{var d=new AMap.Marker({position:new AMap.LngLat(b.address_data.posx,b.address_data.posy),draggable:!0,cursor:"move",raiseOnDrag:!0});d.setMap(f)}b.address_data.areas&&b.address_data.areas.length&&a.each(b.address_data.areas,function(a,c){b._addPolygon(c,f)})},_addPolygon:function(a,b){for(var c=new Array,d=0;d<a.length;d++)c.push(new AMap.LngLat(a[d].lo,a[d].la));var e=new AMap.Polygon({path:c,strokeColor:"#464afa",strokeOpacity:.7,strokeWeight:2,fillColor:"#cbf9f2",fillOpacity:.6});e.setMap(b)}}}var e,f,g=b.document,h=b.bridge,i=a("#J_address_map"),j=a("#J_tpl_address_map"),k=a("#J_tpl_address_map_content"),l=c.lib.memCache.get("amap_load"),m=b.History;b.onAmapLoad=function(){l=!0,i.trigger("setAmapLoad",[i]),c.lib.memCache.set("amap_load",!0)},c.app.AddressMap=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:f,init:function(a,b){var c=this;c.async=!1,c.role=a,c.type=b||"",h.update=!1,c.state=i.getState(),c.state_data=c.state.data||{},c.state_data.data=c.state_data.data||{},c.state_data.referer=i.getState().data.referer||"index",c.initHandler()},initHandler:function(){this._renderStatic()},setBeforePageIn:function(){c.lib.memCache.get("update_city")&&this._updateCity()},setBeforePageOut:function(){document.activeElement.blur()},_renderStatic:function(){var a=this;e.supportFunc("setOptionMenu")&&e.push("setOptionMenu",{title:"保存"},function(){}),"add"==a.role?a.startUp():a._addressEdit()},_addressEdit:function(){var a=this;for(var b in a.state_data.data)h[b]=a.state_data.data[b];a.startUp()},startUp:function(){var a=this,b=c.ui.tmpl(g.html(),a.state_data);f.html(b);for(var d in a.state_data.data)h[d]=a.state_data.data[d];a.input_user=f.find(".J_input_user"),a.input_phone=f.find(".J_input_phone"),a.input_address=f.find(".J_input_address"),a.input_city=f.find("#J_address_operate_city");var e;(e=c.lib.localStorage.get("default_address"))&&(c.lib.memCache.set("address_operate_city",[e.citycode,e.cityName,e.posx,e.posy]),c.lib.memCache.set("update_city",!0),a._updateCity())},events:[[c.event.click,"#J_address_operate_save","_saveHandler"],[c.event.click,".J_switch_city","_switchCityHandler"],[c.event.click,"#J_modify_map","_mapHandler"]],menuEvent:"_saveHandler",_saveHandler:function(){var a=this;if(!a.async&&a._validForm()){if(a.state_data.data.address&&h.update)return void a._getPosxyByAddress();if(a.state_data.data.address!==a.input_address.val())return void a._getPosxyByAddress();a._saveOperate()}},_switchCityHandler:function(b,d){var e={push:{ddid:"city_all",obj:{referer_citycode:a(d).data("citycode"),referer:"address_operate/"+this.role}}};c.lib.ddState(e)},_mapHandler:function(){var b=this;b._validForm()&&(a.trim(b.input_address.val())?(h.posx=b.state_data.data.posx,h.posy=b.state_data.data.posy,b._pushMap()):c.ui.toast("详细地址不能为空"))},_updateCity:function(){var b=this;b.address_data=c.lib.memCache.get("address_operate_city"),a("#J_address_operate_city").text(b.address_data[1]),h.citycode=b.address_data[0],h.cityName=b.address_data[1],h.posx=b.address_data[2],h.posy=b.address_data[3],h.update=!0},_getPosxyByAddress:function(){var a=this;a.async=!0,lib.mtop.request({api:"mtop.life.diandian.getPosxyByAddress",v:"1.0",data:{cityname:h.cityName,id:h.id,citycode:h.citycode,address:h.address},extParam:{}},function(b){var c=b.data;h.posx=c.posx,h.posy=c.posy,a._pushMap(),a.async=!1},function(b){c.ui.toast(b),a.async=!1})},_pushMap:function(){var b=this,d="address_map";d="add"==b.role?d+"/add/"+b.type:d+"/edit/"+b.type,a("#J_address_map").removeAttr("data-ddid");var e={push:{ddid:d,obj:{data:h,referer:"address_operate/"+b.role}}};c.lib.ddState(e)},_saveOperate:function(){var b=this;lib.mtop.request({api:"mtop.life.diandian.insertOrUpdateUserAddress",v:"1.0",data:{posx:h.posx,posy:h.posy,id:h.id,address:h.address,mobile:b.input_phone.val(),citycode:h.citycode,userName:b.input_user.val(),cityName:h.cityName},extParam:{}},function(d){var e=d.data;a("#J_address").removeAttr("data-ddid"),c.lib.localStorage.set("default_address",e),c.lib.memCache.set("update_delivery",!0);var f,g="push";f=b.type&&/carte_/.test(b.type)?"carte/delivery/"+b.type.split("_")[1]:"add"==b.role?"delivery":isNaN(b.role)?i.getState().data.referer:"address/"+b.role;for(var h=0;h<c.crumbs.length;h++){var j=c.crumbs[h];j==f&&(g="back")}console.log(g+" "+f);var k={};k[g]={ddid:f,multi:"add"==b.role||b.type?!0:!1},c.lib.ddState(k)},function(a){c.ui.toast(a)})},_validForm:function(){var b=this;if(!b.input_user.val())return void c.ui.toast("姓名不能为空");if(!b.input_phone.val())return void c.ui.toast("手机号码不能为空");var d=a.trim(b.input_phone.val());if(this._validPhone(d))return b.input_address.val()?(h.name=b.input_user.val(),h.mobile=d,h.address=b.input_address.val(),h.cityName=b.input_city.text(),!0):void c.ui.toast("详细地址不能为空")},_validPhone:function(a){return a?a>13e9&&19e9>a?!0:void c.ui.toast("请输入正确的手机号码！"):void c.ui.toast("请输入手机号")}}}var e=b.bridge,f=a("#J_address_operate"),g=a("#J_tpl_address_operate"),h={},i=b.History;c.app.AddressOperate=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:a("#J_my_address"),init:function(a,b){var c=this;c.id=a,c.type=b||"",c.address_data=void 0,i=!1,c.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageOut:function(){c.lib.memCache.removeValue("update_my_address")},_renderStatic:function(){var a=this,b={alt:j.getState().data.referer||"my_address"},d=c.ui.tmpl(g.html(),b);a.wrap.html(d),e=a.wrap.find("#J_my_address_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;a.state=j.getState(),a.state_data=a.state.data.data,a.async=!0,lib.mtop.request({api:"mtop.life.diandian.getAllAddressFromTB",v:"1.0",data:{},extParam:{}},function(b){b.data&&(a.address_data=b.data,a._buildTmpl(b.data)),a.async=!1},function(b){c.ui.toast(b,a),a.async=!1})},_buildTmpl:function(b){var d=this,e={myAddressList:b.list,swipeid:j.getState().data.referer||"index"},g=c.ui.tmpl(h.html(),e);d.startUp(g),f=a("#J_myaddress_list")},startUp:function(a){e.html(a)},events:[[c.event.click,".J_address_add","_addHandler"],[c.event.click,"li.J_my_address_item","_itemHandler"]],_addHandler:function(){this._pushAdd()},_itemHandler:function(b,c){var d=a(c).index();this._pushAdd(this.address_data.list[d])},_pushAdd:function(){var b="address_operate/add/"+this.type,d=arguments[0]||{},e={push:{ddid:b,obj:{data:d,referer:"my_address/get"}}};a("#J_address_operate").removeAttr("data-ddid"),c.lib.ddState(e)}}}var e,f,g=(b.bridge,a("#J_tpl_my_address")),h=a("#J_tpl_my_addressItem"),i=!1,j=b.History;c.app.MyAddress=function(){return new d}}(Zepto,window,window.dd),$(function(){function a(){(90==window.orientation||-90==window.orientation)&&dd.ui.toast("请使用竖屏模式，确保最佳体验!")}dd.device.iosStyle&&$("body").addClass("ios"),dd.device.notSuppprtFixed&&$("body").addClass("fixed-container"),window.applicationCache.addEventListener("updateready",function(){dd.ui.toast("页面更新中..."),window.applicationCache.update(),window.applicationCache.swapCache(),setTimeout(function(){location.reload()},10)},!1),document.addEventListener("touchmove",dd.event.touchmoveHandler,!1),window.onorientationchange=a,a(),FastClick.attach(document.body),$("body").on(dd.event.click+".device",".J_deviceuri",function(){dd.lib.deviceUri($(this).attr("data-uri"))}),dd.lib.getH5Geo();var b={defaultPage:"index",dataPage:{index:{view:dd.app.Index},dian:{view:dd.app.Dian},delivery:{view:dd.app.Delivery},delivery_hot:{view:dd.app.DeliveryHot},address:{view:dd.app.Address},address_operate:{view:dd.app.AddressOperate},my_address:{view:dd.app.MyAddress},address_map:{view:dd.app.AddressMap},carte:{view:dd.app.Carte},carte_intelligent:{view:dd.app.CarteIntelligent},carte_check:{view:dd.app.CarteCheck},carte_checkdelivery:{view:dd.app.CarteCheckDelivery},my:{view:dd.app.My},check:{view:dd.app.Check},pay_detail:{view:dd.app.PayDetail},pay_result:{view:dd.app.PayResult},my_order:{view:dd.app.Myorder},my_order_details:{view:dd.app.MyOrderDetails},my_delivery:{view:dd.app.MyDelivery},my_delivery_details:{view:dd.app.MyDeliveryDetails},my_delivery_refund:{view:dd.app.MyDeliveryRefund},my_pay:{view:dd.app.MyPay},my_pay_details:{view:dd.app.MyPayDetails},my_evoucher:{view:dd.app.MyEvoucher},my_evoucher_details:{view:dd.app.MyEvoucherDetails},my_evoucher_shoplist:{view:dd.app.MyEvoucherShopList},carte_index:{view:dd.app.CarteIndex},store:{view:dd.app.Store},store_card:{view:dd.app.StoreCard},shop:{view:dd.app.Shop},review:{view:dd.app.Review},reviewlist:{view:dd.app.ReviewList},atelist:{view:dd.app.AteList},atedetails:{view:dd.app.AteDetails},search:{view:dd.app.Search},city:{view:dd.app.City},city_all:{view:dd.app.CityAll},evoucher:{view:dd.app.Evoucher},evoucher_buy:{view:dd.app.EvoucherBuy},reserve_shops:{view:dd.app.ReserveShops},reserve_datelist:{view:dd.app.ReserveDatelist},reserve_date:{view:dd.app.ReserveDate},reserve_confirm:{view:dd.app.ReserveConfirm},my_reserve:{view:dd.app.MyReserve},my_reserve_details:{view:dd.app.MyReserveDetails},my_customer_service:{view:dd.app.MyCustomerService},my_feedback:{view:dd.app.MyFeedBack}}},c=dd.StatePage(b);c.init()}),function(a,b,c){function d(){return{wrap:a("#J_carte"),init:function(a,b,d,e){var f=this;f.storeId="",f.takeoutShopId="",f.fromItg=!1,f.orderId=void 0,f.optionType="diandefault",f.carteType="",f.showItem=void 0,"dian"==a?(f.storeId=b,f.showItem=d):/dianadd|dianmod/.test(a)?(f.storeId=b,f.orderId=a.split("_")[1],f.optionType=a.split("_")[0]):"delivery"==a?(f.takeoutShopId=b,f.carteType=a,f.showItem=d):"itg"==a&&(f.storeId=b,f.fromItg=!0),f.idPlus=f.storeId||f.takeoutShopId,f.orderIndex=void 0,f.orderTime=void 0,f.autionId=void 0,f.reserveTime=void 0,f.isReserve=!1,d&&e&&(f.idPlus+=d+e,f.orderIndex=d,f.orderTime=e,f.isReserve=!0),f.referer=z.getState().data.referer||"",f.type=f.takeoutShopId?2:1,f.flag=null,m=c.lib.localStorage.get("inorder_data")||{},f.reset_carte=c.lib.memCache.get("reset_carte")||!1,f.reserver_date=c.lib.localStorage.get("reserve_date")||void 0,f._canBuild=x[f.idPlus]&&x[f.idPlus].detailItems,f.slide_config={minY:0,maxY:0,offsetTop:0},f.showDelivery=f.showDelivery||{},f.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){var a=this;a._canBuild&&a._buildTmpl(),o&&o.enable(),p&&p.enable(),w.supportFunc("setOptionMenu")&&w.push("setOptionMenu",{icon:"http://g.dd.alicdn.com/tps/i3/T1ybhDFLFdXXXCWhje-36-36.png"},function(){})},setAfterPageOut:function(){o&&o.disable(),p&&p.disable()},setBeforePageOut:function(){},_renderStatic:function(){var a=this,b={fromItg:a.fromItg},d=c.ui.tmpl(q.html(),b);a.wrap.html(d),j=a.wrap.find("#J_carte_sub_save"),k=a.wrap.find("#J_carte_sub_itg"),l=a.wrap.find("#J_Difference"),f=a.wrap.find("#J_carte_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;if(a._canBuild){if(a._inorderInit(),a.carteType){var b=c.lib.localStorage.get("default_address");if(!b)return void a._pushAddressList();var d=c.lib.localStorage.get("default_address").id;a.showDelivery[d+"_"+a.takeoutShopId],a._buildDeliveryTip()}}else a._getCartes()},_getCartes:function(){var a=this;if(a.reserver_date&&a.isReserve){var b=a.reserver_date;a.autionId=b.storeInfo.list[b.index].auctionId||null,a.reserveTime=a.reserver_date.reserveTime||null}lib.mtop.request({api:"mtop.life.diandian.getDetailItems",v:"3.0",data:{localstoreId:a.storeId,takeoutShopId:a.takeoutShopId,type:a.type,shopType:0,flag:1,reserveAuctionId:a.autionId,reserveTime:a.reserveTime},extParam:{}},function(b){if(b.data){if(b.data.localstoreStatus&&"1"!==b.data.localstoreStatus)return w.push("alert",{title:"提示",message:"该店目前"+("0"==b.data.localstoreStatus?"暂停营业":"已歇业"),buttons:["确定"]}),void c.lib.ddState({back:{}});if(b.data.takeoutShopStatus&&"1"!==b.data.takeoutShopStatus)return w.push("alert",{title:"提示",message:"该店目前"+("0"==b.data.takeoutShopStatus?"暂停营业":"已歇业"),buttons:["确定"]}),void c.lib.ddState({back:{}});x[a.idPlus]={},x[a.idPlus].detailItems=b.data,a._inorderInit(),a._buildTmpl(),a.carteType&&a._buildDeliveryTip()}},function(b){c.ui.toast(b,a)})},_goStoreDetail:function(){var a=this,b=a.wrap.find(".hd_icon");c.lib.ddState({push:{ddid:b.data("swipeid"),obj:{referer:b.data("referer")}}})},_inorderInit:function(){var a=this;m[a.idPlus]=m[a.idPlus]||c.config.carte.resetInorderData(),c.lib.localStorage.set("inorder_data",m)},_buildDeliveryTip:function(){var a=this,b=c.lib.localStorage.get("default_address");try{b?lib.mtop.request({api:"mtop.takeout.delivery.check",v:"1.0",data:{shopId:a.takeoutShopId,addressId:b.id},extParam:{}},function(b){b.data&&(a.showDelivery="0"==b.data.delivery,"0"==b.data.delivery&&a._showNavigationTip())},function(a){c.ui.toast(a)}):lib.mtop.request({api:"mtop.life.diandian.getDefaultUserAddressById",v:"1.0",data:{},extParam:{}},function(d){d.data&&(c.lib.localStorage.set("default_address",d.data.model),a.default_address=d.data.model,b=d.data.model,lib.mtop.request({api:"mtop.takeout.delivery.check",v:"1.0",data:{shopId:a.takeoutShopId,addressId:b.id},extParam:{}},function(b){b.data&&(a.showDelivery[a.default_address.id+"_"+a.takeoutShopId]="0"==b.data.delivery,"0"==b.data.delivery&&a._showNavigationTip())},function(a){c.ui.toast(a)}))},function(){a._pushAddressList()})}catch(d){}},_pushAddressList:function(){c.ui.toast("请先选择送餐地址");var b={push:{ddid:"address/0/carte_"+this.takeoutShopId,obj:{referer:"carte/delivery/"+this.takeoutShopId}}};c.lib.ddState(b),a("#J_carte").removeAttr("data-ddid")},_showNavigationTip:function(){var b=this,d='<div class="navigate-tip-wrap"><div class="navigate-tip"><p class="title">抱歉！本店暂时无法配送到您选择的送餐地址。您可以<p class="option" rel="delivery">查看附近的外卖</p><p class="option" rel="address">更换送餐地址</p><p class="option last">取消</p></div></div><div>',e=a("<div class='mask'></div>").appendTo(".carte_wrap"),f=a(d).appendTo(".carte_wrap");f.on("click",function(d){var g,h=d.target;h.className&&-1!=h.className.indexOf("option")&&((g=a(h).attr("rel"))&&c.lib.ddState({push:{ddid:"delivery"==g?"delivery":"address/"+c.lib.localStorage.get("default_address").id+"/carte_"+b.takeoutShopId,obj:{referer:"carte/delivery/"+b.takeoutShopId}}}),e.remove(),f.remove(),a("#J_carte, #J_delivery").removeAttr("data-ddid"))})},_buildTmpl:function(){var b=this;b.fromItg&&b._pushItgData();var d=x[b.idPlus].detailItems,e=d.localstoreStatus,j={discountDesc:d.discountDesc||"",notice:d.notice||"",mobile:"1"==e?d.mobile:d.takeoutShopTele,storeName:"1"==e?d.storeName:d.takeoutShopName,cateItems:d.cateItems?d.cateItems:[],storeId:b.storeId||b.takeoutShopId,takeoutShopId:b.takeoutShopId,alt:b.takeoutShopId?b.referer||"delivery":b.referer||"dian",fromItg:b.fromItg,reserverTime:b.reserveTime},k=c.ui.tmpl(r.html(),j);if(f.html(k),j.cateItems.length){g=a("#J_carte_bottom_tip"),h=g.find(".J_order_count"),i=b.wrap.find(".J_carte_sub");var l=b.wrap.find("#J_menu_wrapper"),m=l.children().height();b.slide_config.el=l.children(),b.slide_config.maxY=m-l.height(),b.slide_config.offsetTop=l.offset().top,b._iScrollInit(),b._manualHandler(),c._hideTitleBar&&w.push("setTitle",{title:j.storeName||"淘点点"}),b.takeoutShopId&&c.common.delivery.getTags({id:b.takeoutShopId,callback:function(a){b._buildDeliveryTags(a)}})}},_buildDeliveryTags:function(b){var c=this;if(b.result&&b.result.length){var d=x[c.idPlus].detailItems,e=c.wrap.find("#J_discount_item"),f=[];d.notice?a.each(b.result,function(a,b){f.push('<i class="tag" style="background-image:url('+b.picPath+')"></i>')}):a.each(b.result,function(a,b){0==a?(e.parents(".discount_line").show(),c.wrap.find(".carte_content").addClass("has_tip"),c.wrap.find(".icon_hui").css({backgroundImage:"url("+b.picPath+")",backgroundPosition:"0 0",backgroundSize:"cover"}),e.children().html(b.desc)):f.push('<i class="tag" style="background-image:url('+b.picPath+')"></i>')}),e.append(f.join(""))}},_pushItgData:function(){var a=this,b=z.getState(),d=x[a.idPlus].detailItems.cateItems;n=b.data.intelligent2carte,m[a.idPlus].itg={},m[a.idPlus].itg={},c.lib.localStorage.set("inorder_data",m),a._eachItg(d,0),setTimeout(function(){a._inOrderTotal(m[a.idPlus])},100)},_eachItg:function(a,b){var d=this,e=a[b];if(e){for(var f=e.itemList,g=0,h=0,i=f.length;i>h;h++){var j=f[h],k=j.itemId;j.sku.length;var l=n["itg_"+k];if(l){var o=m[d.idPlus].itg,p=j.itemId;o[p]=j,o[p].inOrder=parseInt(l.inOrder),c.lib.localStorage.set("inorder_data",m),g++}}b++,d._eachItg(a,b)}},_manualHandler:function(){var b=this,c=b.wrap.find("#J_discount_item");if(c.length){var d=c.children();d.width()>c.width()&&c.addClass("marquee_alternate")}b.startUp(a("#J_carte_menu li").first()),b._syncMenuLeft(),m[b.idPlus]&&b._inOrderTotal(m[b.idPlus])},startUp:function(b){var d=this;if(!b.hasClass(u)&&!b.hasClass("none")){d.flag=b.data("flag");var e=b.index(),f=x[d.idPlus].detailItems.cateItems[e],g=c.ui.tmpl(s.html(),{data:f,reserveTime:d.reserveTime});a("#J_carte_list").html(g),b.addClass(u).siblings("."+u).removeClass(u),d._syncMenuRight(b)}},events:[[c.event.click,"#J_carte_menu li","_menuHandler"],[c.event.click,".J_carte_options","_optionsHandler"],[c.event.click,".J_Carte_Arrow","_showSku"],[c.event.click,".J_discount_del","_discountDelHandler"],[c.event.click,"#J_carte_sub_save","_subSaveHandler"],[c.event.click,"#J_carte_sub_itg","_subItgHandler"],[c.event.click,"#J_carte_list .J_pop_detail","_popHandler"],[c.event.click,".J_carte_pop_options","_popOptionsHandler"],[c.event.click,".J_pop_add","_popAddHandler"],["touchstart","#J_menu_wrapper .menu_scroller","_touchstartHandler"],["touchmove","#J_menu_wrapper .menu_scroller","_touchmoveHandler"],["touchend","#J_menu_wrapper .menu_scroller","_touchendHandler"]],menuEvent:"_goStoreDetail",_menuHandler:function(d,e){var f=this;c.device.iosStyle||b.scrollTo(0,0),f.startUp(a(e))},_showSku:function(b,c){a(c).toggleClass("down"),a(c).parent(".items_wrap").next(".J_CarteSku").toggle()},_optionsHandler:function(b,c){this._carteOptions(a(c))},_popAddHandler:function(b,c){var d=this,e=a(c),f=d.wrap.find("#J_carte_item_"+e.data("itemid"));e.hide().siblings().show();var g=f.find(".plus");this._carteOptions(g,!0)},_popOptionsHandler:function(b,c){var d=this,e=a(c),f=e.data("role"),g=d.wrap.find("#J_carte_item_"+e.data("itemid")),h=g.find("."+f);this._carteOptions(h,!0)},_discountDelHandler:function(b,c){var d=this;a(c).parents(".discount_line").remove(),f.find(".has_tip").removeClass("has_tip"),o&&o.refresh(),p&&p.refresh(),x[d.idPlus].detailItems.discountDesc=null,x[d.idPlus].detailItems.notice=null},_popHandler:function(b,c){var d=a(b.target);d.hasClass("arrow")||d.hasClass("arrow_wrap")||this._showCartePop(a(c))},_touchstartHandler:function(a){var b=this,d=b.slide_config;if(!c.device.iosStyle&&d.maxY>0){d.moveon=!0,d.el[0].style.webkitTransition="0ms",d.d_y=a.touches[0].pageY-document.body.scrollTop;var e=d.el[0].style.webkitTransform;if(e){var f=e.match(/\-?[0-9]+/g);d.current_y=parseInt(f[0])}else d.current_y=0}},_touchmoveHandler:function(a){var b=this,c=b.slide_config;c.moveon&&(a.preventDefault(),setTimeout(function(){c.y=a.touches[0].pageY-document.body.scrollTop,c.s_y=c.y-c.d_y,c.el[0].style.webkitTransform="translateY("+(c.s_y+c.current_y)+"px)"},0))},_touchendHandler:function(){var a=this,b=a.slide_config;b.moveon&&setTimeout(function(){var c=b.el[0].style.webkitTransform;if(c){c=c.match(/\-?[0-9]+/g);var d=c[0];d>0&&a._move(0),d<-b.maxY&&a._move(-b.maxY)}b.moveon=!1},10)},_move:function(a){var b=this,c=b.slide_config;c.el[0].style.webkitTransition="100ms",c.el[0].style.webkitTransform="translateY("+a+"px)"},_subSaveHandler:function(b,c){var d=this;a(c).hasClass(v)||w.push("login",function(){d._carteSub()})},_subItgHandler:function(b,c){!a(c).hasClass(v)&&this._carteSubItg()},_syncMenuLeft:function(){var b,c=this,d={},e=m[c.idPlus];if(e){b=c.fromItg?e.itg:e.carte;var f=x[c.idPlus].detailItems.cateItems;a.each(f,function(e,f){var g=f.cateId;a.each(f.itemList,function(e,f){var h=f.itemId,i=f.sku;i&&i.length?a.each(i,function(a,c){h=h+"_"+c.skuId,b[h]&&(d[g]?d[g]+=1:d[g]=1),h=f.itemId}):b[h]&&(d[g]?d[g]+=1:d[g]=1),c.showItem&&f.itemId==c.showItem&&(c._menuHandler("",document.getElementById("J_carte_menu_"+g)),c._popHandler("",document.querySelector("#J_carte_item_"+h+" .J_pop_detail")))})}),a.each(d,function(b,c){var d=a("#J_carte_menu_"+b);d.data("flag")||d.find(".J_menu_count").removeClass("dn").text(c)})}},_syncMenuRight:function(){var b=this,c=m[b.idPlus];if(c){var d;d=b.fromItg?c.itg:c.carte,a.each(d,function(b,c){var d,e=b.split("_");2==e.length&&(d=e[1]);var f,g,h,i,j=e[0],k=a("#J_carte_item_"+j);if(k){if(d){var l=f=k.find(".J_sku_"+d);f=l.find(".J_carte_options"),g=l.find(".J_carte_count"),i=k.find(".J_CarteSku"),h=k.find(".J_Carte_Arrow")}else f=k.find(".J_carte_options"),g=k.find(".J_carte_count");f.removeClass("dn"),g.removeClass("dn").text(c.inOrder),c.inOrder&&d&&(i.show(),h.addClass("down"))}})}},_carteSubItg:function(){var b=this;a("#J_carte_intelligent").attr("data-ddid","");var d=[];a.each(m[b.idPlus].itg,function(a,b){d.push(b)});var e="carte_intelligent/"+b.storeId,f={back:{ddid:e,obj:{carteData:{items:d,totalPrice:n.totalPrice},referer:"carte/dian/"+b.storeId}}};c.lib.ddState(f)},_carteSub:function(){var b,d,e=this,f=[];j.addClass(v),c.ui.toast.loading(),a.each(m[e.idPlus].carte,function(a,b){f.push(b.itemId+":"+(b.skuId?b.skuId:"")+":"+b.inOrder)}),lib.mtop.request({api:"mtop.life.diandian.optionCart",v:"1.0",data:{storeId:1==e.type?e.storeId:e.takeoutShopId,o:0,info:f.join(";"),bizLine:1==e.type?0:1,reserveAuctionId:e.autionId,reserveTime:e.reserveTime,orderOption:c.config.optioncart[e.optionType],orderId:e.orderId,platform:c.mtop_platform}},function(f){c.ui.toast.hide(),f.data&&(a("#J_carte").attr("data-ddid",""),1==e.type?(e.reserver_date&&e.isReserve?(b="reserve_confirm",a("#J_reserve_confirm").attr("data-ddid","")):(b="carte_check/"+e.storeId+(e.orderId?"/"+e.optionType+"_"+e.orderId:""),a("#J_carte_check").attr("data-ddid","")),d={push:{ddid:b,obj:{data:f.data,referer:"carte/dian/"+e.storeId,num:1,serveType:x[e.idPlus].detailItems.serveType}}}):2==e.type&&(b="carte_checkdelivery/"+e.takeoutShopId,a("#J_carte_checkdelivery").attr("data-ddid",""),d={push:{ddid:b,obj:{data:f.data,referer:"carte/delivery/"+e.takeoutShopId}}}),c.lib.ddState(d)),j.removeClass(v)},function(a){c.ui.toast(a),j.removeClass(v)})},initDialog:function(){this._popdialog=c.ui.dialog({cls:"carte_dialog",title:"",wrap:"#J_carte",content:c.ui.tpl.load,maxheight:"246"}),e=this.wrap.find(".J_dialog_content")},_showCartePop:function(b){var c=this,d=b.attr("data-id");if(c.initDialog(),y[d])c._renderPop(b,y[d]);else{var e=a("#J_carte_menu li").index(a("#J_carte_menu .current")),f=a("#J_carte_list li").index(b.parent());y[d]=x[c.idPlus].detailItems.cateItems[e].itemList[f],c._renderPop(b,y[d])}},_renderPop:function(a,d){{var f=a.parents("li"),g=f.find(".plus");d.itemPicUgcs?d.itemPicUgcs:[]}d.width=.86*b.document.body.clientWidth-2;var h={data:d,item:{limit:g.data("limit"),quantity:g.data("quantity"),soldcount:g.data("soldcount"),count:parseInt(f.find(".J_carte_count").text()),sku:g.data("sku"),itemid:d.itemId}},i=c.ui.tmpl(t.html(),h);e.html(i),this._popdialog.setTitle(d.itemName)},_carteOptions:function(b,d){var e=this,f=b.data("role"),g=b.parents("li"),h=b.siblings(".J_carte_count");if(d)var i=e._popdialog.wrap.find(".J_pop_options"),j=e._popdialog.wrap.find(".J_pop_add"),k=e._popdialog.wrap.find(".J_carte_count");var l;b.data("sku")&&(l=b.parents(".sku_wrap"));var m,n=a("#J_carte_menu li.current");m=e.flag?a("#J_carte_menu_"+g.data("item-cates")):n;var o=m.find(".J_menu_count"),p=parseInt(o.text()),q=parseInt(h.text());if("plus"==f){var r=parseInt(b.data("limit")),s=parseInt(b.data("quantity"));if(r&&q>=r)return void c.ui.toast("限点"+r+"份哦");if(q>=s)return void c.ui.toast("没有库存啦");q++,b.siblings().removeClass("dn"),h.text(q),d&&k.text(q),1==q&&(p++,o.text(p).removeClass("dn"))}else q--,h.text(q),d&&k.text(q),0>=q&&(b.addClass("dn").siblings(".J_carte_count").addClass("dn"),p--,o.text(p),0==p&&o.addClass("dn"),d&&(i.hide(),j.show()));this._optionStorage(n,m,g,l,q)},_optionStorage:function(a,b,d,e,f){var g,h,i=this,j=a.index(),k=d.index(),l=x[this.idPlus].detailItems.cateItems[j],n=l.itemList[k];h=i.fromItg?m[this.idPlus].itg:m[this.idPlus].carte;var o=d.data("id"),p=l.flag&&o;e?(o=o+"_"+e.data("skuid"),p=p&&p+"_"+e.data("skuid"),g=n.sku[e.index()],g.itemId=n.itemId):g=n,f?(h[o]=g,h[o].inOrder=f):delete h[o],c.lib.localStorage.set("inorder_data",m),this._inOrderTotal(m[this.idPlus])},_inOrderTotal:function(b){if(b){var d,e=this,f=0,k=0,m=0,o=x[e.idPlus].detailItems.reserveLowMoney,p=x[e.idPlus].detailItems.takeoutMinimumAmount;if(p=p&&+p>0?p:null,d=e.fromItg?b.itg:b.carte,a.each(d,function(a,b){f+=b.inOrder;var c=parseFloat(b.resDiscount||0),d=parseFloat(b.oriPrice||0),e=parseFloat(b.resDiscountMoney||0),g=parseFloat(b.itemPrice||0),h=parseFloat(b.reserveSkuDiscount||0),i=parseFloat(b.reserveDisSkuPrice||0),j=parseFloat(b.skuPrice||0);
k+=b.inOrder*(b.skuId?j:d),m+=b.inOrder*(b.skuId?h?i:j:c?e:g)}),m=c.lib.num2Fixed(m),o||p){var q=o?"起订金额还差￥%price%元":"还差%price%起送",r=c.lib.num2Fixed(Number(o||p)-m);r>0&&m>=0?(j.hide(),l.show().text(q.replace("%price%",r))):(j.show(),l.hide())}else j.show();if(f){g.show(),k=c.lib.num2Fixed(k);var s=m>=0&&m!==k?"￥"+m+'<span class="price_ori">￥'+k+"</span>":"￥"+k;setTimeout(function(){h.html("共计"+f+"个菜，"+s).show()},50),i.removeClass(v),n&&(n.totalPrice=k)}else g.hide(),i.addClass(v)}},_iScrollInit:function(){o&&(o.destroy()||(o=null)),p&&(p.destroy()||(p=null))}}}var e,f,g,h,i,j,k,l,m,n,o,p,q=a("#J_tpl_carte"),r=a("#J_tpl_carte_content"),s=a("#J_tpl_carte_list"),t=a("#J_tpl_cartepop"),u="current",v="disabled",w=b.bridge,x={},y={},z=b.History;c.app.Carte=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:a("#J_carte_check"),init:function(a,b){var d=this;d.id=a,d.orderId=void 0,d.optionType="diandefault",/dianadd|dianmod/.test(b)&&(d.orderId=b.split("_")[1],d.optionType=b.split("_")[0]),k=c.lib.localStorage.get("inorder_data")||{},d.initHandler()},initHandler:function(){this._renderStatic()},setAfterPageIn:function(){var a=this;a._iScrollInit()},setAfterPageOut:function(){e=null,f=null,g=null,h=null,i=null,j=null,k=null},setBeforePageOut:function(){i&&c.lib.memCache.set("dian_tel",i.val()),j&&c.lib.memCache.set("dian_ps",j.val()),document.activeElement.blur()},_renderStatic:function(){var a=this;a.buildTmpl()},buildTmpl:function(){var b=this;b.State=o.getState(),b.referer=b.State.data.referer||"",b.num=b.State.data.num||"",b.cartViewList=b.State.data.data.cartViewList;var d=b.State.data;d.tel=c.lib.memCache.get("dian_tel")||"",d.ps=c.lib.memCache.get("dian_ps")||"",d.alt=b.referer||"carte/dian/"+b.id;var f=c.ui.tmpl(n.html(),d);c.ui.toast.hide(),b.startUp(f),e=a("#J_carte_check_count"),g=a("#J_carte_check_save"),h=a("#J_carte_check_np"),i=a("#J_carte_check_tel"),j=a("#J_carte_check_ps"),b._manualHandler()},startUp:function(a){m.html(a)},events:[[c.event.click,".J_carte_options","_optionsHandler"],[c.event.click,"#J_carte_check_save","_checkSaveHandler"],[c.event.click,"input","_inputFocusHandler"],["blur","input","_inputBlurHandler"],["touchstart","#J_carte_check_scroll","_scrollTouchHandler"]],_scrollTouchHandler:function(){c.device.isAndroid&&c.device.nativeScroll&&document.activeElement.blur()},_optionsHandler:function(b,c){var d=this;d.async||(d.async=!0,d._carteOptions(a(c)))},_checkSaveHandler:function(){var b=this,c=a.trim(i.val());if(b._validPhone(c)){var d=parseInt(b.State.data.data.orderOption),e=parseInt(b.State.data.data.orderExtraId);2==d&&e&&"dianadd"!==b.optionType?l.push("confirm",{title:"",message:"您在本店已经下过单！",okButton:"我要加菜",cancelButton:"另下一单"},function(a){a.ok&&(b.orderId=e,b.optionType="dianadd"),b._saveRequireOptionCart(c)}):b._saveRequireOptionCart(c)}},_saveRequireOptionCart:function(a){var b=this;b._requirOptionCart({infos:b._inOrderTotal(),o:2,phone:a,num:h.val()?h.val():null,note:j.val()},b._orderSaveCallback)},_inputFocusHandler:function(b,c){a(c)},_inputBlurHandler:function(){},_manualHandler:function(){var a=this;a._carteUpdate(a.State.data.data,"init")},_validPhone:function(a){return a?a>13e9&&19e9>a?!0:void c.ui.toast("请输入正确的手机号码！"):void c.ui.toast("请输入手机号")},_orderSaveCallback:function(b){var d=this;a("#J_page").children().removeAttr("data-ddid"),c.lib.memCache.set("checkoption",!0),setTimeout(function(){c.lib.memCache.removeValue("dian_ps")},500);var e="my_order_details/"+b.extraOrderId,f={replace:{ddid:e}};delete k[d.id],c.lib.localStorage.set("inorder_data",k);var g=b.serviceType,h=b.serveType;h!==c.config.store.FRONT_PAY_SHOP_TYPE?h==c.config.store.PAY_SHOP_TYPE_HIGH?"dianadd"==d.optionType?(c.lib.memCache.set("confirmType",5),c.lib.ddState(f)):l.push("confirm",{title:"菜单已保存",message:"下单前请您确保已到店入座",okButton:"已到店，现在下单",cancelButton:"未到店，待会下单"},function(a){a.ok?c.lib.memCache.set("confirmType",1):c.lib.memCache.set("confirmType",4),c.lib.ddState(f)}):g==c.config.order.service_type_base||g==c.config.order.service_type_advance?l.push("confirm",{title:"菜单已保存",message:"如果您已到店，请扫码下单！",okButton:"已到店，扫码下单",cancelButton:"未到店，待会下单"},function(a){a.ok?c.lib.memCache.set("confirmType",1):c.lib.memCache.set("confirmType",4),c.lib.ddState(f)}):g==c.config.order.service_type_frontpay&&l.push("confirm",{title:"菜单已保存",message:"扫码支付，坐等商家上菜哦！",okButton:"扫码支付",cancelButton:"暂不支付"},function(a){a.ok?c.lib.memCache.set("confirmType",1):c.lib.memCache.set("confirmType",8),c.lib.ddState(f)}):h==c.config.store.FRONT_PAY_SHOP_TYPE&&c.lib.ddState({replace:{ddid:"my"}})},_carteOptions:function(a){var b=this,c=a.data("role"),d=a.parents("li"),e=a.siblings(".J_carte_count"),f=parseInt(d.data("skuid"));b.itemDelIndex=void 0;var g=parseInt(e.text()),h=d.data("id");"plus"==c?(g++,a.siblings().removeClass("dn"),b.abc=h+(f?"_"+f:"")+"__"+g,d&&d.attr("data-inorder",g),b._optionStorage(d,g)):(g--,b.abc=h+(f?"_"+f:"")+"__"+g,0>=g?l.push("confirm",{title:"",message:"您确定要删除"+d.find(".name").text()+"吗？",okButton:"确定",cancelButton:"取消"},function(a){a.ok?(b.cartViewList.splice(d.index(),1),d.remove(),d=void 0,b._scroll.refresh(),b._updateCarteCache(),d&&d.attr("data-inorder",g),b._optionStorage(d,g)):b.async=!1}):(d&&d.attr("data-inorder",g),b._optionStorage(d,g)))},_optionStorage:function(a,b){var d=this;if(a){var e=this.carte_index=a.index(),f=this.cartViewList[e];f.quantity=b}else this.carte_index=void 0;return d.cartViewList.length?void d._requirOptionCart({infos:d._inOrderTotal(),o:0},d._carteUpdate):(c.lib.ddState({back:{ddid:"carte/dian/"+d.id}}),void(d.async=!1))},_inOrderTotal:function(){var b=this,c=b.cartViewList,d=[];return a.each(c,function(a,b){d.push(b.itemId+":"+(parseInt(b.skuId)?b.skuId:"")+":"+b.quantity)}),d},_requirOptionCart:function(a,b){var d=this;c.ui.toast.loading(),lib.mtop.request({api:"mtop.life.diandian.optionCart",v:"1.0",data:{storeId:d.id,o:a.o,info:a.infos.join(";"),bizLine:0,phone:a.phone,num:a.num,note:a.note,t:Date.parse(new Date).toString(),orderOption:c.config.optioncart[d.optionType],orderId:d.orderId,platform:c.mtop_platform}},function(a){c.ui.toast.hide(),a.data&&b&&b.call(d,a.data),d.async=!1,c.ui.toast.hide()},function(a){c.ui.toast(a),d.async=!1})},_carteUpdate:function(b,d){var f=this;if("init"!==d){if(f.carte_index>=0){var g=b.cartViewList[this.carte_index],h=a("#J_carte_check_list li").eq(this.carte_index);h.find(".J_carte_count").text(g.quantity),h.find(".J_total_price").text(parseInt(g.price)/100),h.find(".price").html("&yen;<span>"+parseInt(g.totalPriceLow)/100+"</span>")}var i=c.lib.getUriParam(this.State.url,"_ddid");o.replaceState({page:"carte_check",uri:i,data:b,referer:f.referer,num:f.num},"淘点点","?_ddid="+i+c.config.url_track)}e.text(f._countTotal(b.cartViewList)+"个菜，"+parseInt(b.price)/100+"元"),f._updateCarteCache()},_countTotal:function(b){var c=0;return a.each(b,function(a,b){c+=parseInt(b.quantity)}),c},_updateCarteCache:function(){var a=this,b=a.abc;if(b&&k){var d=b.split("__"),e=k[a.id].carte,f=e[d[0]];f&&(0===parseInt(d[1])?delete e[d[0]]:f.inOrder=parseInt(d[1])),c.lib.localStorage.set("inorder_data",k)}},_iScrollInit:function(){this._scroll=c.ui._scroll({wrap:"#J_carte_check_scroll"})}}}var e,f,g,h,i,j,k,l=b.bridge,m=a("#J_carte_check"),n=a("#J_tpl_carte_check"),o=b.History;c.app.CarteCheck=function(){return new d}}(Zepto,window,window.dd),function(a,b){function c(){return{wrap:g,init:function(a){var b=this;b.id="",b.shopid=a,b.payType="0",b.date_change=!1,b.State=j.getState(),f=dd.lib.localStorage.get("inorder_data")||{},b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){var a=this;if(dd.lib.memCache.get("update_checkdelivery_address")){var b="carte_checkdelivery/"+a.shopid;j.replaceState({default_address:dd.lib.localStorage.get("default_address"),referer:a.State.data.referer,data:a.State.data.data},"淘点点","?_ddid="+b+dd.config.url_track),a.address=dd.lib.localStorage.get("default_address"),f=dd.lib.localStorage.get("inorder_data")||{},a._buildTmpl(),dd.lib.memCache.removeValue("update_checkdelivery_address")}},setAfterPageOut:function(){f=null},setBeforePageOut:function(){document.activeElement.blur()},_renderStatic:function(){var a=dd.ui.tmpl(h.html(),{});g.html(a),d=g.find("#J_carte_checkdelivery_content").html(dd.ui.tpl.load)},_renderDynamic:function(){var a=this;a.address=dd.lib.localStorage.get("default_address"),a.address?a._buildTmpl():a._getDefaultAddress()},_getDefaultAddress:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getDefaultUserAddressById",v:"1.0",data:{},extParam:{}},function(b){if(b.data){{"carte_checkdelivery/"+a.id+"/"+a.shopid}dd.lib.localStorage.set("default_address",b.data.model),a._renderDynamic()}},function(){dd.ui.toast("请选择送餐地址"),a.address={id:0},a._switchAddressHandler()})},_buildTmpl:function(){var b=this;if(!b.State.data.data)return void dd.lib.ddState({back:{ddid:"carte/delivery/"+this.shopid}});b.cartViewList=b.State.data.data.cartViewList,console.log(b.State.data.data);var c=b.State.data;c.addressData=b.address;var d={data:c.data,alt:b.State.data.referer||"carte/delivery/"+b.shopid},f=dd.ui.tmpl(i.html(),d);b.startUp(f),b._buildHeadTpl(),e=a("#J_carte_checkdelivery_count"),b._iScrollInit(),b._getDeliveryDate(),b.State.data.data.voucherVOList.length&&b._showCouponSelect()},_showCouponSelect:function(){var b='<li class="J_coupon_item<%=data.selected ? " selected":""%><%=data.itemStatus=="0"?" disabled":""%>"<%=data.selected ? " selected=true":""%>><i></i><%=data.title%><%=data.itemStatus=="0"?"<span>暂无库存</span>":""%></li>',c=[];a.each(this.State.data.data.voucherVOList,function(a,d){c.push(dd.ui.tmpl(b,{data:d}))}),this._popDialog=dd.ui.dialog({cls:"carte_dialog",title:"我的兑换券",wrap:"#J_carte_checkdelivery",content:'<ul class="pop_my_coupon">'+c.join("")+'</ul><div class="pop_my_coupon_bottom"><span id="J_shop_coupon_confirm" class="btn_bottom_sub">确定</span></div>',maxheight:"246"})},startUp:function(a){d.html(a)},events:[[dd.event.click,".J_switch_address","_switchAddressHandler"],[dd.event.click,".J_paytype","_payTypeHandler"],[dd.event.click,".J_carte_options","_optionsHandler"],[dd.event.click,"#J_carte_checkdelivery_save","_saveHandler"],["change","#J_delivery_select_date","_selectDateHandler"],["focus","#J_delivery_select_time","_selectTimeHandler"],[dd.event.click,"#J_carte_checkdelivery_note","_noteFocusHandler"],["blur","#J_carte_checkdelivery_note","_noteBlurHandler"],["touchmove","#J_carte_checkdelivery_scroll","_scrollTouchHandler"],[dd.event.click,"#J_shop_coupon_btn","_shopCouponBtnHandler"],[dd.event.click,".J_coupon_item","_shopCouponItemHandler"],[dd.event.click,"#J_shop_coupon_confirm","_shopCouponConfirmHandler"]],_scrollTouchHandler:function(){dd.device.isAndroid&&dd.device.nativeScroll&&document.activeElement.blur()},_switchAddressHandler:function(){var a={push:{ddid:"address/"+this.address.id+"/checkdelivery",obj:{referer:"carte_checkdelivery/"+this.shopid}}};dd.lib.ddState(a)},_payTypeHandler:function(b,c){a(c).addClass("current").siblings().removeClass("current"),this.payType=a(c).attr("data-id")},_optionsHandler:function(b,c){this.async||(this.async=!0,this._carteOptions(a(c)))},_saveHandler:function(){var b=this;k.push("confirm",{title:"",message:"请确认送餐时间："+a("#J_delivery_select_date").val()+" "+a("#J_delivery_select_time").val(),okButton:"确定",cancelButton:"取消"},function(c){c.ok&&(b._inOrderTotal(2),a("#J_my_delivery").removeAttr("data-ddid"))})},_selectDateHandler:function(b,c){var d=a(c);this.date_change=!0,this._getDeliveryTime(d.val())},_selectTimeHandler:function(b,c){this.date_change&&(document.activeElement.blur(),a(c).hide())},_noteFocusHandler:function(b,c){a(c)},_noteBlurHandler:function(){},_shopCouponBtnHandler:function(){this._showCouponSelect()},_shopCouponItemHandler:function(b,c){var d=a(c);if(!d.hasClass("disabled")){{var e=this.State.data.data.voucherVOList;e[d.index()]}d.attr("selected")?d.removeAttr("selected").removeClass("selected"):d.attr("selected","true").addClass("selected")}},_shopCouponConfirmHandler:function(){var b=this.State.data.data.voucherVOList;this.wrap.find(".J_coupon_item ").each(function(c,d){var e=a(d),f=b[e.index()];e.attr("selected")?f.selected=!0:delete f.selected}),this._popDialog.hide(),this._buildCoupon()},_buildCoupon:function(){var b='<li data-id="<%=itemId%>"><div class="pic"><div class="img" <%if(picUrlHttp){%>style="background-image:url(<%=picUrlHttp%>_72x72xz.jpg<%=dd.lib.imgSuffix%>)"<%}%>></div></div><div class="items_wrap"><div class="name"><%=itemName%> <span class="shoplist_type_quan">兑</span></div><div class="details"><p class="price">￥<span><%=parseInt(totalPriceLow)/100%></span></p></div></div></li>',c=[];a.each(this.State.data.data.voucherVOList,function(a,d){d.selected&&c.push(dd.ui.tmpl(b,d.relatedItemDO[0]))}),c.length?a("#J_carte_checkdelivery_coupon_item_list").html(c.join("")).show():a("#J_carte_checkdelivery_coupon_item_list").html("").hide()},_buildHeadTpl:function(){var b=this,c=dd.ui.tmpl(a("#J_tpl_carte_checkdelivery_head").html(),{data:b.address||{}});a("#J_carte_checkdelivery_head").html(c)},_getDeliveryDate:function(){var b=this;lib.mtop.request({api:"mtop.life.diandian.deliveryDate",v:"1.0",data:{shopId:b.shopid},extParam:{}},function(c){if(dd.ui.toast.hide(),c.data){var d=[];a.each(c.data.result,function(a,b){d.push('<option value="'+b+'">'+b+"</option>")}),a("#J_delivery_select_date").html(d.join("")),b._getDeliveryTime(a("#J_delivery_select_date").val())}b.async=!1},function(a){dd.ui.toast(a),b.async=!1})},_getDeliveryTime:function(b){var c=this;lib.mtop.request({api:"mtop.life.diandian.deliveryTime",v:"1.0",data:{shopId:c.shopid,date:b,selectIndex:0},extParam:{}},function(b){if(dd.ui.toast.hide(),b.data){var d=[];a.each(b.data.timeSection,function(a,b){d.push('<option value="'+b+'">'+b+"</option>")}),a("#J_delivery_select_time").html(d.join("")).show(),c.date_change=!1}c.async=!1},function(a){dd.ui.toast(a),c.async=!1})},_carteOptions:function(a){var b=this,c=a.data("role"),d=a.parents("li"),e=a.siblings(".J_carte_count"),f=parseInt(d.data("skuid")),g=parseInt(e.text()),h=d.attr("data-id");if("plus"==c){var i=parseInt(d.data("limit")),j=parseInt(d.data("usalamount"));if(i&&g>=i)return dd.ui.toast("限点"+i+"份哦"),void(b.async=!1);if(g>=j)return dd.ui.toast("没有库存啦"),void(b.async=!1);g++,a.siblings().removeClass("dn"),b.abc=h+(f?"_"+f:"")+"__"+g,d&&d.attr("data-inorder",g),b._optionStorage(d,g)}else g--,b.abc=h+(f?"_"+f:"")+"__"+g,0>=g?k.push("confirm",{title:"",message:"您确定要删除"+d.find(".name").text()+"吗？",okButton:"确定",cancelButton:"取消"},function(a){a.ok?(b.cartViewList.splice(d.index(),1),d.remove(),d=void 0,b._updateCarteCache(),d&&d.attr("data-inorder",g),b._optionStorage(d,g)):b.async=!1}):(d&&d.attr("data-inorder",g),b._optionStorage(d,g))},_optionStorage:function(a,b){var c=this;if(a){var d=this.carte_index=a.index(),e=this.cartViewList[d];e.quantity=b}else this.carte_index=void 0;return c.cartViewList.length?void this._inOrderTotal(0):(dd.lib.ddState({back:{ddid:"carte/delivery/"+c.shopid}}),void(c.async=!1))},_inOrderTotal:function(b){var c=this,d=c.cartViewList,e=[];a.each(d,function(a,b){e.push(b.itemId+":"+(parseInt(b.skuId)?b.skuId:"")+":"+b.quantity)}),c._requirOptionCart(b,e)},_getSongItems:function(){var b=[],c=this.State.data.data.freeItemList;return c&&c.length&&a.each(c,function(a,c){b.push(c.itemId+":"+c.skuId+":0")}),b.join(";")},_getVoucherIds:function(){var b=[],c=this.State.data.data.voucherVOList;return c&&c.length&&a.each(c,function(a,c){c.selected&&b.push(c.id)}),b.join(";")},_requirOptionCart:function(b,c){var d=this;dd.ui.toast.loading(),lib.mtop.request({api:"mtop.life.diandian.optionCart",v:"1.0",data:{storeId:d.shopid,o:b,info:c.join(";"),songItems:d._getSongItems(),voucherIds:d._getVoucherIds(),addressId:d.address.id,time:a("#J_delivery_select_date").val()+" "+a("#J_delivery_select_time").val(),payType:parseInt(d.payType),bizLine:1,note:a("#J_carte_checkdelivery_note").val(),platform:dd.mtop_platform},extParam:{}},function(a){dd.ui.toast.hide(),a.data&&(0==b?(d._carteUpdate(a.data),d.async=!1):2==b&&d._orderHandler(a.data))},function(a){dd.ui.toast(a),d.async=!1})},_orderHandler:function(a){var b=this;a.bizOrderId&&(delete f[b.shopid],dd.lib.localStorage.set("inorder_data",f),a.alipayStreamId?b._doPay(a):b._deliveryDetail(a.bizOrderId))},_doPay:function(a){var b=this;k.supportFunc("tradePay")?k.push("tradePay",{tradeNO:a.alipayStreamId},function(){dd.ui.toast.hide(),dd.lib.ddState({replace:{ddid:"my_delivery_details/"+a.bizOrderId}}),b.async=!1}):lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:a.bizOrderId,payType:0}},function(c){if("true"==c.data.canPay){if(dd.device.isAndroid&&dd.device.version.android<4)return void(location.href=c.data.alipayUrl);dd.ui.alipay({title:"支付",alipayUrl:c.data.alipayUrl,successFunc:function(){dd.lib.ddState({replace:{ddid:"my_delivery_details/"+a.bizOrderId}})}})}b.async=!1,dd.ui.toast.hide()},function(){b.async=!1,dd.ui.toast.hide()})},_deliveryDetail:function(b){a("#J_page").children().removeAttr("data-ddid");var c="my_delivery_details/"+b,d={replace:{ddid:c}};dd.lib.ddState(d)},_carteUpdate:function(b){var c=this;if(c.carte_index>=0){var d=b.cartViewList[this.carte_index],f=a("#J_carte_checkdelivery_list li").eq(this.carte_index);f.find(".J_carte_count").text(d.quantity),f.find(".J_total_price").text(parseInt(d.totalPriceLow)/100),f.find(".price").html("&yen;<span>"+parseInt(d.totalPriceLow)/100+"</span>")}var g=parseInt(b.deliveryAmount)?"<i>(含配送费"+parseInt(b.deliveryAmount)/100+"元)</i>":"";e.html(b.itemNum+"个菜，"+parseInt(b.totalPriceLow)/100+"元"+g);var h=dd.lib.getUriParam(this.State.url,"_ddid");j.replaceState({page:"carte_check",uri:h,data:b,referer:c.State.data.referer},"淘点点","?_ddid="+h+dd.config.url_track),c._updateCarteCache()},_updateCarteCache:function(){var a=this,b=a.abc;if(b&&f){var c=b.split("__"),d=c[0],e=new RegExp(d+"$"),g=f[a.shopid].carte;for(var h in g)if(e.test(h)){var i=g[h];0===parseInt(c[1])?delete g[h]:i.inOrder=parseInt(c[1])}dd.lib.localStorage.set("inorder_data",f)}},_iScrollInit:function(){this._scroll=dd.ui._scroll({wrap:"#J_carte_checkdelivery_scroll"})}}}var d,e,f,g=a("#J_carte_checkdelivery"),h=a("#J_tpl_carte_checkdelivery"),i=a("#J_tpl_carte_checkdelivery_content"),j=b.History,k=b.bridge;dd.app.CarteCheckDelivery=function(){return new c}}(Zepto,window,document),function(a,b,c){function d(){return{wrap:i,init:function(a){var b=this;b.storeId=a,b.count={price:0,total:0},b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setBeforePageOut:function(){e=null,f=null,g=null,h=null,o={x:void 0,wrap:void 0,el:void 0,el_half_w:void 0,width:void 0,mg:void 0,min:void 0,max:void 0,unit:void 0,num:4}},setAfterPageIn:function(){var b=this;a("#J_carte").removeAttr("data-ddid");var d=n.getState();if(d.data&&d.data.carteData){b._buildTmpl(d.data.carteData),b._setSlidePointer(o.num),a("#J_carte_intelligent_p_num").text(o.num);var e="carte_intelligent/"+b.storeId;n.replaceState({page:"carte_intelligent",uri:e},"淘点点","?_ddid="+e+c.config.url_track)}this._slideInit()},_renderStatic:function(){var a=this,b={alt:n.getState().data.referer||"carte/dian/"+a.storeId},d=c.ui.tmpl(j.html(),b);i.html(d),e=i.find("#J_carte_intelligent_scroll")},_renderDynamic:function(){var a=this;a._getLazyMenu()},_getLazyMenu:function(){var a=this,b=n.getState();g&&g.hide(),b.data&&b.data.carteData||a.async||(a.async=!0,e.html(c.ui.tpl.load),lib.mtop.request({api:"mtop.life.diandian.lazyMenu",v:"2.0",data:{hc:o.num,storeId:a.storeId,pz:1,pn:0},extParam:{}},function(b){var c=b.data;c.resultCnt?a._buildTmpl(c.menuList[0]):a._buildNone(),a.async=!1},function(b){c.ui.toast(b,a),a.async=!1}))},_buildTmpl:function(b){var d=this;e.html(k.html()),f=a("#J_carte_intelligent_list"),g=a("#J_carte_intelligent_bottom_tip"),h=g.find(".J_order_count"),console.log(b);var i=c.ui.tmpl(l.html(),b);d.startUp(i),a("#J_carte_intelligent_save").removeClass("disabled"),b.totalPrice.toString().indexOf(".")>0&&(b.totalPrice=parseFloat(b.totalPrice).toFixed(2)),g.show(),d._inOrderTotal(),d._iScrollInit()},startUp:function(a){f.html(a)},events:[[c.event.click,"#J_carte_intelligent_carteadd","_carteaddHandler"],[c.event.click,"#J_carte_intelligent_list li","_liHandler"],[c.event.click,"#J_carte_intelligent_refresh","_refreshHandler"],[c.event.click,".J_carte_options","_optionsHandler"],[c.event.click,".J_lazy_up","_lazyUpHandler"],[c.event.click,"#J_carte_intelligent_save","_saveHandler"],["touchstart","#J_intelligent_slide_wrap","_touchstartHandler"],["touchmove","#J_intelligent_slide_wrap","_touchmoveHandler"],["touchend","#J_intelligent_slide_wrap","_touchendHandler"]],_carteaddHandler:function(){var b=this,d={},e=0;f.children("li").each(function(){var b=a(this),c=b.data("skuid");b.attr("data-id")&&(d["itg_"+b.attr("data-id")+(c?"_"+c:"")]={inOrder:b.attr("data-count"),name:b.find(".name").text(),price:b.data("price")},e++)}),d.total=e;var g="carte/itg/"+b.storeId;a("#J_carte").removeAttr("data-ddid");var h={push:{ddid:g,obj:{intelligent2carte:d,referer:"carte_intelligent/"+b.storeId}}};c.lib.ddState(h)},_liHandler:function(b,c){if(b.preventDefault(),"A"!==b.target.tagName&&a(c).attr("data-id")){if(a(b.target).hasClass("J_carte_options"))return;a(c).toggleClass("tfin")}},_refreshHandler:function(){this._getLazyMenu()},_optionsHandler:function(b,c){b.preventDefault(),this._carteOptions(a(c))},_lazyUpHandler:function(b,c){b.preventDefault(),this._upLazyOptions(a(c).parents("li"))},_saveHandler:function(b,c){var d=this;a(c).hasClass("disabled")||m.push("login",function(){d._orderSave()})},_touchstartHandler:function(){o.el[0].style.webkitTransition="0ms"},_touchmoveHandler:function(a){var b=this;a.preventDefault(),setTimeout(function(){o.x=a.touches[0].pageX-o.mg,o.x<0||o.x>o.max-o.mg||(o.el[0].style.webkitTransform="translateX("+o.x+"px)",b._setSlideDynamicDoc(b._getSlideIndex(o.x)))},0)},_touchendHandler:function(){var b=this._getSlideIndex(o.x);b&&(o.num=b,a("#J_carte_intelligent_p_num").text(b),this._getLazyMenu())},_buildNone:function(){e.html(c.ui.tmpl(c.ui.tpl.none,{msg:"没有菜单哦"})),a("#J_carte_intelligent_save").addClass("disabled"),a("#J_carte_intelligent_bottom_tip").hide()},_slideInit:function(){var c=this;o.wrap=a("#J_intelligent_slide_wrap"),o.el=a("#J_intelligent_slide_pointer");var d=b.document.body.clientWidth;width=o.width=o.wrap.find(".slide_line").width(),o.mg=(d-o.width)/2,o.min=o.mg,o.max=d-o.mg,o.el.show(),o.el_half_w=o.el.width()/2,o.unit=o.width/20,c._setSlidePointer(o.num)},_getSlideIndex:function(a){return 0>=a&&(a=1),a>o.width&&(a=o.width),Math.ceil(a/o.unit)},_setSlidePointer:function(a){var b=this,c=(a-1)*o.unit+o.unit/2+o.mg-o.el_half_w;o.el[0].style.webkitTransition="100ms",o.el[0].style.webkitTransform="translateX("+c+"px)",b._setSlideDynamicDoc(a)},_setSlideDynamicDoc:function(a){o.el.find("i").attr("class","n"+a)},_carteOptions:function(a){var b=this,c=a.data("role"),d=a.parents("li"),e=a.siblings(".J_carte_count"),f=d.find(".J_num"),g=!1,h=parseInt(e.text());if("plus"==c)h++,a.siblings().removeClass("dn");else if(h--,0>=h)return confirm("确定要删除"+d.find(".name").text()+"吗？")?(g=!0,b._inOrderTotal(d),void b._scroll.refresh()):void 0;e.text(h),d.attr("data-count",h),f.text(h),b._inOrderTotal()},_inOrderTotal:function(b){var c=this;b&&b.remove();var d=0,e=0;f.children("li").each(function(){var b=a(this),c=parseInt(b.attr("data-count"));d+=parseFloat(b.attr("data-price"))*c,e+=c}),String(d).indexOf(".")>0&&(d=d.toFixed(2)),c.count.price=d,c.count.total=e,h.html("总计&yen;"+c.count.price+"/"+c.count.total+"个菜")},_getInfos:function(){var b=[];return f.children("li").each(function(){var c=a(this);c.attr("data-id")&&b.push(c.attr("data-id")+":"+c.attr("data-skuid")+":"+c.attr("data-count"))}),b},_upLazyOptions:function(a){var b=this;b.async||(b.async=!0,lib.mtop.request({api:"mtop.life.diandian.upLazyMenu",v:"2.0",data:{storeId:b.storeId,l:a.attr("data-id"),h:b._getItemIds().join(",")},extParam:{}},function(c){c.data&&b._menuReplace(a,c.data),b.async=!1},function(a){c.ui.toast(a),b.async=!1}))},_menuReplace:function(a,b){var d=this,e=(a.index(),c.ui.tmpl(l.html(),b));a.replaceWith(e),d._inOrderTotal(),d._scroll.refresh()},_orderSave:function(){var b=this;b.async||(b.async=!0,lib.mtop.request({api:"mtop.life.diandian.optionCart",v:"1.0",data:{storeId:b.storeId,o:0,info:b._getInfos().join(";"),bizLine:0,num:o.num,platform:c.mtop_platform},extParam:{}},function(d){if(d.data){var e="carte_check/"+b.storeId;a("#J_carte_check").attr("data-ddid","");var f={push:{ddid:e,obj:{data:d.data,referer:"carte_intelligent/"+b.storeId,num:o.num}}};c.lib.ddState(f)}b.async=!1},function(a){c.ui.toast(a),b.async=!1}))},_iScrollInit:function(){this._scroll=c.ui._scroll({wrap:"#J_carte_intelligent_scroll"})},_pullDownAction:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.autoGetOneItem",v:"2.0",data:{storeId:a.storeId,itemId:a._getItemIds()[0],itemIds:a._getItemIds().join(",")},extParam:{}},function(b){var c=b.data;c&&a._menuAdd(c)},function(a){c.ui.toast(a)})},_getItemIds:function(){var b=[];return f.children("li").each(function(){var c=a(this);c.attr("data-id")&&b.push(c.attr("data-id"))}),b},_menuAdd:function(a){var b=this,d={items:a.result.menu},e=c.ui.tmpl(l.html(),d);f.prepend(e),b._scroll.refresh(),b._inOrderTotal()}}}var e,f,g,h,i=a("#J_carte_intelligent"),j=a("#J_tpl_carte_intelligent"),k=a("#J_tpl_carte_intelligent_content"),l=a("#J_tpl_carte_intelligent_list"),m=b.bridge,n=b.History,o={x:void 0,wrap:void 0,el:void 0,el_half_w:void 0,width:void 0,mg:void 0,min:void 0,max:void 0,unit:void 0,num:4};c.app.CarteIntelligent=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{orders:{},wrap:f,init:function(){var a=this;a.ttid=c.lib.getUriParam(History.getState().url,"_ddid"),a.initHandler()},setAfterPageOut:function(){check_data={}},initHandler:function(){var a=this;a._renderStatic(),a._renderDynamic()},_renderDynamic:function(){var a=this;i.push("login",function(){a.getListData()})},_renderStatic:function(){this.wrap.html(g.html()),this.pullup_el=f.find(".J_pullUp"),i.supportFunc("setOptionMenu")&&i.push("setOptionMenu",{icon:"http://g.dd.alicdn.com/tps/i1/T1nyYUFlJfXXcm2uvj-56-56.png"})},menuEvent:"_scan",events:[[c.event.click,".J_Check","_check"],[c.event.click,"#J_ScanBtn","_scan"],[c.event.click,"#J_Ticket","_goTicket"],[c.event.click,".J_pop_store_item","_storeHandler"]],_goTicket:function(){var a=this,b="http://h5.m.taobao.com/dd/card/index.html";a.ttid&&(b+="?ttid="+a.ttid),i.push("pushWindow",{url:b})},getListData:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.buyerCheckOutList",v:"1.0"},function(b){var c=b.data;c.list&&c.list.length>0&&a._buildList(c)},function(b){c.ui.toast(b,a)})},_buildList:function(b){var d=this,e=a("#J_CheckList");a.each(b.list,function(a,b){d.orders[a]=b});var f=c.ui.tmpl(h.html(),b);e.removeClass("nothing").html(f)},_check:function(b){var c=this,d=a(b.target),e=d.attr("data-index"),f=c.orders[e];switch(f.type){case"0":c._pushPay(f.storeId,{reserve:1,orderId:f.reserveId,shopname:f.shopName});break;case"1":c.userCoupon(f.evoucherId);break;case"2":c._pushPay(f.storeId,{reserve:0,orderId:f.menuId,shopname:f.shopName})}},_storeHandler:function(b,c){e.hide(),e={},this._pushPay(a(c).data("storeid"))},_pushPay:function(a,b){b&&c.lib.memCache.set("pay_detail",b),c.lib.ddState({push:{ddid:"pay_detail/"+a,obj:{referer:"check"}}})},userCoupon:function(a){var b=this;b.geo_location=c.lib.memCache.get("geo_location")||{},lib.mtop.request({api:"mtop.dd.voucher.user.detail",v:"1.0",data:{voucherId:a,latitude:b.geo_location.latitude,longitude:b.geo_location.longitude}},function(a){var d=a.data;if(d.localstores.length>1){var f=c.common.useEvoucher.evoucherUse(d.localstores,b.geo_location);e=c.ui.dialog({cls:"evoucherpop",title:"确定您所在的门店",wrap:"#J_check",content:'<ul class="pop_shop_list">'+f+"</ul>",maxheight:"300"})}else b._pushPay(d.localstores[0].localstoreId)},function(a){c.ui.toast(a,b)})},_scan:function(){var a=this;i.push("scan",{type:"qr"},function(){var b=arguments[0].qrCode;lib.mtop.request({api:"mtop.life.diandian.simpleScanCode",v:"1.0",data:{codeUrl:b,from:3}},function(d){d.data.needLogin>0?lib.mtop.request({api:"mtop.life.diandian.ecodeScanCode",v:"1.0",data:{codeUrl:b,from:3,ddOrderId:0}},function(b){a.scanRoute(b.data)},function(a){c.ui.toast(a)}):a.scanRoute(d.data)},function(a){c.ui.toast(a)})})},scanRoute:function(a){var b=a.type;if("pay"==b){if("-3000"==a.data.code)return void i.push("alert",{title:"提示",message:a.data.message,buttons:["确定"]});var d=a.data.orderRespDTO;c.lib.memCache.set("pay_detail",d),c.lib.ddState({push:{ddid:"pay_detail/"+d.localstoreId,obj:{referer:"check"}}})}}}}var e,f=a("#J_check"),g=a("#J_tpl_check"),h=a("#J_tpl_check_list"),i=(a("#J_tpl_check_pop"),b.bridge);check_data={},c.app.Check=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:k,init:function(a){var b=this;b.storeId=a,b.pay_detail=c.lib.memCache.get("pay_detail"),b.reserve=b.pay_detail?b.pay_detail.reserve:1,b.orderId=b.pay_detail?b.pay_detail.orderId:"",b.taobaoOrderNo=b.pay_detail?b.pay_detail.taobaoOrderNo:null,b.initHandler()},initHandler:function(){this._renderDynamic()},setAfterPageOut:function(){c.lib.memCache.removeValue("pay_detail"),f=0,g=!1,h=null,i={0:{},1:{}}},setBeforePageOut:function(){this._rollback(),document.activeElement.blur()},_renderDynamic:function(){var a=this;this.wrap.html(c.ui.tpl.load),a.pay_detail?a._renderTpl(a.pay_detail):a.getStoreInfo()},_renderTpl:function(b){var d=this,e=!0;if(tpl=c.ui.tmpl(l.html(),{storeName:b.storeName||b.localstoreName||b.shopname,address:b.address}),this.wrap.html(tpl),c._hideTitleBar)try{d.wrap.find(".hd_title").find("h2")&&j.push("setTitle",{title:d.wrap.find(".hd_title").find("h2").html()})}catch(f){console.log(f)}if(d.taobaoOrderNo){var g=a("#J_Money");g.val(parseInt(d.pay_detail.price)/100).attr("readonly","true"),e=!1}d._getCoupons(g,e),/Android/.test(navigator.userAgent)&&d._placeHolder()},getStoreInfo:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getDetailInfo",v:"1.0",data:{localstore_id:a.storeId}},function(b){a._renderTpl(b.data)},function(b){c.ui.toast(b,a)})},events:[[c.event.click,"#J_pay_detail_back","_rollback"],["blur","#J_Money","_showMore"],["focus","#J_Money","hideBottom"],[c.event.click,".J_Item","_checkCoupon"],[c.event.click,"#J_PayBtn","_payOrder"]],_placeHolder:function(){var b=a("#J_Money"),c=b.parent(".money"),d=b.attr("placeholder");b.removeAttr("placeholder"),c.append('<label for="J_Money" class="fake_holder">'+d+"</label>"),""!==a.trim(b.val())&&c.addClass("focus"),b.on("focus blur",function(b){var d=a(b.currentTarget);"blur"==b.type?""!==a.trim(d.val())?c.addClass("focus"):c.removeClass("focus"):c.addClass("focus")})},_rollback:function(){var a=this;a.roll_back=!0,setTimeout(function(){a.roll_back=!1},250)},hideBottom:function(b,c){"true"!=a(c).attr("readonly")&&a("#J_Pay_Bottom").hide()},_showMore:function(b,d){var e=this;setTimeout(function(){if(!e.roll_back){if(d.value<=0||""==a.trim(d.value))return d.value="",void c.ui.toast("请输入大于零的金额");total_coupon=0,g=!1,h=null,i={0:{},1:{}},e._getCoupons(d)}},100)},_getCoupons:function(b,d){var e,f=this;e=d&&!f.taobaoOrderNo?{api:"mtop.dd.voucher.user.list.localstore",v:"1.0",data:{localstoreId:f.storeId,status:1}}:f.taobaoOrderNo?{api:"mtop.dd.order.scanInfo",v:"1.0",data:{orderNo:f.taobaoOrderNo,isDetail:2}}:f.orderId?{api:"mtop.life.diandian.createPayOrder",v:"1.0",data:{flag:f.reserve||0,extraId:f.orderId,price:b.value,quanVer:2}}:{api:"mtop.dd.order.scanAndCreateWithPrice",v:"1.0",data:{orderInfo:"http://tc.taobao.com/q/y4/e1/l"+f.storeId,isDetail:2,price:b.value}},lib.mtop.request(e,function(b){var e=b.data,g=e.userVoucherRespDTOs||e.list;if(f.payOrderData=e,g){var h=c.ui.tmpl(m.html(),f.processData(g,d));a("#J_Coupons").html(h)}else a("#J_Nothing").show();
d||(a("#J_NeedPay").show(),a("#J_Pay_Bottom").show(),f.calculate())},function(a){c.ui.toast(a,f)})},processData:function(b,c){var d=this,f=[],g=[];return a.each(b,function(a,b){b.remainDays=d.dateDiff(b.systemNowTime,b.expiredTime),b.couponType=e[b.itemType],b.couponValue=parseInt(b.par)/100,b.bookseat="bookSeat"==b.itemType,"true"==b.useRule.exclusive?g.push(b):f.push(b)}),{list:f,ex_list:g,first:c}},dateDiff:function(a,b){a=a.replace(/\-/g,"/"),b=b.replace(/\-/g,"/");var c=new Date(a),d=new Date(b);return parseInt((d.getTime()-c.getTime())/parseInt(864e5))},_checkCoupon:function(b){var c=this,d=a(b.currentTarget);if(!d.hasClass("disable")){var e,f=d.find("b"),g=d.attr("data-limit"),j=d.attr("data-single")?"1":"0",k=g?g:"0";void 0==i[j][k]&&(i[j][k]=0),e=i[j][k],"1"==j?(i[0]={},0==e?(f.hasClass("checked")||a("#J_Coupons").find("b").removeClass("checked"),h&&h!==k&&(i[j][h]=0),h=k,c.calculate(f,g,j,k)):e>0&&c.calculate(f,g,j,k)):(a("#J_Single_Coupons").find("b").removeClass("checked"),i[1]={},c.calculate(f,g,j,k))}},calculate:function(b,d,e,g){if(b)if(a(b).toggleClass("checked"),a(b).hasClass("checked")){if(d&&(i[e][g]++,i[e][g]>parseInt(d)))return a(b).removeClass("checked"),c.ui.toast("该现金券限制一次使用"+d+"张"),void i[e][g]--}else d&&i[e][g]--;var h=0;a.each(a("#J_Coupons").find("b.checked"),function(b,c){h+=parseFloat(a(c).attr("data-value"))});var j=a("#J_Money").val()-h;j=0>j?0:j,f=j,a(".J_NeedPay").html("￥"+j.toFixed(2))},_payOrder:function(){var b=this,c=a("#J_Money").val();noUseCoupon=f==c,j.push("confirm",{title:"提示",message:"请确认您已经到店内再买单哦",okButton:"确认买单",cancelButton:"取消"},function(a){a.ok&&(b.payOrderData.evoucherDtos?noUseCoupon&&b.payOrderData.evoucherDtos.length>0?j.push("confirm",{title:"提示",message:"您有可使用的现金券，是否使用？",okButton:"是",cancelButton:"否"},function(a){a.ok||b.startPay()}):!noUseCoupon&&total_coupon>c?j.push("confirm",{title:"提示",message:"使用的现金券金额大于订单金额, 多出的余额不退，确定继续付款？",okButton:"确认",cancelButton:"取消"},function(a){a.ok&&b.startPay()}):b.startPay():b.startPay())})},startPay:function(){var b=this;if(c.ui.toast.loading(),!g){var d=[];checked_coupons=a("#J_Coupons").find("b.checked"),a.each(checked_coupons,function(a,b){d.push(b.id)})}lib.mtop.request({api:"mtop.dd.order.pay",v:"1.0",data:{orderNo:b.payOrderData.taobaoOrderNo,voucher:d.join(",")}},function(a){var d=a.data;return"1"==d.payStatus?(c.ui.toast.hide(),void c.lib.ddState({replace:{ddid:"pay_result/"+d.taobaoOrderNo,obj:{referer:"my"}}})):void b.toAliPay(d)},function(a){c.ui.toast(a,b)})},toAliPay:function(a){function b(){c.lib.ddState({replace:{ddid:"pay_result/"+d.payOrderData.taobaoOrderNo,obj:{referer:"my"}}})}var d=this;if(j.supportFunc("tradePay"))j.push("tradePay",{tradeNO:a.alipayTradeIds},function(a){c.ui.toast.hide(),a.resultCode&&9e3==parseInt(a.resultCode)&&b()});else{var e=1,f=["预订支付","确定买单"],g=f[e]||"";lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:a.taobaoOrderId,payType:0}},function(a){a.data&&"true"==a.data.canPay&&c.ui.alipay({title:g,alipayUrl:a.data.alipayUrl,successFunc:function(){b()}}),c.ui.toast.hide(),d.async=!1},function(a){c.ui.toast(a),d.async=!1})}}}}var e={coupon:"现金券",bookSeat:"订座定金"},f=0,g=!1,h=null,i={0:{},1:{}},j=b.bridge,k=a("#J_pay_detail"),l=a("#J_tpl_pay_detail"),m=a("#J_tpl_pay_detail_coupon");c.app.PayDetail=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a){var b=this,c=History.getState().data;b.orderNo=a,c&&c.data&&(b.shop=c.data.branchOffice[0]),b.initHandler()},initHandler:function(){this._renderDynamic()},_renderDynamic:function(){var b=this;lib.mtop.request({api:"mtop.dd.order.finish",v:"1.0",data:{orderNo:b.orderNo,withDraw:!0}},function(d){var e=d.data;b.data=e,b.orderInfo=e.order,e.shop=b.shop,e.nickname=b.getNickName(),tpl=c.ui.tmpl(f.html(),e),b.wrap.html(tpl),g.supportFunc("share")||a("#J_PayShareBtn").hide()},function(a){c.ui.toast(a,b)})},events:[[c.event.click,".J_RateBtn","_goRate"],[c.event.click,".J_UseEvoucher","_useEvoucher"],[c.event.click,"#J_PayShareBtn","_goShare"],[c.event.click,"#J_go_my_quan","_myQuanHandler"]],_myQuanHandler:function(){a("#J_my_evoucher").removeAttr("data-ddid"),c.lib.ddState({replace:{ddid:"my_evoucher"}})},getNickName:function(){var a;a=c.lib.localStorage.get("nick_name");var b=function(a){return a=a.replace(/\\/g,"%"),unescape(a)};return a||(a=b(lib.storage.cookie.getCookie("tracknick"))),a},_goRate:function(){var a=this;a.data.order.shop=a.data.order.title,c.lib.ddState({push:{ddid:"review/"+a.orderNo,obj:{referer:"pay_result",orderData:a.data.order}}})},_goShare:function(){var a=this;g.push("share",{title:a.orderInfo.title,content:"可以用淘点点买单，超级方便，推荐你也试试",url:"http://h5.m.taobao.com/dd/jump.htm?_jump="+a.orderInfo.localstoreId,image:"http://g.dd.alicdn.com/tps/i4/T1kHywFuhdXXbYfSkc-640-1738.png"})}}}var e=a("#J_pay_result"),f=a("#J_tpl_pay_result"),g=b.bridge;c.app.PayResult=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:f,init:function(a){var b=this;b.role=a,b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageOut:function(){setTimeout(function(){c.lib.memCache.removeValue("update_city")},0)},_renderStatic:function(){var a=this;a.alt=History.getState().data.referer||"index";var b={alt:a.alt},d=c.ui.tmpl(g.html(),b);f.html(d),e=f.find("#J_city_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;c.lib.memCache.get("city_list")?a.startUp({cityList:c.lib.memCache.get("city_list"),location:c.lib.memCache.get("geo_location")}):a._geo()},_geo:function(){var a=this;c.lib.getH5Geo({callback:function(b,d){return c.lib.memCache.get("city_list")?void a.startUp({cityList:c.lib.memCache.get("city_list"),location:c.lib.memCache.get("geo_location")}):void c.ui.toast(d,a)}})},startUp:function(a){var b=this,d=c.ui.tmpl(h.html(),a);e.html(d),b._iScrollInit()},events:[[c.event.click,".J_city_item","_itemHandler"],[c.event.click,"#J_city_retry","_retryHandler"],[c.event.click,"#J_index_search","_searchHandler"]],_itemHandler:function(b,d){var e=this,f=(a(d).index(),a(d).data("data")||e.geoPos);f&&(c.lib.localStorage.set("current_city",f),c.lib.memCache.set("update_city",!0)),c.lib.ddState({back:{ddid:e.alt}})},_retryHandler:function(b){var d=this,e=a(b.target);d.geoPos=void 0,c.ui.toast.loading(),c.lib.getH5Geo({callback:function(a,b){var f=b.data;c.ui.toast.hide(),a&&f.location&&(e.replaceWith('<li class="J_city_item" data-lat="'+a.latitude+'" data-long="'+a.longitude+'" data-id="'+f.location.cityId+'">'+f.location.cityName+"</li>"),d.geoPos={cityId:f.location.cityId,cityName:f.location.cityName,longitude:a.longitude,latitude:a.latitude})}})},_iScrollInit:function(){},_pullDownAction:function(){this._geo()}}}var e,f=(b.bridge,a("#J_city")),g=a("#J_tpl_city"),h=a("#J_tpl_city_content");c.app.City=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a){var b=this;b.role=a,b.initHandler()},initHandler:function(){this._renderStatic()},setAfterPageOut:function(){c.lib.memCache.removeValue("update_city")},_renderStatic:function(){var a=this;a._buildList()},_buildList:function(){var a=this;a.alt=History.getState().data.referer||"index";var b={listObj:g,alt:a.alt},d=c.ui.tmpl(f.html(),b);a.startUp(d)},startUp:function(a){e.html(a)},events:[[c.event.click,".J_city_item","_itemHandler"]],_itemHandler:function(b,d){var e=a(d).attr("data-data").split(";");e[0]!=History.getState().data.referer_citycode&&(c.lib.memCache.set("address_operate_city",a(d).attr("data-data").split(";")),c.lib.memCache.set("update_city",!0));var f={back:{ddid:this.alt}};c.lib.ddState(f)}}}var e=(b.bridge,a("#J_city_all")),f=a("#J_tpl_city_all"),g={"1hot":[[110100,"北京",116.41210174560547,39.90364074707031],[310100,"上海",121.4745101928711,31.230649948120117],[440100,"广州",113.26525115966797,23.128700256347656],[440300,"深圳",114.05780029296875,22.54290008544922],[330100,"杭州",120.15509033203125,30.27298927307129],[430100,"长沙",112.93878173828125,28.227720260620117],[510100,"成都",104.0647201538086,30.65867042541504],[500100,"重庆",106.5521469116211,29.562820434570312],[210200,"大连",121.61470794677734,38.913631439208984],[440600,"佛山",113.1217269897461,23.024370193481445],[350100,"福州",119.29650115966797,26.073970794677734],[230100,"哈尔滨",126.53511810302734,45.80329895019531],[340100,"合肥",117.22775268554688,31.820430755615234],[370100,"济南",116.99520111083984,36.66537857055664],[330400,"嘉兴",120.74832153320312,30.745149612426758],[330700,"金华",119.64749145507812,29.0781192779541],[360100,"南昌",115.85845184326172,28.6830997467041],[320100,"南京",118.79637908935547,32.05830001831055],[330200,"宁波",121.54974365234375,29.874040603637695],[370200,"青岛",120.38289642333984,36.066158294677734],[460200,"三亚",109.51116180419922,18.252399444580078],[330600,"绍兴",120.57785034179688,30.004470825195312],[210100,"沈阳",123.43182373046875,41.80622863769531],[320500,"苏州",120.58541107177734,31.29878044128418],[120100,"天津",117.21446990966797,39.12080001831055],[320200,"无锡",120.30281829833984,31.56591033935547],[420100,"武汉",114.30522918701172,30.592769622802734],[610100,"西安",108.94412231445312,34.264801025390625],[350200,"厦门",118.0893783569336,24.479530334472656],[321e3,"扬州",119.41354370117188,32.39379119873047]],A:[[210300,"鞍山",122.99420166015625,41.10858154296875],[410500,"安阳",114.39305877685547,36.09767150878906],[340800,"安庆",117.0571517944336,30.52482032775879],[520400,"安顺",105.947509765625,26.2529296875],[513200,"阿坝",102.22528076171875,31.90007972717285],[652900,"阿克苏",80.26026916503906,41.16864013671875],[659002,"阿拉尔",81.2806396484375,40.547969818115234],[152900,"阿拉善盟",105.72894287109375,38.85150146484375],[654300,"阿勒泰",88.13829803466797,47.849849700927734],[542500,"阿里地区",81.1456298828125,30.400529861450195],[610900,"安康",109.02745819091797,32.68914031982422]],B:[[110100,"北京",116.41210174560547,39.90364074707031],[130600,"保定",115.4645004272461,38.8739013671875],[610300,"宝鸡",107.23729705810547,34.36193084716797],[150200,"包头",109.84111785888672,40.65727996826172],[210500,"本溪",123.76766967773438,41.294281005859375],[450500,"北海",109.11990356445312,21.481220245361328],[340300,"蚌埠",117.3884506225586,32.91548156738281],[220800,"白城",122.838623046875,45.61954116821289],[652800,"巴音郭楞",86.14511108398438,41.76401138305664],[469025,"白沙",109.4537582397461,19.224079132080078],[220600,"白山",126.4237289428711,41.940120697021484],[620400,"白银",104.13768768310547,36.54467010498047],[451e3,"百色",106.61775970458984,23.90329933166504],[469029,"保亭",{},{}],[530500,"保山",99.16179656982422,25.11203956604004],[522400,"毕节地区",105.28411102294922,27.302650451660156],[371600,"滨州",117.9822006225586,37.376888275146484],[341600,"亳州",115.78057098388672,33.852291107177734],[150800,"巴彦淖尔",107.38829803466797,40.74287033081055],[511900,"巴中",106.74478149414062,31.865110397338867]],C:[[500100,"重庆",106.5521469116211,29.562820434570312],[510100,"成都",104.0647201538086,30.65867042541504],[430100,"长沙",112.93878173828125,28.227720260620117],[220100,"长春",125.3235092163086,43.81612014770508],[320400,"常州",119.97396087646484,31.80994987487793],[130800,"承德",117.94400024414062,40.97806167602539],[130900,"沧州",116.838623046875,38.30498123168945],[341100,"滁州",118.31688690185547,32.30181121826172],[1341700,"池州",{},{}],[150400,"赤峰",118.88912963867188,42.25831985473633],[542100,"昌都地区",97.17769622802734,31.141010284423828],[652300,"昌吉州",87.30815887451172,44.011138916015625],[140400,"长治",113.11795043945312,36.195560455322266],[430700,"常德",111.6985092163086,29.03158950805664],[341400,"巢湖",117.88571166992188,31.619159698486328],[211300,"朝阳",120.44992065429688,41.57365036010742],[445100,"潮州",116.62288665771484,23.65665054321289],[431e3,"郴州",113.0145492553711,25.770540237426758],[451400,"崇左",107.36638641357422,22.37652015686035],[532300,"楚雄",101.52803802490234,25.04538917541504]],D:[[210200,"大连",121.61470794677734,38.913631439208984],[441900,"东莞",113.75151824951172,23.019929885864258],[140200,"大同",113.3000717163086,40.07632827758789],[370500,"东营",118.67462158203125,37.43360900878906],[532900,"大理",100.26757049560547,25.606420516967773],[230600,"大庆",125.10324096679688,46.58930969238281],[210600,"丹东",124.384521484375,40.12916946411133],[533100,"德宏",98.58480072021484,24.432289123535156],[510600,"德阳",104.39755249023438,31.126680374145508],[371400,"德州",116.30269622802734,37.4511604309082],[511700,"达州",107.47225952148438,31.21441078186035],[232700,"大兴安岭",124.30953979492188,51.981441497802734],[533400,"迪庆",99.70297241210938,27.819150924682617],[621100,"定西",104.62619018554688,35.58047866821289]],E:[[150600,"鄂尔多斯",110.02169036865234,39.818031311035156],[420700,"鄂州",114.8927001953125,30.39423942565918],[422800,"恩施",109.48812103271484,30.27212905883789]],F:[[350100,"福州",119.29650115966797,26.073970794677734],[440600,"佛山",113.1217269897461,23.024370193481445],[210400,"抚顺",123.9542465209961,41.878658294677734],[361e3,"抚州",116.35283660888672,27.94499969482422],[210900,"阜新",121.66963958740234,42.02191162109375],[341200,"阜阳",115.8139877319336,32.88970184326172],[450600,"防城港",108.35399627685547,21.687089920043945]],G:[[440100,"广州",113.26525115966797,23.128700256347656],[450300,"桂林",110.29000091552734,25.273330688476562],[520100,"贵阳",106.63011932373047,26.647249221801758],[360700,"赣州",114.93331146240234,25.829099655151367],[623e3,"甘南",102.91197967529297,34.98358154296875],[513300,"甘孜",101.9630126953125,30.050800323486328],[640400,"固原",106.2425537109375,36.01578140258789],[511600,"广安",106.63311004638672,30.455890655517578],[510800,"广元",105.84358978271484,32.43511962890625],[450800,"贵港",109.59677124023438,23.10671043395996],[632600,"果洛",100.24484252929688,34.471439361572266]],H:[[330100,"杭州",120.15509033203125,30.27298927307129],[340100,"合肥",117.22775268554688,31.820430755615234],[230100,"哈尔滨",126.53511810302734,45.80329895019531],[460100,"海口",110.3359603881836,20.031349182128906],[150100,"呼和浩特",111.7499008178711,40.84267044067383],[130400,"邯郸",114.49340057373047,36.61172866821289],[330500,"湖州",120.08688354492188,30.893770217895508],[341e3,"黄山",118.33882904052734,29.715410232543945],[441300,"惠州",114.41680145263672,23.111160278320312],[320800,"淮安",119.0155029296875,33.61022186279297],[211400,"葫芦岛",120.83592987060547,40.70981979370117],[421100,"黄冈",114.87529754638672,30.454519271850586],[420200,"黄石",115.03790283203125,30.19927978515625],[231100,"黑河",127.51904296875,50.24803924560547],[430400,"衡阳",112.57186126708984,26.89318084716797],[441600,"河源",114.70062255859375,23.743589401245117],[340400,"淮南",117.0029296875,32.62474822998047],[451100,"贺州",111.5675277709961,24.402280807495117],[340600,"淮北",116.79827117919922,33.95473861694336],[610700,"汉中",107.02342987060547,33.06753921508789],[150700,"呼伦贝尔",119.76608276367188,49.21223831176758],[371700,"菏泽",115.4798812866211,35.2353401184082],[431200,"怀化",109.99826049804688,27.555519104003906],[131100,"衡水",115.69686126708984,37.73678970336914],[632800,"海西",97.16259002685547,37.38842010498047],[652200,"哈密地区",93.51561737060547,42.81884002685547],[451200,"河池",108.0859603881836,24.692869186401367],[632200,"海北",100.9009017944336,36.954498291015625],[632100,"海东地区",102.11044311523438,36.506988525390625],[632500,"海南州",100.62042236328125,36.286380767822266],[653200,"和田地区",79.93112182617188,37.11376953125],[410600,"鹤壁",114.18417358398438,35.900489807128906],[230400,"鹤岗",130.29815673828125,47.34986877441406],[532500,"红河",103.37554168701172,23.36417007446289],[632300,"黄南",102.10408782958984,35.5217399597168]],J:[[370100,"济南",116.99520111083984,36.66537857055664],[330400,"嘉兴",120.74832153320312,30.745149612426758],[330700,"金华",119.64749145507812,29.0781192779541],[440700,"江门",113.08177947998047,22.57879066467285],[370800,"济宁",116.58737182617188,35.41448974609375],[421e3,"荆州",112.23953247070312,30.334510803222656],[220200,"吉林",126.54940032958984,43.83771896362305],[360400,"九江",116.00137329101562,29.705400466918945],[210700,"锦州",121.13524627685547,41.093990325927734],[360200,"景德镇",117.18170166015625,29.30706024169922],[230800,"佳木斯",130.3203125,46.79930877685547],[230300,"鸡西",130.97354125976562,45.2982292175293],[360800,"吉安",114.99349975585938,27.11383056640625],[419001,"济源",{},{}],[410800,"焦作",113.2419662475586,35.21559143066406],[445200,"揭阳",116.37261962890625,23.549640655517578],[620300,"金昌",102.18759155273438,38.52265930175781],[140500,"晋城",112.85164642333984,35.49037170410156],[140700,"晋中",112.751220703125,37.68722915649414],[420800,"荆门",112.19940185546875,31.035400390625],[620900,"酒泉",98.49388885498047,39.73823165893555],[620200,"嘉峪关",98.2896728515625,39.77191162109375]],K:[[530100,"昆明",102.72216033935547,25.037879943847656],[410200,"开封",114.3072509765625,34.797218322753906],[653100,"喀什地区",75.98970794677734,39.47037124633789],[650200,"克拉玛依",84.88912963867188,45.57938003540039],[653e3,"克孜勒苏",76.1668701171875,39.71649169921875]],L:[[620100,"兰州",103.83409881591797,36.06135940551758],[530700,"丽江",100.22640991210938,26.85474967956543],[131e3,"廊坊",116.7064208984375,39.52069091796875],[410300,"洛阳",112.4531478881836,34.618038177490234],[320700,"连云港",119.22174072265625,34.595211029052734],[511100,"乐山",103.76531982421875,29.552160263061523],[540100,"拉萨",91.11434173583984,29.644060134887695],[451300,"来宾",109.22293090820312,23.74803924560547],[371200,"莱芜",117.67552947998047,36.21493911743164],[331100,"丽水",119.92288208007812,28.467159271240234],[513400,"凉山",102.26776123046875,27.881040573120117],[211e3,"辽阳",123.17279052734375,41.269649505615234],[220400,"辽源",125.1435775756836,42.88801956176758],[450200,"柳州",109.41539764404297,24.32537078857422],[371300,"临沂",118.34935760498047,35.0536003112793],[371500,"聊城",115.98538208007812,36.45587921142578],[542600,"林芝",94.35997772216797,29.672420501708984],[530900,"临沧",100.07946014404297,23.877599716186523],[141e3,"临汾",111.51763153076172,36.08763885498047],[622900,"临夏",103.21099090576172,35.601409912109375],[341500,"六安",116.50554656982422,31.744670867919922],[520200,"六盘水",104.83099365234375,26.592649459838867],[350800,"龙岩",117.03411102294922,25.10062026977539],[621200,"陇南",104.9222412109375,33.39897918701172],[431300,"娄底",111.9945297241211,27.6972599029541],[510500,"泸州",105.44249725341797,28.871639251708984],[141100,"吕梁",111.14404296875,37.518489837646484],[411100,"漯河",114.0167465209961,33.581459045410156]],M:[[340500,"马鞍山",118.50463104248047,31.697280883789062],[440900,"茂名",110.9251708984375,21.663240432739258],[511400,"眉山",103.84844970703125,30.07546043395996],[441400,"梅州",116.1223373413086,24.288530349731445],[510700,"绵阳",104.6793212890625,31.467220306396484],[231e3,"牡丹江",129.61961364746094,44.588539123535156]],N:[[320100,"南京",118.79637908935547,32.05830001831055],[330200,"宁波",121.54974365234375,29.874040603637695],[360100,"南昌",115.85845184326172,28.6830997467041],[450100,"南宁",108.36650848388672,22.816320419311523],[320600,"南通",120.89337158203125,31.98232078552246],[511300,"南充",106.11064910888672,30.83724021911621],[511e3,"内江",105.05859375,29.580400466918945],[542400,"那曲",92.06072998046875,31.473970413208008],[350700,"南平",118.17772674560547,26.641450881958008],[411300,"南阳",112.52847290039062,32.99087142944336],[350900,"宁德",119.52632904052734,26.666419982910156],[533300,"怒江",98.85269165039062,25.855180740356445]],P:[[510400,"攀枝花",101.71749114990234,26.58237075805664],[211100,"盘锦",122.07208251953125,41.12063980102539],[410400,"平顶山",113.3092269897461,33.72663879394531],[620800,"平凉",106.6649398803711,35.54214859008789],[360300,"萍乡",113.85513305664062,27.622190475463867],[350300,"莆田",119.0075912475586,25.453929901123047],[410900,"濮阳",115.03244018554688,35.75920867919922],[530800,"普洱",100.9702377319336,22.78215980529785]],Q:[[370200,"青岛",120.38289642333984,36.066158294677734],[350500,"泉州",118.58696746826172,24.907360076904297],[130300,"秦皇岛",119.60186004638672,39.935638427734375],[330800,"衢州",118.87349700927734,28.93609046936035],[441800,"清远",113.05615234375,23.681739807128906],[621e3,"庆阳",107.63298797607422,35.73843002319336],[230200,"齐齐哈尔",123.91716766357422,47.354408264160156],[429005,"潜江",112.89913177490234,30.402179718017578],[522600,"黔东南",107.97476196289062,26.585119247436523],[522700,"黔南",107.52220916748047,26.254230499267578],[522300,"黔西南",104.90657806396484,25.087989807128906],[450700,"钦州",108.65408325195312,21.980810165405273],[530300,"曲靖",103.79617309570312,25.48995018005371],[230900,"七台河",131.00302124023438,45.7706298828125]],R:[[542300,"日喀则",88.88134002685547,29.266820907592773],[371100,"日照",119.53204345703125,35.41115188598633]],S:[[310100,"上海",121.4745101928711,31.230649948120117],[440300,"深圳",114.05780029296875,22.54290008544922],[210100,"沈阳",123.43182373046875,41.80622863769531],[130100,"石家庄",114.5146713256836,38.04273986816406],[320500,"苏州",120.58541107177734,31.29878044128418],[460200,"三亚",109.51116180419922,18.252399444580078],[330600,"绍兴",120.57785034179688,30.004470825195312],[440500,"汕头",116.68184661865234,23.351520538330078],[440200,"韶关",113.59716033935547,24.81022071838379],[411200,"三门峡",111.20027923583984,34.77259063720703],[350400,"三明",117.63912963867188,26.263830184936523],[542200,"山南地区",91.7756576538086,29.225130081176758],[441500,"汕尾",115.37545013427734,22.7857608795166],[611e3,"商洛",109.93498992919922,33.87001037597656],[411400,"商丘",115.65132904052734,34.44684982299805],[361100,"上饶",117.97589111328125,28.44384002685547],[430500,"邵阳",111.4677734375,27.240009307861328],[420300,"十堰",110.7888412475586,32.65066909790039],[640200,"石嘴山",106.36813354492188,39.019100189208984],[230500,"双鸭山",131.1590576171875,46.646541595458984],[140600,"朔州",112.43295288085938,39.33129119873047],[220300,"四平",124.34993743896484,43.165950775146484],[220700,"松原",124.82489013671875,45.14125061035156],[321300,"宿迁",118.27542114257812,33.96187973022461],[341300,"宿州",116.96385955810547,33.64611053466797],[231200,"绥化",126.9685287475586,46.65386962890625],[421300,"随州",113.38240814208984,31.69021987915039],[510900,"遂宁",105.56784057617188,30.525489807128906]],T:[[120100,"天津",117.21446990966797,39.12080001831055],[140100,"太原",112.55075073242188,37.870540618896484],[130200,"唐山",118.18048095703125,39.630531311035156],[331e3,"台州",121.4206771850586,28.65428924560547],[654200,"塔城",82.98416137695312,46.748939514160156],[370900,"泰安",117.08748626708984,36.2000617980957],[321200,"泰州",119.92294311523438,32.454830169677734],[620500,"天水",105.72509002685547,34.582359313964844],[211200,"铁岭",123.84542083740234,42.28649139404297],[220500,"通化",125.93991088867188,41.72819900512695],[150500,"通辽",122.26616668701172,43.61922073364258],[610200,"铜川",108.9450912475586,34.89667892456055],[340700,"铜陵",117.8203125,30.937599182128906],[522200,"铜仁",109.16011810302734,27.691560745239258],[652100,"吐鲁番",89.18730926513672,42.958900451660156]],W:[[320200,"无锡",120.30281829833984,31.56591033935547],[420100,"武汉",114.30522918701172,30.592769622802734],[650100,"乌鲁木齐",87.61653900146484,43.82643127441406],[330300,"温州",120.69931030273438,27.994850158691406],[371e3,"威海",122.12374114990234,37.510009765625],[370700,"潍坊",119.16171264648438,36.70682144165039],[340200,"芜湖",118.38524627685547,31.339189529418945],[610500,"渭南",109.51024627685547,34.49951171875],[532600,"文山",104.25145721435547,23.368419647216797],[150300,"乌海",106.82388305664062,39.68434143066406],[150900,"乌兰察布",113.13375091552734,40.994140625],[640300,"吴忠",106.19873046875,37.99750900268555],[450400,"梧州",111.2788314819336,23.477699279785156],[620600,"武威",102.63780975341797,37.931739807128906]],X:[[610100,"西安",108.94412231445312,34.264801025390625],[350200,"厦门",118.0893783569336,24.479530334472656],[320300,"徐州",117.1915512084961,34.259761810302734],[630100,"西宁",101.77780151367188,36.61722183227539],[532800,"西双版纳",100.7976303100586,22.007179260253906],[152500,"锡林郭勒",116.04769134521484,43.93315887451172],[421200,"咸宁",114.322021484375,29.84086036682129],[610400,"咸阳",108.70967864990234,34.3290901184082],[430300,"湘潭",112.9429931640625,27.830129623413086],[433100,"湘西",109.7388916015625,28.311800003051758],[420600,"襄樊",112.15408325195312,32.02267837524414],[420900,"孝感",113.91635131835938,30.924739837646484],[140900,"忻州",112.73770141601562,38.41572952270508],[360500,"新余",114.9165267944336,27.81822967529297],[411500,"信阳",114.0686264038086,32.12303924560547],[152200,"兴安盟",122.06304168701172,46.07875061035156],[130500,"邢台",114.50493621826172,37.07059097290039],[411e3,"许昌",113.85228729248047,34.03565979003906],[341800,"宣城",118.7585678100586,30.940710067749023]],Y:[[321e3,"扬州",119.41354370117188,32.39379119873047],[610600,"延安",109.48973846435547,36.58546829223633],[640100,"银川",106.23251342773438,38.488948822021484],[511800,"雅安",103.01318359375,29.980459213256836],[370600,"烟台",121.4476318359375,37.463558197021484],[222400,"延边",129.509033203125,42.89128875732422],[320900,"盐城",120.16168212890625,33.354408264160156],[441700,"阳江",111.98248291015625,21.858230590820312],[140300,"阳泉",113.58040618896484,37.85663986206055],[230700,"伊春",128.90399169921875,47.72737121582031],[654e3,"伊犁",81.32746887207031,43.919368743896484],[511500,"宜宾",104.64334106445312,28.751750946044922],[420500,"宜昌",111.28685760498047,30.69202995300293],[360900,"宜春",114.41000366210938,27.817169189453125],[430900,"益阳",112.3551025390625,28.553869247436523],[360600,"鹰潭",117.06912231445312,28.260129928588867],[210800,"营口",122.23486328125,40.666778564453125],[431100,"永州",111.61392211914062,26.42160987854004],[610800,"榆林",109.7345199584961,38.28517150878906],[450900,"玉林",110.16455078125,22.63619041442871],[632700,"玉树",97.01708984375,33.02265930175781],[530400,"玉溪",102.5465316772461,24.35186004638672],[430600,"岳阳",113.12698364257812,29.3570499420166],[445300,"云浮",112.04454803466797,22.91489028930664],[140800,"运城",111.00691986083984,35.026241302490234]],Z:[[410100,"郑州",113.6246337890625,34.74673843383789],[440400,"珠海",113.57672119140625,22.270910263061523],[442e3,"中山",113.39253997802734,22.515859603881836],[330900,"舟山",122.20773315429688,29.985349655151367],[321100,"镇江",119.45674896240234,32.20021057128906],[30700,"张家口",{},{}],[370400,"枣庄",117.32357025146484,34.81003952026367],[440800,"湛江",110.3593978881836,21.270729064941406],[430800,"张家界",110.48001098632812,29.11557960510254],[1620700,"张掖",{},{}],[350600,"漳州",117.64714813232422,24.513399124145508],[530600,"昭通",103.71533203125,27.337890625],[441200,"肇庆",112.46533203125,23.047029495239258],[640500,"中卫",105.1736068725586,37.51694869995117],[411600,"周口",114.65328979492188,33.623138427734375],[430200,"株洲",113.13442993164062,27.82784080505371],[411700,"驻马店",114.0356674194336,32.981868743896484],[512e3,"资阳",104.62857055664062,30.13071060180664],[370300,"淄博",118.05499267578125,36.81282043457031],[510300,"自贡",104.77828979492188,29.338939666748047],[520300,"遵义",106.9271469116211,27.725400924682617]]};c.app.CityAll=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:g,init:function(a){var b=this;b.search_key=a,b.delivery_filter_data=c.lib.memCache.get("delivery_filter_data")||b._filterDataReset(),b.search_key&&(b.delivery_filter_data.key=b.search_key),b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setBeforePageOut:function(a){/index/.test(a)||(this.scroll_top=e.body.scrollTop),e.body.scrollTop=0},setAfterPageOut:function(a){/index/.test(a)&&(this.delivery_filter_data=this._filterDataReset(),c.lib.memCache.set("delivery_filter_data",this.delivery_filter_data))},setBeforePageIn:function(){},setAfterPageIn:function(){c.lib.memCache.get("update_delivery")&&(this.delivery_filter_data=this.delivery_filter_data||this._filterDataReset(),this.delivery_filter_data.city=c.lib.localStorage.get("default_address").citycode,c.lib.memCache.removeValue("disHasTip"),this._addressHandler(),this._distanceTip()),f.supportFunc("setOptionMenu")&&f.push("setOptionMenu",{icon:"http://g.dd.alicdn.com/tps/i2/T12wwaFRXXXXa2FNje-36-35.png"},function(){})},_filterDataReset:function(){return{taste:"口味不限",taste_id:"0",sort:"默认排序",sort_id:0,filte:"送餐费不限",filte_v:0,city:"",key:""}},_renderStatic:function(){this.wrap.html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;c.lib.memCache.get("update_delivery")||a._addressHandler()},_addressHandler:function(){var a=this;return a.state=l.getState(),a.state_data=a.state.data.data,a.default_address=c.lib.localStorage.get("default_address"),a.page={current:1,total:0,pz:20},a.default_address?(a.delivery_filter_data.city=a.default_address.citycode,void a._buildTmpl()):void lib.mtop.request({api:"mtop.life.diandian.getDefaultUserAddressById",v:"1.0",data:{},extParam:{}},function(b){b.data&&(c.lib.localStorage.set("default_address",b.data.model),a.default_address=b.data.model,a.delivery_filter_data.city=a.default_address.citycode,a._buildTmpl(),a._distanceTip())},function(){a._buildEnterTmpl()})},_buildTmpl:function(){var b=this;b.state=l.getState(),b.state_data=b.state.data.data,c.lib.memCache.set("delivery_filter_data",b.delivery_filter_data);var d={address:b.default_address,taste:b.delivery_filter_data.taste,sort:b.delivery_filter_data.sort,sort_id:b.delivery_filter_data.sort_id,filte:b.delivery_filter_data.filte,filte_v:b.delivery_filter_data.filte_v,key:b.delivery_filter_data.key,swipeid:l.getState().data.referer||"index"},e=c.ui.tmpl(h.html(),d);b.wrap.html(e),b.delivery_filter_subclass=a("#J_delivery_filter_subclass"),b.delivery_mask=a("#J_delivery_mask"),b.pulldown_el=b.wrap.find(".J_pulldown"),b.pullup_el=b.wrap.find(".J_pullUp"),b._takeoutStoreList("refresh"),b._takeoutShopCategoryList(),b.wrap.find("#J_delivery_list").html(c.ui.tpl.load),c._hideTitleBar&&f.push("setTitle",{title:b.wrap.find(".hd_title").find("h2").html()||"淘点点"})},_takeoutStoreList:function(a){var b=this;k=!0;var d={remark:["page=",b.page.current,",pageSize=",b.page.pz,",src=0"].join(""),rn:lib.encode.md5(Date.now()+Math.random().toString(32)).toLowerCase()};lib.mtop.request({api:"mtop.life.diandian.takeoutStoreList",v:"1.0",data:{x:parseFloat(b.default_address.posx),y:parseFloat(b.default_address.posy),taste:parseInt(b.delivery_filter_data.taste_id),minp:0,maxp:0,o:parseInt(b.delivery_filter_data.sort_id),filte:b.delivery_filter_data.filte_v,key:b.delivery_filter_data.key,p:b.page.current,pz:b.page.pz,city:b.delivery_filter_data.city,statisticsInfo:JSON.stringify(d)}},function(c){c.data&&(b.page.total=Math.ceil(parseInt(c.data.totalCount)/b.page.pz),b._buildLi({storeList:c.data.storeList},a)),k=!1},function(a){c.ui.toast(a,b),k=!1})},_buildLi:function(b,d){var e,f=this;e=b&&b.storeList&&b.storeList.length?c.ui.tmpl(a("#J_tpl_delivery_carteli").html(),b):"<div class='no_content'><i></i>没有外卖能送到您的配送地址</div>","refresh"==d&&f.wrap.find("#J_delivery_list").empty(),f.startUp(e),"refresh"==d?(f.page.total>1?f.pullup_el.removeClass("dn"):f.pullup_el.addClass("dn"),setTimeout(function(){f._scrollInit()},0)):(f.page.current>=f.page.total&&f.pullup_el.addClass("dn"),f._scroll.refresh())},_distanceTip:function(){var a=this;c.lib.memCache.get("disHasTip")||(c.lib.memCache.get("geo_location")?a._distanceHandler():c.lib.getH5Geo({callback:function(b){b.latitude&&"delivery"==c.lib.getUriParam(l.getState().url,"_ddid")&&a._distanceHandler()}}))},_distanceHandler:function(){var a=this,b=c.lib.memCache.get("geo_location")||c.lib.localStorage.get("current_city"),d={longitude:b.longitude,latitude:b.latitude},e={longitude:a.default_address.posx,latitude:a.default_address.posy},g=c.lib.geoDistance(d,e);g>parseInt(c.config.waimai.tip.waimai_tip_distance)&&setTimeout(function(){f.push("confirm",{title:"提示",message:"送餐地址和您当前位置相距"+c.lib.num2Fixed(g/1e3,1)+"千米",okButton:"确定",cancelButton:"修改送餐地址"},function(b){b.ok||c.lib.ddState({push:{ddid:"address/"+a.default_address.id,obj:{referer:"delivery"}}})}),c.lib.memCache.set("disHasTip","true")},100)},startUp:function(a){this.wrap.find("#J_delivery_list").append(a)},events:[[c.event.click,".J_delivery_item","_itemHandler"],[c.event.click,"#J_delivery_search","_searchHandler"],[c.event.click,"#J_delivery_sort li","_sortHandler"],[c.event.click,"#J_delivery_filte_list li","_filteHandler"],[c.event.click,".J_subject_filter","_subjectFilterHandler"],[c.event.click,"#J_delivery_mask","_maskHandler"]],menuEvent:"_searchHandler",_itemHandler:function(b,d){var e=a(d).attr("data-swipeid"),f={push:{ddid:e,obj:{referer:"delivery",default_address:this.default_address}}};
c.lib.ddState(f)},_searchHandler:function(){var b="search/delivery",d={push:{ddid:b,obj:{deliveryData:this.delivery_filter_data,default_address:this.default_address,referer:"delivery"}}};a("#J_search").removeAttr("data-ddid"),c.lib.ddState(d)},_subjectFilterHandler:function(b,c){var d=this;if(!k){if(a(c).hasClass("current"))return void d._filterkHide();{var e=a(c).data("type");a(c).index()}d.delivery_mask.show(),setTimeout(function(){d.delivery_filter_subclass.attr("class","filter_subclass subclass_"+e).show()},0),a(c).addClass("current").siblings(".current").removeClass("current"),this._scroll.disable()}},_maskHandler:function(){this._filterkHide()},_sortHandler:function(b,c){a(c).addClass("current").siblings(".current").removeClass("current"),this._filterUpdate()},_filteHandler:function(b,c){a(c).addClass("current").siblings(".current").removeClass("current"),this._filterUpdate()},_touchstartHandler:function(){j.wrap[0].style.webkitTransition="0ms"},_touchmoveHandler:function(a){a.preventDefault(),j.x=a.touches[0].pageX,j.x<40||j.x>j.max||(j.wrap[0].style.webkitTransform="translateX("+j.x+"px)")},_touchendHandler:function(){var a=this;setTimeout(function(){var b=j.x,c=Math.ceil(b/j.unit);a._setFilterPointer(c-1,j.unit),a._filterUpdate()},0)},_takeoutShopCategoryList:function(){var b=this,d=[{cateId:"101",cateName:"中式炒菜"},{cateId:"199",cateName:"快餐/小吃"},{cateId:"108",cateName:"日韩料理"},{cateId:"104",cateName:"蛋糕面包"},{cateId:"105",cateName:"奶茶甜品"},{cateId:"113",cateName:"烧烤/火锅"},{cateId:"109",cateName:"水果蔬菜"}],e=b.delivery_filter_data.taste_id,f=[];a.each(d,function(a,b){f.push('<li data-id="'+b.cateId+'" class="'+(e==b.cateId?"current":"")+'"><div><em></em><i class="kwbx_'+b.cateId+'"></i>'+b.cateName+"</div></li>")}),a("#J_delivery_taste_list").html('<li class="'+("0"==e?"current":"")+'" data-id="0"><div><em></em><i class="kwbx"></i>口味不限</div></li>'+f.join("")),b.wrap.find("#J_delivery_taste_list li").on(c.event.click,function(){a(this).addClass("current").siblings(".current").removeClass("current"),b._filterUpdate()})},_buildEnterTmpl:function(){var a=this,b=c.ui.tmpl(i.html(),{swipeid:l.getState().data.referer||"index"});c.ui.toast.hide(),a.wrap.html(b),this._enterHandler()},_enterHandler:function(){g.find("#J_delivery_address").on(c.event.click,function(){var a="address",b={push:{ddid:a,obj:{referer:"delivery"}}};f.push("login",function(){c.lib.ddState(b)})})},_slideInit:function(){var b=this,c=document.body.clientWidth,d=c/4/2;j.wrap=a("#J_delivery_slide_pointer"),j.max=c-d,j.unit=c/4,b._setFilterPointer(b.delivery_filter_data.averageIndex,j.unit)},_filterkHide:function(){var a=this;a.delivery_mask.hide(),a.delivery_filter_subclass.hide(),a.wrap.find(".J_subject_filter").filter(".current").removeClass("current"),this._scroll.enable()},_setFilterPointer:function(b,c){var d=b*c+c/2,f=e.getElementById("J_delivery_slide_pointer");f.style.webkitTransition="100ms",f.style.webkitTransform="translateX("+d+"px)",a("#J_delivery_sort li").eq(b).addClass("current").siblings(".current").removeClass("current"),setTimeout(function(){a("#J_delivery_filter_subclass").hide(),a("#J_delivery_mask").hide()},100)},_filterUpdate:function(){var b=this,d=a("#J_delivery_taste_list li.current"),e=a("#J_delivery_sort li.current"),f=a("#J_delivery_filte_list li.current");b.delivery_filter_data.taste=d.text()||"口味不限",b.delivery_filter_data.taste_id=d.attr("data-id")||"0",b.delivery_filter_data.sort=e.text()||"默认排序",b.delivery_filter_data.sort_id=e.attr("data-sort")||"0",b.delivery_filter_data.filte=f.text()||"口味不限",b.delivery_filter_data.filte_v=f.data("v")||"0",c.lib.memCache.set("delivery_filter_data",b.delivery_filter_data),b._addressHandler(),this._scroll.enable()},_scrollInit:function(){var a=this;this.winScroll={},this._scroll=c.ui._scroll({wrap:"#J_delivery_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullDownAction:function(){var a=this;a.page.current=1,a._takeoutStoreList("refresh")},_pullUpAction:function(){var a=this;a.page.current++,a._takeoutStoreList("add")}}}{var e=b.document,f=b.bridge,g=a("#J_delivery"),h=a("#J_tpl_delivery"),i=a("#J_tpl_delivery_enter"),j={wrap:void 0,x:void 0,max:void 0,unit:void 0},k=!1,l=b.History;b.localStorage}c.app.Delivery=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a,b){var c=this;c.longitude=a,c.latitude=b,c.page={pz:20,pn:1,total:0,pTotal:1,role:"init"},c.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setBeforePageOut:function(){},setAfterPageOut:function(){},setBeforePageIn:function(){},setAfterPageIn:function(){},_renderStatic:function(){var a=this,b={swipeid:h.getState().data.referer||"delivery"},d=c.ui.tmpl(f.html(),b);a.wrap.html(d),a.delivery_hot_content=a.wrap.find("#J_delivery_hot_content").html(c.ui.tpl.load),a.pullup_el=a.wrap.find(".J_pullUp")},_renderDynamic:function(){var a=this;a._getHotList()},_getHotList:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getHotTakeoutItems",v:"1.0",data:{pos_y:a.latitude,pos_x:a.longitude,page_size:a.page.pz,page_no:a.page.pn},extParam:{}},function(b){var c=b.data;a.page.total=c.count,a.page.pTotal=Math.ceil(parseInt(c.count)/a.page.pz),a._buildTmpl(c)},function(b){"init"!==a.page.init&&a.page.pn--,c.ui.toast(b,a)})},_buildTmpl:function(a){var b=this,d={list:a.itemList||[]},e=c.ui.tmpl(g.html(),d);"init"==b.page.role&&(b.delivery_hot_content.html(""),b.page.pn=1),b.delivery_hot_content.append(e),"init"==b.page.role&&b._scrollInit(),b._manualHandler()},_manualHandler:function(){var a=this,b=a.page;b.pTotal>1&&b.pn<b.pTotal?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn"),a._scroll.refresh()},events:[[c.event.click,".J_delivery_item","_itemHandler"],[c.event.click,"#J_delivery_search","_searchHandler"]],_scrollInit:function(){var a=this;this._scroll=c.ui._scroll({wrap:"#J_delivery_hot_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullUpAction:function(){var a=this;a.page.pn++,a.page.role="add",a._getHotList()}}}var e=(b.document,b.bridge,a("#J_delivery_hot")),f=a("#J_tpl_delivery_hot"),g=a("#J_tpl_delivery_hot_list"),h=b.History;c.app.DeliveryHot=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:h,reserve_init:!1,reserve_filter_data:{},init:function(a){var b=this;b.search_key=a,b.outcity=!1,b.dian_filter_data=b.dian_filter_data||b._filterDataReset(),b.search_key&&(b.dian_filter_data.kw=b.search_key),b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},_filterDataReset:function(){return{x:0,p:this._filterPReset(),y:0,ibf:0,d:0,city:"",kw:"",cat:0,pz:this._filterPzReset(),f:this._filterF("all"),o:"flags8192",ptotal:this._filterPtotalReset()}},_filterPzReset:function(){return 20},_filterPReset:function(){return 1},_filterPtotalReset:function(){return 0},_filterF:function(b){var c=this;return reserve_filter=a("#J_ReserveFilter"),reserve_filter.hide(),"reserve"==b?(c.reserve_init||c.getReserveData(reserve_filter),reserve_filter.show(),"32768"):"quan"==b?"8192":"128,2048,4096,8192,16384,32768"},getReserveData:function(b){var d=this;lib.mtop.request({api:"mtop.life.diandian.reserveCondition",v:"1.0",data:{}},function(e){var f=c.ui.tmpl(a("#J_tpl_dian_reserve").html(),e.data);b.html(f),a.each(b.find("select"),function(b,c){var e=a(c).attr("data-name");d.reserve_filter_data[e]=a(c).attr("data-init")}),d.reserve_init=!0},function(a){c.ui.toast(a,d)})},setBeforePageOut:function(){},setAfterPageOut:function(a){var b=this;"index"==a&&(b.dian_filter_data=null)},setBeforePageIn:function(){},setAfterPageIn:function(){var a=this;c.lib.memCache.get("update_city")&&a._cityInit(),e.supportFunc("setOptionMenu")&&e.push("setOptionMenu",{icon:"http://g.dd.alicdn.com/tps/i2/T12wwaFRXXXXa2FNje-36-35.png"},function(){})},_renderStatic:function(){var a=this;a.wrap.html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;return c.lib.localStorage.get("current_city")?void(c.lib.memCache.get("update_city")||a._cityInit()):(g.addEventListener("click",c.lib.preventAllClick,!0),void c.lib.getH5Geo({callback:function(){g.removeEventListener("click",c.lib.preventAllClick,!0),a._cityInit()}}))},_cityInit:function(){var a=this,b=c.lib.memCache.get("geo_location")||{};a.current_city=c.lib.localStorage.get("current_city")||b,a.dian_filter_data.city=a.current_city.cityId,a.dian_filter_data.city!==b.cityId?(a.outcity=!0,a.dian_filter_data.d=0,a.dian_filter_data.x=0,a.dian_filter_data.y=0):(a.outcity=!1,a.dian_filter_data.x=b.longitude,a.dian_filter_data.y=b.latitude),a._buildTmpl()},_titleLazy:!0,_buildTmpl:function(){var a=this,b={cityname:a.current_city.cityName||"城市",kw:a.dian_filter_data.kw,swipeid:l.getState().data.referer||"index",filter:a.dian_filter_data},d=c.ui.tmpl(i.html(),b);return a.wrap.html(d),a.wrap.find(".hd_title").find("h2")&&!a.wrap._titleLazy&&e.push("setTitle",{title:a.wrap.find(".hd_title").find("h2").html()||"淘点点"}),a.current_city.cityId?(a.dian_filter_cat=a.wrap.find("#J_dian_filter_cat"),a.dian_filter_subclass=a.wrap.find("#J_dian_filter_subclass"),a.subclass_content=a.wrap.find("#J_subclass_content"),a.dian_mask=a.wrap.find("#J_dian_mask"),a.pulldown_el=a.wrap.find(".J_pulldown"),a.pullup_el=a.wrap.find(".J_pullUp"),a._pageInit(),a._getStoreList("refresh"),void a._getCategoryList()):(a.wrap.find("#J_dian_list").html(c.ui.tpl.load),c.ui.toast("无法定位，请检查“定位”设置<br>",a),void setTimeout(function(){c.ui.toast("请选择城市"),c.lib.ddState({push:{ddid:"city",obj:{referer:"dian"}}})},c.ui.appinterval))},_pageInit:function(){var a=this;a.dian_filter_data.p=a._filterPReset(),a.dian_filter_data.pz=a._filterPzReset(),a.dian_filter_data.ptotal=a._filterPtotalReset(),c.lib.memCache.set("dian_filter_data",a.dian_filter_data),a.wrap.find("#J_dian_list").html(c.ui.tpl.load),a.pulldown_el.addClass("dn"),a.pullup_el.addClass("dn")},_getStoreList:function(a){var b=this;return b.outcity&&0!==b.dian_filter_data.d?void b._buildOutCity():(k=!0,void lib.mtop.request({api:"mtop.life.diandian.getStoreList",v:"1.1",data:{x:b.dian_filter_data.x,y:b.dian_filter_data.y,ibf:0,f:b.dian_filter_data.f,kw:b.dian_filter_data.kw,cat:b.dian_filter_data.cat,p:b.dian_filter_data.p,pz:b.dian_filter_data.pz,city:b.dian_filter_data.city,o:b.dian_filter_data.o,reserved:b.dian_filter_data.reserve||""}},function(c){c.data&&b._storeDataHandler(c.data,a),k=!1},function(d){c.ui.toast(d,b),k=!1,"refresh"!==a&&b.dian_filter_data.p--}))},_storeDataHandler:function(a,b){var c=this;c.dian_filter_data.ptotal=Math.ceil(parseInt(a.count)/c.dian_filter_data.pz),c._buildList({storeList:a.storeDList},b)},_buildOutCity:function(){var a=this;a.wrap.find("#J_dian_list").html('<div class="no_content"><i></i>异地或者没有位置信息</div>'),a._scrollInit()},_buildList:function(a,b){var d=this;d._storeList=d._storeList||[],a.storeList&&a.storeList.length&&(d._storeList=d._storeList.concat(a.storeList));var e=c.ui.tmpl(j.html(),a);"refresh"==b&&d.wrap.find("#J_dian_list").empty(),(!d._storeList.length||a.storeList&&a.storeList.length)&&this.wrap.find("#J_dian_list").append(e),"refresh"==b?(d.dian_filter_data.ptotal>1?d.pullup_el.removeClass("dn"):d.pullup_el.addClass("dn"),setTimeout(function(){d._scrollInit()},0)):(d.dian_filter_data.p>=d.dian_filter_data.ptotal&&d.pullup_el.addClass("dn"),d._scroll.refresh())},_getCategoryList:function(){var b=this,c=b.dian_filter_data.cat;lib.mtop.request({api:"mtop.life.diandian.categoryList",v:"1.0",data:{city:b.dian_filter_data.city}},function(b){if(b.data){var d=[];a.each(b.data.cateList,function(a,b){d.push('<li data-type="cat" data-v="'+b.cateId+'" class="'+(c==b.cateId?"current":"")+'"><i></i>'+b.cateName+"</li>")}),a("#J_dian_cate_list").html('<li data-type="cat" class="'+("0"==c?"current":"")+'" data-v="0"><i></i>口味不限</li>'+d.join(""))}},function(){})},events:[[c.event.click,".J_dian_item","_itemHandler"],[c.event.click,"#J_dian_search","_searchHandler"],[c.event.click,".J_dian_filter_tab","_filterTabHandler"],[c.event.click,"#J_dian_filter_cat","_filterSubclassHandler"],[c.event.click,".J_subclass_tab","_SubclassTabHandler"],[c.event.click,"#J_subclass_content li","_SubclassLiHandler"],[c.event.click,"#J_dian_mask","_maskHandler"],["change","select","_reserveHandler"]],_reserveHandler:function(b,c){var d=this,e=a(c),f=e.data("name"),g=c.value,h=e.siblings(".J_show_value"),i=e.children().not(function(){return!this.selected}),j=i.text();h.text(j),d.reserve_filter_data[f]=g;var k=d.reserve_filter_data;d.dian_filter_data.reserve=k.reserveDate+k.reserveRang+k.capacity,d._filterUpdate()},_itemHandler:function(b,d){c.lib.ddState({push:{ddid:"store/"+a(d).data("id"),obj:{referer:"dian"}}})},_searchHandler:function(){var b=this,d="search/dian",e={push:{ddid:d,obj:{referer:"dian",dianData:b.dian_filter_data}}};a("#J_search").removeAttr("data-ddid"),c.lib.ddState(e)},_filterTabHandler:function(b,d){var e=this,f=a(d);c.lib.localStorage.get("current_city")&&(f.hasClass("current")?(e.dian_filter_data.f=e._filterF("all"),f.removeClass("current")):(e.dian_filter_data.f=e._filterF(f.data("type")),f.addClass("current").siblings(".J_dian_filter_tab").removeClass("current")),e._filterUpdate())},_filterSubclassHandler:function(b,c){var d=this;if(!k){if(a(c).hasClass("current"))return void d._filterSubclassHide();d.dian_mask.show(),setTimeout(function(){d.dian_filter_subclass.show()},0),a(c).addClass("current"),d.scrolldisable=!0,this._scroll.disable()}},_SubclassTabHandler:function(b,c){var d=this;if(!k&&!a(c).hasClass("current")){var e=a(c).data("type");setTimeout(function(){d.subclass_content.attr("class","subclass_content subclass_"+e).show()},0),a(c).addClass("current").siblings(".current").removeClass("current")}},_SubclassLiHandler:function(b,c){var d=a(c).data("type"),e=a(c).data("v");a(c).addClass("current").siblings().removeClass("current"),this.dian_filter_data[d]=e,this._filterUpdate(),0==parseInt(e)?this.dian_filter_cat.removeClass("selected"):this.dian_filter_cat.addClass("selected")},_filterUpdate:function(){var a=this;c.lib.memCache.set("dian_filter_data",a.dian_filter_data),a._pageInit(),a._getStoreList("refresh"),a._filterSubclassHide()},_maskHandler:function(){this._filterSubclassHide()},_filterSubclassHide:function(){this.dian_filter_subclass.hide(),this.dian_mask.hide(),this.dian_filter_cat.removeClass("current"),this._scroll.enable()},_scrollInit:function(){var a=this;this._scroll=c.ui._scroll({wrap:"#J_dian_scroll",pullUpAction:function(){a._pullUpAction()}})},menuEvent:"_searchHandler",_pullUpAction:function(){var a=this;a.dian_filter_data.p++,a._getStoreList("add")}}}var e=b.bridge,f=b.document,g=f.body,h=a("#J_dian"),i=a("#J_tpl_dian"),j=a("#J_tpl_dian_li"),k=!1;c.lib.memCache.set("dian_cache",{});var l=b.History;c.app.Dian=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:i,init:function(a,b){var c=this;c.id=a,c.type=/^shop_/.test(b)?"shop":"store",c.localStoreId="store"==c.type?b:b.replace(/^shop_/,""),("undefined"==c.localStoreId||"null"==c.localStoreId)&&(c.localStoreId=""),c.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},_renderStatic:function(){var a=this,b={alt:History.getState().data.referer||"dian",type:a.type},d=c.ui.tmpl(j.html(),b);i.html(d),e=i.find("#J_evoucher_content").html(c.ui.tpl.load),f=i.find("#J_evoucher_buy_btn"),g=i.find("#J_evoucher_largess_btn")},_renderDynamic:function(){var a=this;a.geo_location=c.lib.memCache.get("geo_location")||{},a.geo_location&&a.geo_location.latitude&&a.geo_location.longitude&&(a.showDistance=!0),"store"==a.type?a._getEvoucher(a.geo_location):a._getShopEvoucher(a.geo_location)},_getEvoucher:function(a){var b=this;b.async||(b.async=!0,lib.mtop.request({api:"mtop.dd.ticket.sellerevoucher.detail",v:"1.0",data:{id:b.id,latitude:a&&a.latitude,longitude:a&&a.longitude}},function(a){a.data&&(b.async=!1,b._buildTmpl(a.data),c._hideTitleBar&&h.push("setTitle",{title:"代金券详情"}),m[b.id]=a.data)},function(a){c.ui.toast(a,b),b.async=!1}))},_buildTmpl:function(a){var b=this;if(a){b.endTime=a.offtimeDate,b.now=a.systemNowTime;var d=new Date(b.now.replace(/-/g,"/")),f=new Date(b.endTime.replace(/-/g,"/"));b.validBeginDate=+f,b.nowTime=+d,b.publishTime=+new Date(a.ontimeDate.replace(/-/g,"/")),b.publishendTime=+new Date(a.offtimeDate.replace(/-/g,"/")),b.showbeginTime=a.showbeginDate&&+new Date(a.showbeginDate.replace(/-/g,"/")),b.isSales=a.isSales,b.useRuleDo=a.useRuleDo,b.stock=a.stock;var g=f-d,h=g/864e5>=1?parseInt(g/864e5):0;g-=864e5*h;var i=g/36e5>=1?parseInt(g/36e5):0;g-=36e5*i;var j=g/6e4>=1?parseInt(g/6e4):0,l=(h?h+"天":"0天")+(i?i+"小时":"0小时")+(j?j+"分钟":"0分钟");if(l&&(a.endTimes=l+"后结束"),a.refundAnytimeIcon="1"==a.refundAnytime?"y":"n",a.refundOverdueIcon="1"==a.refundOverdue?"y":"n",a.showDistance=b.showDistance,b.showDistance&&a.branchOffice&&a.branchOffice.length){var m=c.lib.geoDistance({latitude:b.geo_location.latitude,longitude:b.geo_location.longitude},{latitude:a.branchOffice[0].latitude,longitude:a.branchOffice[0].longitude});m=(m/1e3).toFixed(1)+" 千米",a.nearDis=m}}var n=c.ui.tmpl(k.html(),{data:a});e.html(n),b.isSales=a.isSales,b.conferType=a.conferType,b._t="fullSent"==b.conferType,parseInt(b.useRuleDo.buyLimit)>0?b._manualHandler():b._getUsrVouchers(),b._scrollInit()},_getUsrVouchers:function(){var b=this,c="";"buyOnline"==b.conferType?c=b.showbeginTime<b.publishTime&&b.publishTime>b.nowTime?'<span class="btn_sub_primary" id="J_evoucher_buy_btn">立即抢购</span>':b.publishendTime<b.nowTime?'<span class="btn_sub_primary evoucher_outTime">已下架</span>':parseInt(b.stock)<=0?'<span class="btn_sub_primary evoucher_outTime">已被抢光</span>':b.userVouchers&&parseInt(b.userVouchers.result)>=b.useRuleDo.buyLimit?'<span class="btn_sub_primary evoucher_outTime">已购买</span>':'<span class="btn_sub_primary" id="J_evoucher_buy_btn">立即抢购</span>':"fullSent"==b.conferType&&(c=b.showbeginTime<b.publishTime&&b.publishTime>b.nowTime?'<span class="btn_sub_primary" id="J_evoucher_largess_btn">立即领取</span>':b.publishendTime<b.nowTime?'<span class="btn_sub_primary evoucher_outTime">已下架</span>':parseInt(b.stock)<=0?'<span class="btn_sub_primary evoucher_outTime">已被抢光</span>':b.userVouchers&&parseInt(b.userVouchers.result)>=b.useRuleDo.buyLimit?'<span class="btn_sub_primary evoucher_outTime">已领取</span>':'<span class="btn_sub_primary" id="J_evoucher_largess_btn">立即领取</span>');var d=b.wrap.find(".name");c&&a(c).insertBefore(d)},_getShopEvoucher:function(a){var b=this;b.async||(b.async=!0,lib.mtop.request({api:"mtop.dd.voucher.localstore.detail",v:"1.0",data:{voucherId:b.id,latitude:a.latitude||0,longitude:a.longitude||0}},function(a){a.data&&b._buildShopCouponTmpl(a.data),b.async=!1},function(a){c.ui.toast(a,b),b.async=!1}))},_buildShopCouponTmpl:function(a){var b=c.ui.tmpl(l.html(),{data:a});this._t="free"==a.itemSalesType,e.html(b),this._scrollInit()},events:[[c.event.click,"#J_evoucher_buy_btn","_btnHandler"],[c.event.click,"#J_evoucher_largess_btn","_largessBtnHandler"],[c.event.click,".evoucher_address","_pushMap"],[c.event.click,"#J_shop_voucher_buy_btn","_shopVoucherBuyHandler"],[c.event.click,".J_shoplist","_pushShoplist"]],_pushShoplist:function(){var a=this;c.lib.ddState({push:{ddid:"my_evoucher_shoplist",obj:{list:m[a.id].branchOffice}}})},_pushMap:function(b,d){var e=this,f=a(d).data("referer");if(f){var g="address_map/show";f=f.split(";"),a("#J_address_map").removeAttr("data-ddid");var h={push:{ddid:g,obj:{data:{posx:f[1],posy:f[0]},referer:"store/"+e.storeid}}};c.lib.ddState(h)}},_btnHandler:function(){var a="evoucher_buy/"+this.id+(this.localStoreId?"/"+this.localStoreId:""),b={push:{ddid:a,obj:{data:m[this.id],referer:"evoucher/"+this.id}}};c.lib.ddState(b)},_largessBtnHandler:function(){var b=this;b.async||(b.async=!0,c.ui.toast.loading(),lib.mtop.request({api:"mtop.dd.ticket.evoucher.largess",v:"1.0",data:{id:b.id}},function(d){if(d.data){var e={push:{ddid:"pay_result/"+d.data.result,obj:{data:m[b.id]}}};a("#J_evoucher_result").removeAttr("data-ddid"),c.lib.ddState(e)}c.ui.toast.hide(),b.async=!1},function(a){c.ui.toast(a),b.async=!1}))},_shopVoucherBuyHandler:function(){var a=this;a.async||(a.async=!0,c.ui.toast.loading(),lib.mtop.request({api:"mtop.dd.voucher.user.buy",v:"1.0",data:{voucherId:a.id,num:1,localstoreId:a.localStoreId}},function(b){var d="pay_result/"+b.data.taobaoOrderNo,e={push:{ddid:d,obj:{type:a._t,voucherId:a.id,isEvoucher:!0}}};c.lib.ddState(e),c.ui.toast.hide(),a.async=!1},function(b){c.ui.toast(b),a.async=!1}))},_manualHandler:function(){var a=this;a.async||(a.async=!0,lib.mtop.request({api:"mtop.dd.ticket.evoucher.userevouchers",v:"1.0",data:{id:a.id}},function(b){b.data&&(a.userVouchers=b.data,a._getUsrVouchers(),n[a.id]=b.data),a.async=!1},function(b){c.ui.toast(b,a),a.async=!1}))},_scrollInit:function(){}}}var e,f,g,h=b.bridge,i=a("#J_evoucher"),j=a("#J_tpl_evoucher"),k=a("#J_tpl_evoucher_content"),l=a("#J_tpl_evoucher_shpp_content"),m={},n={};c.app.Evoucher=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:i,init:function(a,b){var c=this;c.id=a,c.localStoreId=b,c.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},_renderStatic:function(){var a=this,b={alt:m.getState().data.referer||"evoucher/"+a.id},d=c.ui.tmpl(j.html(),b);i.html(d),e=i.find("#J_evoucher_buy_content").html(c.ui.tpl.load),h=i.find("#J_evoucher_pay")},_renderDynamic:function(){var a=this;return a.data=m.getState().data.data,a.data?(a.data.userTel=c.lib.memCache.get("dian_tel")||"",void a._buildTmpl()):void c.lib.ddState({back:{ddid:"evoucher/"+a.id}})},_buildTmpl:function(){var a=this,b=c.ui.tmpl(k.html(),{data:a.data});a.startUp(b),f=i.find("#J_evoucher_input_tel"),g=i.find(".J_evoucher_buy_count"),a._iScrollInit()},startUp:function(a){e.html(a)},events:[[c.event.click,"#J_evoucher_pay","_payHandler"],[c.event.click,".J_evoucher_buy_options","_optionsHandler"]],_payHandler:function(){var b=a.trim(f.val()),c=a.trim(g.text());this._validPhone(b)&&this._validCount(c)&&this._createOrder()},_optionsHandler:function(b,c){var d=this;d.async||(d.async=!0,d._evoucherOptions(a(c)))},_evoucherOptions:function(a){var b=this,c=b.data,d=a.data("role"),e=c.useRuleDo.buyLimit&&"0"!=c.useRuleDo.buyLimit?Math.min(c.buyOnceMaxNum,c.stock,c.useRuleDo.buyLimit):Math.min(c.buyOnceMaxNum,c.stock),f=parseInt(g.eq(0).text());if("plus"==d){if(f++,f>e)return void(b.async=!1);a.siblings(".J_evoucher_buy_options").addClass("active"),f==e&&a.removeClass("active"),b._updateOptions(f)}else{if(f--,0>=f)return a.removeClass("active"),void(b.async=!1);a.siblings(".J_evoucher_buy_options").addClass("active"),b._updateOptions(f)}b.async=!1},_updateOptions:function(b){var c=this,d=a(".J_evoucher_buy_payValue"),e=parseInt(c.data.preferentialValue)*b/100;g.text(b),d.text(e.toFixed(2))},_validCount:function(a){return parseInt(a)?(c.lib.memCache.set("dian_evoucher_buy_count",a),!0):void c.ui.toast("购买份数异常")},_validPhone:function(a){return a?a>13e9&&19e9>a?(c.lib.memCache.set("dian_tel",a),!0):void c.ui.toast("请输入正确的手机号码！"):void c.ui.toast("请输入手机号")},_createOrder:function(){var a=this;a.async||(a.async=!0,!l.supportFunc("tradePay")&&c.ui.toast.loading(),lib.mtop.request({api:"mtop.dd.order.evoucher.buy",v:"1.0",data:{id:parseInt(a.id),num:c.lib.memCache.get("dian_evoucher_buy_count"),localstoreid:a.localStoreId||"",mobile:c.lib.memCache.get("dian_tel")},extParam:{}},function(b){var c=b.data;c&&a._doPay(c)},function(b){c.ui.toast(b),a.async=!1}))},_doPay:function(a){var b=this;l.supportFunc("tradePay")?l.push("tradePay",{tradeNO:a.alipayTradeIds},function(c){c.resultCode&&9e3==parseInt(c.resultCode)&&b._payCb(a),b.async=!1}):lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:a.taobaoOrderIds,payType:0}},function(d){if("true"==d.data.canPay){if(c.device.isAndroid&&c.device.version.android<4)return void(location.href=d.data.alipayUrl);c.ui.alipay({title:"支付",alipayUrl:d.data.alipayUrl,successFunc:function(){b._payCb(a)}})}c.ui.toast.hide(),b.async=!1},function(a){c.ui.toast(a),b.async=!1})},_payCb:function(b){a("#J_page").children().removeAttr("data-ddid");var d={push:{ddid:"pay_result/"+b.orderNo,obj:{type:b.orderType}}};c.lib.ddState(d)},_iScrollInit:function(){}}}var e,f,g,h,i=a("#J_evoucher_buy"),j=a("#J_tpl_evoucher_buy"),k=a("#J_tpl_evoucher_buy_content"),l=b.bridge,m=b.History;c.app.EvoucherBuy=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:l,init:function(){var a=this;a.index_search_data=a.index_search_data||{kw:"",city_data:{}};var b=+new Date+"_index";a.pid=b,a._monitor(),a.ttid=c.lib.getUriParam(p.getState().url,"ttid"),a.city_data={},a.initHandler()},_monitor:function(){var a,d,e=this,f=b,g=e.pid;f.performance&&(a=f.performance.timing)&&(d=a.navigationStart,d&&c.sendImage({st:d},g))},_bannerList:{},_homeBannerList:{},initHandler:function(){this._renderStatic(),this._renderDynamic()},setBeforePageIn:function(){},setBeforePageOut:function(){},setAfterPageIn:function(){this._cityReset()},setAfterPageOut:function(){this.carouseScroll&&this.carouseScroll.stop(),this.carousel_lock=!0},_renderStatic:function(){var b=this,d=c.ui.tmpl(m.html(),{width:a("#J_page").width()});b.wrap.html(d),b.home_activity_wrap=b.wrap.find("#J_home_activity_wrap"),b.home_menu_wrap=b.wrap.find("#J_home_menu_wrap"),a("#J_index_city").text(b.city_data.cityName||"城市").parent().addClass("J_swipe_page"),c._env||o.push("login",function(a){a&&(a.success||a.loginResult)&&b._userGet()})},_renderDynamic:function(){},menuEvent:"_cityClick",events:[[c.event.click,"#J_close_webview","_closeWebviewHandler"],[c.event.click,".home_menu_vouchers","_goTicket"],[c.event.click,".J_index_menu","_menuHandler"],[c.event.click,"#J_index_carousel_wrap li","_carouselLiHandler"],[c.event.click,"#J_index_search","_searchHandler"],[c.event.click,".J_home_box_item","_boxItemHandler"]],_goTicket:function(){var a=this,b=c.lib.localStorage.get("current_city"),d="http://h5.m.taobao.com/dd/card/index.html";a.ttid&&(d+="?ttid="+a.ttid);var e=[];b.cityId&&e.push("ci="+b.cityId),b.longitude&&e.push("lo="+b.longitude),b.latitude&&e.push("la="+b.latitude),b.cityName&&e.push("ca="+encodeURIComponent(b.cityName)),e.length&&(d+=-1!=d.indexOf("?")?"&"+e.join("&"):"?"+e.join("&")),a._pushWindow({url:d,showToolBar:!1,showTitleBar:!0})},_getCityInfo:function(){var a=c.lib.localStorage.get("current_city");if(a){var b=[];return a.cityId&&b.push("ci="+a.cityId),a.longitude&&b.push("lo="+a.longitude),a.latitude&&b.push("la="+a.latitude),a.cityName&&b.push("ca="+encodeURIComponent(a.cityName)),b.join("&")}},_closeWebviewHandler:function(){o.push("closeWebview")},_menuHandler:function(b,d){var e=a(d).attr("data-swipeid"),f={push:{ddid:e}};a("#J_"+e).removeAttr("data-ddid"),c.lib.ddState(f)},_carouselLiHandler:function(b,d){var e,f=this,g=a(d),h=(f.ttid,f._bannerList),i=g.attr("data-id");if(i&&(e=h[i])){var j=e.actionLink;if(/^http:\/\//.test(j))f._getCityInfo()&&(j+=(j.indexOf("?")>-1?"&":"?")+f._getCityInfo()),f._pushWindow({url:j,showToolBar:!0});else{var k=c.lib.translateNativeSchema2Ddid(j),l={push:{ddid:k,obj:{referer:"index"}}};c.lib.ddState(l)}}},_pushWindow:function(a){o.push("pushWindow",a)},_searchHandler:function(){var a=this;if(!a.city_data.cityId)return void c.ui.toast("请先选择城市");var b="search/index",d={push:{ddid:b,obj:{referer:"index"}}};c.lib.ddState(d)},_boxItemHandler:function(b,d){var e,f=this,g=a(d).attr("data-id"),h=f._homeBannerList;if(g&&(e=h[g])){var i=a.trim(e.url);if(i)if(/^http:\/\//.test(i))f._getCityInfo()&&(i+=(i.indexOf("?")>-1?"&":"?")+f._getCityInfo()),f._pushWindow({url:i,showToolBar:!0});else{var j=c.lib.translateNativeSchema2Ddid(i);c.lib.ddState({push:{ddid:j,obj:{referer:"index"}}})}}},_userGet:function(){lib.mtop.request({api:"mtop.dd.user.get",v:"1.0",data:{},extParam:{}},function(b){var c=b.data;(parseInt(c.dd)||parseInt(c.waimai)||parseInt(c.unuseCount)||parseInt(c.unpayCount)||parseInt(c.unprizeCount))&&a("#J_undo_point").show()},function(a){c.ui.toast(a)})},_cityClick:function(){var b=a("#J_index_city").parent();c.lib.ddState({push:{ddid:b.data("swipeid"),obj:{referer:b.data("referer")}}})},_cityReset:function(){var b=this;if(e=+new Date,!(j=c.lib.localStorage.get("current_city")))return b.home_activity_wrap.html(c.ui.tpl.geo),k.addEventListener("click",c.lib.preventAllClick,!0),void c.lib.getH5Geo({callback:function(a){k.removeEventListener("click",c.lib.preventAllClick,!0),a.latitude?b._cityReset():(b.pid&&c.sendImage({city:+new Date},b.pid),c.lib.ddState({push:{ddid:"city"}}))}});var d=b.city_data.cityId||"";return b.city_data=j||c.lib.memCache.get("geo_location")||{},b.index_search_data.city_data=b.city_data,c.lib.memCache.set("index_search_data",b.index_search_data),a("#J_index_city").text(b.city_data.cityName||"城市").parent().addClass("J_swipe_page"),o.supportFunc("setOptionMenu")&&o.push("setOptionMenu",{title:b.city_data.cityName||"城市"},function(){}),c._hideTitleBar&&o.push("setTitle",{title:"淘点点"}),b.city_data.cityId?void(d!==b.city_data.cityId?(b._getActsInfo(),b._getDDResource()):this.carouseScroll&&this._carouselInit()):void b._buildActs({})},_getActsInfo:function(){var b,d=this,e=c.lib.memCache.get("geo_location");f=+new Date,b=function(){lib.mtop.request({api:"mtop.life.diandian.getActsInfo",v:"2.0",data:{useCity:d.city_data.cityId||0,gpsCity:e?e.cityId:0,bannerType:c.mtop_banner_request.type,clientVersion:c.mtop_banner_request.version},extParam:{}},function(a){var b=a.data;for(var c in b.model)d._bannerList[b.model[c].id]=b.model[c];d._buildActs(b),g=+new Date},function(a){c.ui.toast(a)})},c.mtop_banner_request?b.call(d):a(document).on("cfgReady",function(){b.call(d)})},_getDDResource:function(){var a=this;a.home_activity_wrap.html(c.ui.tpl.load),h=+new Date,lib.mtop.request({api:"mtop.life.diandian.getDDResource",v:"1.0",data:{city:a.city_data.cityId,bundles:"home_menuItem_2.9.2,home_banner_2.9.3"},extParam:{}},function(b){var d=b.data;a._buildResource(d),i=+new Date,c.lib.memCache.set("city_list",b.data.cityList)},function(b){c.ui.toast(b,a)})},_buildActs:function(b){var d=this;b.width=a("#J_page").width();var e=c.ui.tmpl(a("#J_tpl_index_banner").html(),{data:b});d.wrap.find("#J_home_banner").html(e),d.pid&&c.sendImage({act:+new Date},d.pid);var f=a("#J_index_carousel_wrap");d.indicator=a("#J_index_indicator"),d.carousel_options={wrap:f,max:f.find("li").length,interval:5e3},b.model&&b.model.length>1&&(d._carouselInit(),d.carousel_timer=void 0)},_buildResource:function(b){var d=this,e=b["city_"+d.city_data.cityId],f=e?e["home_banner_2.9.3"]:[],g=e?e["home_menuItem_2.9.2"]:[];for(var h in f){f[h].id="card"+h;var i=f[h].pic;i+=-1!=i.indexOf(".jpg")?"_q30.jpg":"",f[h].pic=i.replace(/gtms0(1|2|3|4).alicdn.com/,"g.dd.alicdn.com"),d._homeBannerList[f[h].id]=f[h]}var j=f.length?c.ui.tmpl(n.html(),{home_banner:f}):'<div class="empty_card"><img src="http://g.dd.alicdn.com/tps/i2/TB1lSa4FFXXXXX3aXXXXD.cNVXX-400-200.png" alt=""/></div>';if(d.home_activity_wrap.html(j),d.pid&&c.sendImage({card:+new Date},d.pid),g.length){var h=0;d.home_menu_wrap.children().each(function(){a(this).find(".J_menu_intro").text(g[h].name),h++})}d._iScrollInit()},_carouselInit:function(){var b=this;b.carouseScroll&&(b.carouseScroll.kill()||(b.carouseScroll=null)),b.carouseScroll=Swipe(a("#J_index_carousel_wrap").children()[0],{auto:5e3,transitionEnd:function(c,d){b._carouselImgLoad(a(d)),b._carouselIndicators(c)}}),b._carouselIndicators(0)},_carouselImgLoad:function(a){if(a.length){var b=a.children();b.attr("data-original")&&(b.attr("style","background-image:url("+b.attr("data-original")+")"),b.removeAttr("data-original"))}},_carouselIndicators:function(a){var b=this,c=9*a;b.indicator.children()[0].style.webkitTransform="translate3d("+c+"px, 0, 0)"},_iScrollInit:function(){}}}var e,f,g,h,i,j,k=b.document.body,l=a("#J_index"),m=a("#J_tpl_index"),n=a("#J_tpl_index_activity"),o=b.bridge,p=(a("#J_bottom_panel"),b.History);c.app.Index=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:f,init:function(){var a=this,b=i.getState().url,c=/m.taobao.com/.test(b)?"login.m.taobao.com":/wapptest.taobao.com/.test(b)?"login.wapptest.taobao.com":/wapa.taobao.com/.test(b)?"login.wapa.taobao.com":"";
a.logout_url="http://"+c+"/logout.htm?tpl_redirect_url="+encodeURIComponent(b),a.options={dd:{},tc:{}},a.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){var a=this;if(c._hideTitleBar)try{a.wrap.find(".hd_title").find("h2")&&!a._titleLazy&&e.push("setTitle",{title:a.wrap.find(".hd_title").find("h2").html()||"淘点点"})}catch(b){console.log(b)}},_renderStatic:function(){var a=this,b=c.ui.tmpl(g.html(),{swipeid:i.getState().data.referer||"index"});a.wrap.html(b),a.wrap.find("#J_my_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;a._buildTmpl(),e.push("login",function(){a._getMyInfo()})},_getMyInfo:function(){var a=this;lib.mtop.request({api:"mtop.dd.user.get",v:"1.1",data:{},extParam:{}},function(b){var d=b.data;d&&(d.pic&&-1!=d.pic.indexOf(".jpg")&&(d.pic+="_120x120.jpg"),c.lib.localStorage.set("nick_name",d.nick),c.lib.localStorage.set("nick_pic",d.pic),a.options.dd={dd:parseInt(d.dd)||"",waimai:parseInt(d.waimai)||"",unpayCount:parseInt(d.unpayCount)||"",unuseCount:parseInt(d.unuseCount)||"",nick:d.nick,reserveCount:parseInt(d.reserveCount),pic:d.pic,logout:a.logout_url},a._buildTmpl())},function(b){c.ui.toast(b,a)})},_buildTmpl:function(){var a=this;a.startUp(),a._iScrollInit()},events:[[c.event.click,".J_my_item","_itemHandler"],[c.event.click,".J_my_login","_loginHandler"],[c.event.click,".J_my_logout","_loginOutHandler"]],startUp:function(){var a,b,d=this,e=lib.login.getNickFromCookie();a=c.lib.localStorage.get("nick_name"),b=c.lib.localStorage.get("nick_pic"),a!==e&&(b=a=null),d.options.dd=d.options.dd||{},d.options.dd.nick=d.options.dd.nick||a||"",d.options.dd.pic=d.options.dd.pic||b||"http://g.dd.alicdn.com/tps/i1/T1x1VXFLBeXXaiKCsI-120-120.png";var f=c.ui.tmpl(h.html(),d.options);d.wrap.find("#J_my_content").html(f)},_loginHandler:function(){var b=this;e.push("login",function(){a("#J_my").removeAttr("data-ddid"),b._renderDynamic()})},_loginOutHandler:function(){var a=location.href;location.href="http://login.m.taobao.com/logout.htm?tpl_redirect_url="+encodeURIComponent(a)},_itemHandler:function(b,d){var f=this,g=a(d),h=g.attr("data-swipeid");e.push("login",function(b){if(b&&(b.success||b.loginResult)){a("#J_"+h).removeAttr("data-ddid");var d={push:{ddid:h}};c.lib.ddState(d)}else f._getMyInfo(),f._myChildPush(h)})},_myChildPush:function(a){c.lib.ddState({push:{ddid:a,obj:{referer:"my"}}})},_iScrollInit:function(){},_pullDownAction:function(){this._renderDynamic()}}}var e=b.bridge,f=a("#J_my"),g=a("#J_tpl_my"),h=a("#J_tpl_my_content"),i=b.History;c.app.My=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(){var a=this;a.pullup_el=void 0,a.initHandler()},initHandler:function(){this._renderStatic()},_renderStatic:function(){var a=c.ui.tmpl(f.html(),{});e.html(a)}}}{var e,e=(b.bridge,a("#J_my_customer_service")),f=a("#J_tpl_my_customer_service");b.History}c.app.MyCustomerService=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:g,init:function(){var a=this;a.pullup_el=void 0,a.deliveryList=a.deliveryList||{},a.page={pz:10,p:1,total:0,pTotal:1},a.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},_renderStatic:function(){var a=this,b={swipeid:j.getState().data.referer||"my"},d=c.ui.tmpl(h.html(),b);g.html(d),e=g.find("#J_my_delivery_content").html(c.ui.tpl.load),a.pullup_el=g.find(".J_pullUp")},_renderDynamic:function(){var a=this;f.push("login",function(){a._getMyDelivery("refresh")})},_getMyDelivery:function(a){var b=this;lib.mtop.request({api:"mtop.life.diandian.getWaimaiOrderListForBuyer",v:"1.0",data:{pz:b.page.pz,p:b.page.p},extParam:{}},function(c){var d=c.data;if(d){b.page.total=d.total,b.page.pTotal=Math.ceil(parseInt(d.total)/b.page.pz);var e;if(e=d.orders)for(var f=0;f<e.length;f++)b.deliveryList[e[f].orderId]=e[f],"0"!==e[f].endSeconds&&(d.orders[f].endTime=b._MillisecondToDate(1e3*parseFloat(e[f].endSeconds)));b._buildList(a,d)}},function(a){c.ui.toast(a,b)})},_buildList:function(a,b){var d=this,f=c.ui.tmpl(i.html(),b);"refresh"==a&&(e.html(""),d.page.p=1),d.startUp(f),"refresh"==a&&d._iScrollInit(),d._manualHandler()},startUp:function(a){e.append(a)},events:[[c.event.click,".J_order_item","_itemHandler"],[c.event.click,".J_my_delivery_options","_optionsHandler"]],_itemHandler:function(b,d){if(!/J_my_delivery_options/.test(b.target.className)){a("#J_my_delivery_details").removeAttr("data-ddid");var e=a(d).data("swipeid");c.lib.ddState({push:{ddid:e,obj:{referer:"my"}}})}},_optionsHandler:function(b,c){var d=this,e=a(c).data("role");switch(e){case"close":d._orderClose(a(c));break;case"refund":d._applyForRefund(a(c));break;case"review":d._applyForReview(a(c));break;case"receipt":d._orderPay(a(c));break;case"pay":d._orderPay(a(c))}},_applyForReview:function(a){var b=a.data("swipeid");c.lib.ddState({push:{ddid:b,obj:{referer:"my_delivery"}}})},_applyForRefund:function(b){a("#J_my_delivery_details").removeAttr("data-ddid");var d=b.data("swipeid");c.lib.ddState({push:{ddid:d,obj:{referer:"my_delivery"}}})},_manualHandler:function(){{var a=this,b=a.page;b.type}b.pTotal>1&&b.p<b.pTotal?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn"),a.mainScroll.refresh()},_orderClose:function(a){var b=this;this.async||(this.async=!0,f.push("confirm",{title:"",message:"确定要取消该订单吗？",okButton:"确定",cancelButton:"取消"},function(d){d.ok?(c.ui.toast.loading(),lib.mtop.request({api:"mtop.life.diandian.closeOrder",v:"1.0",data:{orderId:a.data("id"),isSeller:0,reason:"淘点点-取消订单"}},function(d){d.data&&a.parent(".operat").html("交易关闭"),c.ui.toast.hide(),b.async=!1},function(a){c.ui.toast(a),b.async=!1})):b.async=!1}))},_orderPay:function(a){var b=this,d=b.deliveryList,e=a.data("id"),g=d&&d[e];this.async||(this.async=!0,!f.supportFunc("tradePay")&&c.ui.toast.loading(),f.supportFunc("tradePay")?f.push("tradePay",{tradeNO:a.attr("data-alipay")},function(a){a.resultCode&&9e3==parseInt(a.resultCode)&&b.initHandler(),b.async=!1}):f.supportFunc("tradePay")?f.push("tradePay",{tradeNO:a.attr("data-alipay")},function(a){a.resultCode&&9e3==parseInt(a.resultCode)&&b.initHandler(),b.async=!1}):lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:a.data("id"),payType:g&&"12"==g.status?1:0}},function(a){if(a.data&&"true"==a.data.canPay){if(c.device.isAndroid&&c.device.version.android<4)return void(location.href=a.data.alipayUrl);c.ui.alipay({title:g&&"12"==g.status?"确认收货":"支付",optionMenu:g&&"12"==g.status?"已确认":"支付完成",alipayUrl:a.data.alipayUrl,successFunc:function(){b.initHandler()}})}c.ui.toast.hide(),b.async=!1},function(a){c.ui.toast(a),b.async=!1}))},_MillisecondToDate:function(a){var b=parseFloat(a)/1e3;return b&&(b>60&&3600>b?b=parseInt(b/60)+"分钟":b>=3600&&86400>b&&(b=parseInt(b/3600)+"小时"+parseInt(60*(parseFloat(b/3600)-parseInt(b/3600)))+"分钟")),b||0},_iScrollInit:function(){var a=this;a.mainScroll=c.ui._scroll({wrap:"#J_my_delivery_scroll",pullUpAction:function(){a.page.p++,a._getMyDelivery("add")}})}}}var e,f=b.bridge,g=a("#J_my_delivery"),h=a("#J_tpl_my_delivery"),i=a("#J_tpl_my_delivery_list"),j=b.History;c.app.MyDelivery=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{details_data:{},wrap:e,init:function(a){var b=this;b.id=a,b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){h.supportFunc("setOptionMenu")&&h.push("setOptionMenu",{icon:c.config.option_menu_icon.share})},_renderStatic:function(){e.html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getTcOrderDetail",v:"1.0",data:{oid:a.id}},function(b){b.data&&(a.payType=b.data.status&&"12"==b.data.status?1:0,a.details_data["d_"+a.id]=b.data,a._buildTmpl(b.data),c._hideTitleBar&&h.push("setTitle",{title:a.wrap.find(".hd_title").find("h2").html()||"淘点点"}))},function(b){c.ui.toast(b,a)})},_buildTmpl:function(a){var b=this,d=c.ui.tmpl(f.html(),{data:a,swipeid:g.getState().data.referer||"my_delivery"});e.html(d),b.orderId=a.orderId},menuEvent:"_shareMenu",events:[[c.event.click,"#J_my_delivery_details_pay","_payHandler"],[c.event.click,"#J_my_delivery_details_confirm","_payHandler"],[c.event.click,"#J_my_delivery_details_cancel","_cancelHandler"],[c.event.click,".J_Share","_shareMenu"],[c.event.click,".J_devlivery_order_review","_orderReview"]],_orderReview:function(b,d){var e=a(d).data("orderid");c.lib.ddState({push:{ddid:"review/"+e,obj:{referer:"my_delivery"}}})},_payHandler:function(){var a=this,b=a.details_data["d_"+a.id];this._doPay(b)},_cancelHandler:function(){var a=this;h.push("confirm",{title:"",message:"确定要取消该订单吗？",okButton:"确定",cancelButton:"取消"},function(b){b.ok&&(lib.mtop.request({api:"mtop.life.diandian.closeOrder",v:"1.0",data:{orderId:parseInt(a.orderId),isSeller:0,reason:"淘点点-取消订单"}},function(){a.initHandler()},function(b){c.ui.toast(b,a)}),a.willUpdateMyDeliveryList())})},_doPay:function(a){var b=this;b.async||(b.async=!0,!h.supportFunc("tradePay")&&c.ui.toast.loading(),h.supportFunc("tradePay")?h.push("tradePay",{tradeNO:a.alipay},function(a){a.resultCode&&9e3==parseInt(a.resultCode)&&(b.initHandler(),b.willUpdateMyDeliveryList()),b.async=!1}):lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:b.id,payType:b.payType}},function(a){if("true"==a.data.canPay){if(c.device.isAndroid&&c.device.version.android<4)return location.href=a.data.alipayUrl,void b.willUpdateMyDeliveryList();c.ui.alipay({title:b.payType?"确认收货":"支付",optionMenu:b.payType?"已确认":"支付完成",alipayUrl:a.data.alipayUrl,successFunc:function(){delete b.details_data["d_"+b.id],b.initHandler()}})}c.ui.toast.hide(),b.async=!1,b.willUpdateMyDeliveryList()},function(){c.ui.toast.hide(),b.async=!1}))},willUpdateMyDeliveryList:function(){a("#J_my_delivery").removeAttr("data-ddid")},_shareMenu:function(){var a=this;h.push("share",{title:"淘点点外卖",content:"淘点点的外卖，嗷嗷给力！",image:"http://gtms03.alicdn.com/tps/i3/T1PcyJFDpaXXbYfSkc-640-1738.png",url:c.config.share.jump+"menu_takeoutid!/"+a.details_data["d_"+a.id].shopId})}}}var e=a("#J_my_delivery_details"),f=a("#J_tpl_my_delivery_details"),g=b.History,h=b.bridge;c.app.MyDeliveryDetails=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:f,init:function(b){var d=this;d.id=b,f.html(c.ui.tpl.load),d._getOrderData(),a(document).on("tplDomRenderEnd",function(){d._selectInitParam(),d._selectBindEvent(),c._hideTitleBar&&e.push("setTitle",{title:d.wrap.find(".hd_title").find("h2").html()||"淘点点"})})},events:[[c.event.click,"#J_all_select","_checkboxHandler"],[c.event.click,".J_checkbox_option","_checkboxOptionHandler"],[c.event.click,".J_footer_selector","_selectOpen"],[c.event.click,"#J_my_delivery_refund_submit","_submitRefundHandler"],[c.event.click,"#J_my_delivery_refundes","_inputFocusHandler"]],setAfterPageOut:function(){a(document).unbind("createSelect"),a(document).unbind("tplDomRenderEnd"),a("#J_my_delivery_refund").removeAttr("data-ddid")},_inputFocusHandler:function(){},_checkData:function(){var a=this;return a.totle?a.popBarSelector.data("value")?!0:(c.ui.toast("请选择退款原因"),!1):(c.ui.toast("请选择要退款的菜品"),!1)},_submitRefundHandler:function(){var b=this;b._checkData()&&lib.mtop.request({api:"mtop.life.diandian.refundOrder",v:"1.0",data:{ids:b.ids,reasonId:b.popBarSelector.data("value"),"self.popBarSelector":a("#J_my_delivery_refundes").text()}},function(a){a.data&&(c.ui.toast("申请退款已提交成功"),b.willUpdateMyDeliveryList(),c.lib.ddState({replace:{ddid:"my_delivery_details/"+b.id}}))},function(a){c.ui.toast(a,b)})},_getOrderData:function(){var b=this;lib.mtop.request({api:"mtop.life.diandian.getTcOrderDetail",v:"1.0",data:{oid:b.id,refund:1}},function(c){c.data&&(b._buildTmpl(c.data),a(document).trigger("tplDomRenderEnd"))},function(a){c.ui.toast(a,b)})},_buildTmpl:function(a){var b=this,d=c.ui.tmpl(g.html(),{data:a,swipeid:h.getState().data.referer||"my_delivery"});f.html(d),b.orderId=a.orderId},_checkboxHandler:function(b,c){var d=a(c).find(".checkbox_default").hasClass("selected"),e=a("#J_my_delivery_refund .checkbox_default").not(".disabled");d?e.removeClass("selected"):e.addClass("selected"),this._calculateSeletedResult()},_isAllSeleted:function(){var b=a("#J_my_delivery_refund .J_checkbox_option .checkbox_default").not(".disabled").not(".visibility"),c=a("#J_all_select .checkbox_default"),d=!0;a.each(b,function(b,c){a(c).hasClass("selected")||(d=!1)}),d?c.addClass("selected"):c.removeClass("selected")},_checkboxOptionHandler:function(b,c){var d=a(c).find(".checkbox_default").not(".disabled"),e=d.hasClass("selected");e?d.removeClass("selected"):d.addClass("selected"),this._calculateSeletedResult(),this._isAllSeleted()},_calculateSeletedResult:function(){var b=this,c=a("#J_my_delivery_refund .checkbox_default.selected"),d=0,e="",f=a("#J_footer_total_bar");a.each(c,function(b,c){a(c).data("item-total")&&(d+=a(c).data("item-total"),e+=a(c).data("item-id")+",")}),a("#J_refund_total").html(d.toFixed(2)),d?f.removeClass("hide"):f.addClass("hide"),b.totle=d.toFixed(2),b.ids=e},_selectInitParam:function(){var b=this,c=a(".J_footer_select_mask");b.popBarNode=a("#J_footer_select_bar"),b.markupNode=c[0]?c:a('<div class="footer_select_mask J_footer_select_mask hide"></div>'),b.popBarNodeHeight=this.popBarNode.height()+a(".J_footer_select_close").height()/2,b.popBarSelector=a(".J_footer_selected_option"),b.radiOptionNode=a(".J_select_radio_option"),b.selectCloseNode=a(".J_footer_select_close"),c[0]||a(document.body).append(b.markupNode).append(b.popBarNode)},_selectDestroy:function(){this.markupNode.unbind("click"),this.radiOptionNode.unbind("click"),this.selectCloseNode.unbind("click")},_selectClose:function(){var a=this;a.markupNode.on("webkitTransitionEnd",function(){a.popBarNode.css("visibility","hidden"),a.markupNode.addClass("hide").unbind("webkitTransitionEnd")}),b.setTimeout(function(){a.markupNode.removeClass("opacity"),a.popBarNode.css({"-webkit-transition-duration":".3s","-webkit-transform":"translate3d(0,0,0)"})},0),a._selectDestroy()},_selectOpen:function(){var d=this,e=a(document.body).height()+a(document.body).scrollTop();c.ui.toast.hide(),d.popBarNode.css("bottom","-"+d.popBarNodeHeight+"px"),d.popBarNode.css("visibility","visible"),d.markupNode.height(e).removeClass("hide"),b.setTimeout(function(){d.markupNode.addClass("opacity"),d.popBarNode.css({"-webkit-transition-duration":".3s","-webkit-transform":"translate3d(0, -"+d.popBarNodeHeight+"px, 0)"})},0),d.radiOptionNode.on("click",function(a){d._selectRadioOption(a)}),d.selectCloseNode.on("click",function(){d._selectClose()}),d.markupNode.on("click",function(){d._selectClose()})},_selectRadioOption:function(b){var c=this,d=a(b.currentTarget).find(".radio_default"),e=d.hasClass("selected");e?d.removeClass("selected"):(d.parents(".footer_select_content").find(".selected").removeClass("selected"),d.addClass("selected"),c.popBarSelector.text(a(b.currentTarget).text()).data("value",a(b.currentTarget).data("value"))),c._selectClose()},willUpdateMyDeliveryList:function(){a("#J_my_delivery").removeAttr("data-ddid")},_selectBindEvent:function(){}}}var e=b.bridge,f=a("#J_my_delivery_refund"),g=a("#J_tpl_my_delivery_refund"),h=b.History;c.app.MyDeliveryRefund=function(){return new d}}(Zepto,window,window.dd),function(a,b){function c(){return{wrap:f,init:function(){var a=this;a.asnyc=!1,a.pullup_el=void 0,a.page={limit:"20",type:"1",total_t1:0,total_t2:0,pages_t1:0,pages_t2:0,page_current_t1:1,page_current_t2:1,quan:{limit:20,type:1,page_current:1,total:1,pages:0,role:"init"},hb:{limit:100,type:2,page_current:1,total:1,pages:0,role:"init"},card:{limit:20,type:3,page_current:1,total:1,pages:0,role:"init"}},a.type="quan",a.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},_renderStatic:function(){var a=this,b={},c=dd.ui.tmpl(g.html(),b);f.html(c),d=f.find("#J_my_evoucher_list"),d.find("#J_my_elist_quan").html(dd.ui.tpl.load),a.pullup_el=f.find(".J_pullUp")},_renderDynamic:function(){var a=this;e.push("login",function(){a._pageDispatch()})},_pageDispatch:function(){var a=this;"quan"==a.type?a._getMyListEoucher():"card"==a.type?a._getMyListCard():"hb"==a.type&&a._getMyListHb()},events:[[dd.event.click,".J_my_tab_ul li","_liHandler"],[dd.event.click,"#J_hb_intro","_pushHbIntro"]],_liHandler:function(b,c){var e=this,f=a(c);if(!e.asnyc&&!f.hasClass("current")){f.addClass("current").siblings(".current").removeClass("current"),e.type=f.data("type");var g=d.find("#J_my_elist_"+e.type);g.html()?(g.show().siblings().hide(),e._switchHandler()):(g.html(dd.ui.tpl.load),g.show().siblings().hide(),e.pullup_el.addClass("dn"),e.page[e.type].role="init",e._pageDispatch())}},_pushHbIntro:function(){e.push("pushWindow",{url:"http://market.m.taobao.com/market/diandian/app-hb-intro.php",showToolBar:!0})},_getMyListEoucher:function(){var a=this;a.asnyc=!0,lib.mtop.request({api:"mtop.dd.voucher.user.list",v:"1.0",data:{type:a.page.quan.type,limit:a.page.quan.limit,offset:(parseInt(a.page.quan.page_current)-1)*parseInt(a.page.quan.limit)},extParam:{}},function(b){var c=b.data;c&&(a.page.quan.total=c.total,a.page.quan.pages=Math.ceil(parseInt(c.total)/a.page.quan.limit),a._buildTpl(c)),a.asnyc=!1},function(b){dd.ui.toast(b,a),a.asnyc=!1,a._pageMinus()})},_getMyListCard:function(){var a=this;a.asnyc=!0,a.geo_location=dd.lib.memCache.get("geo_location")||{},lib.mtop.request({api:"mtop.life.diandian.getMyMemberCardList",v:"1.0",data:{pageSize:a.page.card.limit,pageNo:a.page.card.page_current,latitude:a.geo_location.longitude||0,longitude:a.geo_location.latitude||0},extParam:{}},function(b){var c=b.data;a.page.card.total=parseInt(c.total),a.page.card.pages=Math.ceil(a.page.card.total/a.page.card.limit),a._buildTpl(c),a.asnyc=!1},function(b){dd.ui.toast(b,a),a.asnyc=!1,a._pageMinus()})},_getMyListHb:function(){var a=this;a.asnyc=!0,lib.mtop.request({api:"mtop.dd.ticket.evoucher.list",v:"1.1",data:{type:a.page.hb.type,limit:a.page.hb.limit,offset:(parseInt(a.page.hb.page_current)-1)*parseInt(a.page.hb.limit),status:"0"},extParam:{}},function(b){var c=b.data;c&&(a.page.hb.total=c.total,a.page.hb.pages=Math.ceil(parseInt(c.total)/a.page.hb.limit),a._buildTpl(c)),a.asnyc=!1},function(b){dd.ui.toast(b,a),a.asnyc=!1,a._pageMinus()})},_pageMinus:function(){"init"!==_this.page[_this.type].role&&_this.page[_this.type].page_current--},_buildTpl:function(a){var b=this,c=b.page[b.type].role;"init"==c&&b._iScrollInit();var e="quan"==b.type?h.html():"card"==b.type?i.html():"hb"==b.type?j.html():h.html(),f=dd.ui.tmpl(e,a),g=d.find("#J_my_elist_"+b.type);"init"==c&&(g.html(""),b.page[b.type].page_current=1),g.append(f).show(),b._switchHandler()},_switchHandler:function(){var a=this,b=a.page,c=a.type;b[c].pages>1&&b[c].page_current<b[c].pages?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn"),a._scroll.refresh()},_iScrollInit:function(){var a=this;this._scroll=dd.ui._scroll({wrap:"#J_my_evoucher_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullUpAction:function(){var a=this,b=a.page,c=a.type;b[c].page_current++,b[c].role="add",a._pageDispatch()}}}var d,e=b.bridge,f=a("#J_my_evoucher"),g=a("#J_tpl_my_evoucher"),h=a("#J_tpl_my_evoucher_list"),i=a("#J_tpl_my_card_list"),j=a("#J_tpl_my_hb_list");dd.app.MyEvoucher=function(){return new c}}(Zepto,window,document),function(a,b,c){function d(){return{wrap:f,init:function(a){var b=this;b.id=a,b.data=void 0,b.initHandler()},initHandler:function(){f.html(c.ui.tpl.load),this._renderDynamic()},_renderDynamic:function(){var a=this;a.geo_location=c.lib.memCache.get("geo_location")||{},a.startUp(a.geo_location)},startUp:function(a){var b=this;a&&a.latitude&&a.longitude&&(b.showDistance=!0),lib.mtop.request({api:"mtop.dd.voucher.user.detail",v:"1.0",data:{voucherId:b.id,latitude:a&&a.latitude,longitude:a&&a.longitude}},function(d){if(d.data){if(b.data=d.data,b.data.showDistance=b.showDistance,b.showDistance&&b.data.localstores&&b.data.localstores.length){var h=c.lib.geoDistance({latitude:a.latitude,longitude:a.longitude},{latitude:b.data.localstores[0].latitude,longitude:b.data.localstores[0].longitude});h=(h/1e3).toFixed(1)+" 千米",b.data.nearDis=h}var i=c.ui.tmpl(g.html(),{data:b.data});f.html(i),e.push("setTitle",{title:b.wrap.find(".hd_title").find("h2").html()||"淘点点"})}},function(a){c.ui.toast(a,b)})},_geo:function(){var a=this;c.lib.getH5Geo({callback:function(b,d){return c.lib.memCache.get("city_list")?void a.startUp(b):void c.ui.toast(d,a)}})},events:[[c.event.click,".J_evoucher_use","_evoucherUseHandler"],[c.event.click,".J_pop_store_item","_popStoreItemUseHandler"],[c.event.click,".J_evoucher_refund","_applyRefund"],[c.event.click,".evoucher_address","_pushMap"],[c.event.click,".J_shoplist","_pushShoplist"]],_pushMap:function(b,d){var e=this,f=a(d).data("referer");if(f){var g="address_map/show";f=f.split(";"),a("#J_address_map").removeAttr("data-ddid");var h={push:{ddid:g,obj:{data:{posx:f[1],posy:f[0]},referer:"store/"+e.storeid}}};c.lib.ddState(h)}},_pushShoplist:function(){var a=this;c.lib.ddState({push:{ddid:"my_evoucher_shoplist",obj:{list:a.data.localstores,referer:"my_evoucher_details/"+a.data.instanceId}}})},_evoucherUseHandler:function(){var b=this,d=b.data.localstores;if(d.length>1){var e=[],f=[],g={};a.each(d,function(a,d){var e=c.lib.geoDistance(b.geo_location,{longitude:d.longitude,latitude:d.latitude});f.push(e||a);var h;h=e>1e3?e/1e3>100?">100千米":c.lib.num2Fixed(e/1e3,1)+"千米":0==e?"":parseInt(e)+"米",g[e||a]='<li class="J_pop_store_item" data-storeid="'+d.localstoreId+'"><div class="shop_name">'+d.localstoreName+"<span>"+h+'</span></div><div class="shop_address">'+d.address+"</div></li>"}),f.sort(function(a,b){return a-b}),a.each(f,function(a,b){e.push(g[b])}),h=c.ui.dialog({cls:"evoucherpop",title:"确定您所在的门店",wrap:"#J_my_evoucher_details",content:'<ul class="pop_shop_list">'+e.join("")+"</ul>",maxheight:"300"})}else"entity"==b.data.itemType?b._pushConvert(d[0].localstoreId):"takeout"==b.data.itemType?b._pushTakeout(b.data.localstoreId):b._pushPay(d[0].localstoreId)},_popStoreItemUseHandler:function(b,c){var d=this;"entity"==d.data.itemType?d._pushConvert(a(c).data("storeid")):"takeout"==d.data.itemType?d._pushTakeout(a(c).data("storeid")):(h.hide(),h={},this._pushPay(a(c).data("storeid")))},_applyRefund:function(){var b=this;e.push("confirm",{title:"提示？",message:"退款申请一旦提交，该券将不能恢复！",okButton:"确认退款",cancelButton:"取消"},function(d){d.ok&&lib.mtop.request({api:"mtop.dd.ticket.evoucher.refund",v:"1.0",data:{id:b.id}},function(c){"true"==c.data.result&&(e.push("alert",{title:"提示",message:"退款申请已提交",buttons:["确定"]}),b.initHandler(),a("#J_my_evoucher").removeAttr("data-ddid"))},function(a){c.ui.toast(a,b)})})},_pushPay:function(a){var b=this;e.push("confirm",{title:"确定使用本券？",message:"请确保您已在店内！",okButton:"使用",cancelButton:"不使用"},function(d){d.ok&&c.lib.ddState({push:{ddid:"pay_detail/"+a,obj:{referer:"my_evoucher_details/"+b.id}}})})},_pushConvert:function(a){var b=this;e.push("confirm",{title:"确定使用本券？",message:"请确保您已在店内！",okButton:"使用",cancelButton:"不使用"},function(d){d.ok&&(c.ui.toast.loading(),lib.mtop.request({api:"mtop.dd.ticket.evoucher.convert",v:"1.0",data:{id:b.id,localstoreid:a}},function(a){a.data&&("true"==a.data.result&&(alert("兑换券使用成功，请和服务员确认！"),b.initHandler()),c.ui.toast.hide())},function(a){c.ui.toast(a,b)}))})},_pushTakeout:function(a){var b=this;c.lib.ddState({push:{ddid:"carte/delivery/"+a,obj:{referer:"my_evoucher_details/"+b.id}}})}}}var e=b.bridge,f=a("#J_my_evoucher_details"),g=a("#J_tpl_my_evoucher_details"),h={};c.app.MyEvoucherDetails=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(){var a=this;a.initHandler()},initHandler:function(){e.html(c.ui.tpl.load),this._renderDynamic()},_renderDynamic:function(){var a=this,b=!1;a.state=g.getState();var d,h=a.state.data;if(a.geo_location=c.lib.memCache.get("geo_location")||{},a.geo_location&&a.geo_location.latitude&&a.geo_location.longitude&&(b=!0),h.hasLocated=b,b&&(d=h.list))for(var i=0;i<d.length;i++){var j=d[i];if(j.longitude&&j.latitude){var k=c.lib.geoDistance({latitude:j.latitude,longitude:j.longitude},{latitude:a.geo_location.latitude,longitude:a.geo_location.longitude});k=(k/1e3).toFixed(1)+" 千米",j.dis=k}}var l=c.ui.tmpl(f.html(),h);e.html(l)},events:[[c.event.click,".evoucher_address","_pushMap"]],_pushMap:function(b,d){var e=this,f=a(d).data("referer");if(f){var g="address_map/show";f=f.split(";"),a("#J_address_map").removeAttr("data-ddid");var h={push:{ddid:g,obj:{data:{posx:f[1],posy:f[0]},referer:"store/"+e.storeid}}};c.lib.ddState(h)}}}}var e=(b.bridge,a("#J_my_evoucher_shoplist")),f=a("#J_tpl_my_evoucher_shoplist"),g=b.History;c.app.MyEvoucherShopList=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:f,init:function(){var a=this;a.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){var a=this;if(c._hideTitleBar)try{a.wrap.find(".hd_title").find("h2")&&!a._titleLazy&&e.push("setTitle",{title:a.wrap.find(".hd_title").find("h2").html()||"淘点点"})}catch(b){console.log(b)}},setBeforePageOut:function(){var a=document.getElementById("fd_text");a&&a.blur()},_renderStatic:function(){var a=this,b=c.ui.tmpl(g.html());a.wrap.html(b),e.supportFunc("setOptionMenu")&&e.push("setOptionMenu",{title:"发送"},function(){})},_renderDynamic:function(){},menuEvent:"_checkFeedBack",_sendFeedBack:function(a){var b,d=this;if(b=c.device){var e,f,g=c._env?"0":"1",h=b.nw||"none",i=b.rl;if(b.version)for(var j in b.version)b.version[j]&&(e=b.version[j],f=j);a.info=[g,e,f,"",h,i].join(":")}lib.mtop.request({api:"com.taobao.client.user.feedback",v:"*",data:{content:a.content,appInfo:"1:7.11:::wifi:640x1136",apptype:"dd_h5"},extParam:{}},function(a){a.ret&&a.ret[0]&&-1!=a.ret[0].indexOf("SUCCESS")?(c.ui.toast("反馈成功"),c.lib.ddState({push:{ddid:"my",obj:{referer:"my_feedback"}}})):c.ui.toast("反馈失败，请重试")},function(a){c.ui.toast(a,d)})},events:[[c.event.click,"#J_send_fd","_checkFeedBack"],[c.event.click,"#fd_text","_focusText"]],_focusText:function(a){var b=a.target;b&&b.focus()},_checkFeedBack:function(){var a,b=this,d={},e=document.getElementById("fd_text");return e&&(a=e.value),(a=a.replace(/^\s+|\s+$/gm,""))?(d.content=a,e.blur(),void b._sendFeedBack(d)):void c.ui.toast("请输入内容")}}}var e=b.bridge,f=a("#J_my_feedback"),g=a("#J_tpl_my_feedback");c.app.MyFeedBack=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:h,init:function(){var a=this;a._scroll=void 0,a.asnyc=!1,a.pullup_el=void 0,a.page={ps:"10",type:"7",total_t2:0,total_t7:0,pages_t2:0,pages_t7:0,page_current_t2:1,page_current_t7:1},a.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},_renderStatic:function(){var b=this,d={swipeid:k.getState().data.referer||"my"},j=c.ui.tmpl(i.html(),d);h.html(j),g=a("#J_my_order_list"),e=h.find("#J_my_order_t2_list"),f=h.find("#J_my_order_t3_list").html(c.ui.tpl.load),b.pullup_el=h.find(".J_pullUp")},_renderDynamic:function(){var a=this;l.push("login",function(){a._getMyOrder("refresh")})},_getMyOrder:function(a){var b=this;b.asnyc=!0,lib.mtop.request({api:"mtop.life.diandian.myOrderList",v:"1.0",data:{pn:b.page["page_current_t"+b.page.type],ps:b.page.ps,type:b.page.type}},function(c){var d=c.data;d&&(b.page["total_t"+b.page.type]=d.total,b.page["pages_t"+b.page.type]=Math.ceil(parseInt(d.total)/b.page.ps),b._buildTmpl(a,d)),b.asnyc=!1},function(d){"refresh"!==a&&b.page["page_current_t"+b.page.type]--,c.ui.toast(d,b),b.asnyc=!1})},_buildTmpl:function(a,b){var c=this;c._scroll||c._iScrollInit(),c.startUp(a,b)},startUp:function(b,d){var e=this,f=c.ui.tmpl(j.html(),d),h=g.children().eq(a("#J_my_ul_tree li.current").index());"refresh"==b&&(h.html(""),e.page["page_current_t"+e.page.type]=1),h.append(f).show(),e._switchHandler(),c.ui.toast.hide()},events:[[c.event.click,"#J_my_ul_tree li","_liHandler"],[c.event.click,".J_order_del","_delHandler"],[c.event.click,".J_order_item","_itemHandler"],[c.event.click,".J_order_modify","_modifyHandler"],[c.event.click,".J_order_add","_addHandler"],[c.event.click,".J_order_confirm_high","_confirmHighHandler"]],_liHandler:function(b,d){var e=this,f=a(d);if(!e.asnyc&&!f.hasClass("current")){f.addClass("current").siblings(".current").removeClass("current"),e.page.type=f.data("type");var h=g.children().eq(f.index());h.html()?(h.show().siblings().hide(),e._switchHandler()):(h.html(c.ui.tpl.load),h.show().siblings().hide(),e.pullup_el.addClass("dn"),e._getMyOrder("refresh"))}},_delHandler:function(b,d){var e=this,f=a(d);l.push("confirm",{title:"提示",message:"删除这个点菜单？",okButton:"确定",cancelButton:"取消"},function(a){a.ok&&(c.ui.toast.loading(),lib.mtop.request({api:"mtop.life.diandian.deleteOrder",v:"1.0",data:{orderId:f.parent().data("id")}},function(a){var b=a.data;b&&(f.parents(".my_order_item").remove(),e._scroll.refresh()),c.ui.toast.hide(),e.asnyc=!1},function(a){c.ui.toast(a),e.asnyc=!1}))})},_itemHandler:function(b,d){a("#J_my_order_details").removeAttr("data-ddid");var e=a(d).data("swipeid"),f={push:{ddid:e}};c.lib.ddState(f)},_modifyHandler:function(b,d){c.common.myOrder.modify({orderId:a(d).parent().data("id"),type:"edit"})},_addHandler:function(b,d){var e=a(d).parent();c.common.myOrder.add({orderId:e.attr("data-id"),storeId:e.attr("data-storeid")})},_confirmHighHandler:function(b,d){var e=this,f=a(d).parent();c.common.myOrder.confirmHigh({fromType:c.config.getScanFromTypeByServiceType(f.data("servicetype")),orderId:f.data("id"),storeId:f.data("storeid"),time:f.data("time"),view:e,ddid:"my_order"})},_switchHandler:function(){var a=this,b=a.page,c=b.type;b["pages_t"+c]>1&&b["page_current_t"+c]<b["pages_t"+c]?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn"),a._scroll.refresh()},_iScrollInit:function(){var a=this;this._scroll=c.ui._scroll({wrap:"#J_my_order_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullUpAction:function(){var a=this,b=a.page,c=b.type;b["page_current_t"+c]++,a._getMyOrder("add")}}}var e,f,g,h=a("#J_my_order"),i=a("#J_tpl_my_order"),j=a("#J_tpl_my_order_list"),k=b.History,l=b.bridge;c.app.Myorder=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a){var b=this;b.id=a,b.mainScroll=void 0,b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){g.supportFunc("setOptionMenu")&&g.push("setOptionMenu",{icon:c.config.option_menu_icon.share})},_renderStatic:function(){e.html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;g.push("login",function(){a._getMyOrderDetail()})},_getMyOrderDetail:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.myOrderDetail",v:"1.0",data:{id:a.id,option:c.lib.memCache.get("checkoption")?"1":"0"}},function(b){b.data&&(a.startUp(b.data),g.push("setTitle",{title:a.wrap.find(".hd_title").find("h2").html()||"淘点点"})),c.lib.memCache.removeValue("checkoption")},function(b){c.ui.toast(b,a),c.lib.memCache.removeValue("checkoption")})},startUp:function(a){var b=this;b.data=a;var d=c.ui.tmpl(f.html(),{data:a});e.html(d),b.storeId=a.storeInfo.storeId;var h=c.lib.memCache.get("confirmType");if(h){if(1==h)return b._confirmHighHandler(),void c.lib.memCache.removeValue("confirmType");var i;3==h?i="下单成功，坐等开吃":4==h?i="菜单已保存！请您到店入座后扫描餐桌上的二维码下单":5==h?i="加菜成功":6==h?i="菜单保存成功！到店后请联系服务员下单！":8==h&&(i="菜单已保存！请您到店后扫码支付"),(7==h||3==h)&&g.push("alert",{title:"下单成功！",message:"请联系服务员确认您所点的菜品！",buttons:["确定"]}),c.ui.toast(i),c.lib.memCache.removeValue("confirmType")}2==(2&a.operation)&&5!==(5&h)&&setTimeout(function(){g.push("confirm",{title:"菜单已保存",message:"本店支持预订，是否要提前预订？",okButton:"确定",cancelButton:"取消"},function(a){a.ok&&c.lib.ddState({push:{ddid:"reserve_datelist/"+b.storeId,obj:{referer:"my_order_details/"+b.id}}})})},100)},menuEvent:"_shareMenu",events:[[c.event.click,".J_order_modify","_modifyHandler"],[c.event.click,".J_order_add","_addHandler"],[c.event.click,".J_order_confirm_high","_confirmHighHandler"],[c.event.click,".J_shop_address","_pushMap"],[c.event.click,".J_order_review","_pushReview"],[c.event.click,".J_Share","_shareMenu"]],_modifyHandler:function(b,d){c.common.myOrder.modify({orderId:a(d).data("orderid"),type:a(d).data("type")})
},_addHandler:function(){var a=this;c.common.myOrder.add({orderId:a.id,storeId:a.storeId})},_confirmHighHandler:function(){var a=this;c.common.myOrder.confirmHigh({fromType:c.config.getScanFromTypeByServiceType(a.data.serviceType),orderId:a.data.orderId,storeId:a.data.storeInfo.storeId,time:a.data.createTime,view:a,ddid:"my_order_details"})},_pushMap:function(){var b=this,d="address_map/show";a("#J_address_map").removeAttr("data-ddid");var e={push:{ddid:d,obj:{data:{posx:b.data.storeInfo.x,posy:b.data.storeInfo.y},referer:"store/"+b.storeid}}};c.lib.ddState(e)},_shareMenu:function(){var a=this;g.push("share",{title:"淘点点菜单秀",content:"今天我吃了这些菜，用“淘点点”点菜方便又省钱！你也来试试～",url:c.config.share.jump+"menu_id!/"+a.data.storeInfo.storeId})},_pushReview:function(){var a=this;c.lib.ddState({push:{ddid:"review/"+a.data.orderId,obj:{referer:"my_order_details",orderData:a.data}}})}}}var e=a("#J_my_order_details"),f=a("#J_tpl_my_order_details"),g=b.bridge;c.app.MyOrderDetails=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,my_pay_list:{},init:function(){var a=this;a._scroll=void 0,a.asnyc=!1,a.pullup_el=void 0,a.page={limit:"10",total:0,pages:0,page_current:1},a.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},_renderStatic:function(){var b=this,d={},g=c.ui.tmpl(f.html(),d);e.html(g),my_pay_list=a("#J_my_pay_list").html(c.ui.tpl.load),b.pullup_el=e.find(".J_pullUp")},_renderDynamic:function(){var a=this;i.push("login",function(){a._getMyOrder("refresh")})},_getMyOrder:function(a){var b=this;b.asnyc=!0,lib.mtop.request({api:"mtop.dd.order.getListByUid",v:"1.0",data:{limit:b.page.limit,offset:(parseInt(b.page.page_current)-1)*parseInt(b.page.limit)}},function(c){var d=c.data;d&&(b.page.total=d.total,b.page.pages=Math.ceil(parseInt(d.total)/b.page.limit),b._buildTmpl(a,d)),b.asnyc=!1},function(d){c.ui.toast(d,b),b.asnyc=!1,"refresh"!==a&&b.page.page_current--})},_buildTmpl:function(a,b){var c=this;c._scroll||c._iScrollInit(),c.startUp(a,b)},startUp:function(a,b){var d=this;b.swipeid=h.getState().data.referer||"my";for(var e={},f=b.list.length-1;f>=0;--f)e[f]=b.list[f],d.my_pay_list[e[f].taobaoOrderNo]=e[f];var i=c.ui.tmpl(g.html(),b);"refresh"==a&&(my_pay_list.html(""),d.page.page_current=1),my_pay_list.append(i).show(),d._switchHandler()},events:[[c.event.click,".J_order_pay","_orderPay"],[c.event.click,".J_order_review","_orderReview"]],_orderReview:function(b,d){var e=this,f=a(d).attr("data-id");c.lib.ddState({push:{ddid:"review/"+f,obj:{referer:"my_pay",orderData:e.my_pay_list[f]}}})},_orderPay:function(b,d){var e=this,f=a(d),g=f.attr("data-id"),h=f.attr("data-alipay");return h?void(e.async||(e.async=!0,!i.supportFunc("tradePay")&&c.ui.toast.loading(),i.supportFunc("tradePay")?i.push("tradePay",{tradeNO:h},function(a){a.resultCode&&9e3==parseInt(a.resultCode)&&e.initHandler(),e.async=!1}):lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:e.my_pay_list[g].taobaoOrderId,payType:0},extParam:{}},function(a){if(a.data&&"true"==a.data.canPay){if(c.device.isAndroid&&c.device.version.android<4)return void(location.href=a.data.alipayUrl);c.ui.alipay({alipayUrl:a.data.alipayUrl,successFunc:function(){e.initHandler()}})}c.ui.toast.hide(),e.async=!1},function(a){c.ui.toast(a),e.async=!1}))):(c.lib.memCache.set("pay_detail",e.my_pay_list[g]),void c.lib.ddState({push:{ddid:"pay_detail/"+e.my_pay_list[g].localstoreId,obj:{referer:"my_pay"}}}))},_switchHandler:function(){var a=this,b=a.page;b.pages>1&&b.page_current<b.pages?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn"),a._scroll.refresh()},_iScrollInit:function(){var a=this;this._scroll=c.ui._scroll({wrap:"#J_my_pay_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullUpAction:function(){var a=this,b=a.page;b.page_current++,a._getMyOrder("add")}}}var e=a("#J_my_pay"),f=a("#J_tpl_my_pay"),g=a("#J_tpl_my_pay_list"),h=b.History,i=b.bridge;c.app.MyPay=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a){var b=this;b.id=a,b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){h.supportFunc("setOptionMenu")&&h.push("setOptionMenu",{icon:c.config.option_menu_icon.share})},_renderStatic:function(){this.wrap.html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;lib.mtop.request({api:"mtop.dd.order.get",v:"1.0",data:{orderNo:a.id}},function(b){b.data&&(a.data=b.data,a.startUp(a.data),h.push("setTitle",{title:a.wrap.find(".hd_title").find("h2").html()||"淘点点"}))},function(b){c.ui.toast(b,a)})},startUp:function(a){var b=this,d=c.ui.tmpl(f.html(),{data:a,swipeid:g.getState().data.referer||"my_pay"});e.html(d),"0"==a.payStatus&&(b.tradeInfo=a)},menuEvent:"_shareMenu",events:[[c.event.click,"#J_my_pay_detail_btn","_payHandler"],[c.event.click,"#J_my_pay_detail_review","_reviewHandler"],[c.event.click,".J_Share","_shareMenu"]],_reviewHandler:function(){var a=this;c.lib.ddState({push:{ddid:"review/"+a.data.orderNo,obj:{referer:"my_pay",orderData:a.data}}})},_payHandler:function(){var a=this,b=a.tradeInfo;return b.alipayTradeIds&&b.taobaoOrderIds?void(a.async||(a.async=!0,c.ui.toast.loading(),h.supportFunc("tradePay")?h.push("tradePay",{tradeNO:b.alipayTradeIds},function(b){c.ui.toast.hide(),b.resultCode&&9e3==parseInt(b.resultCode)&&a.initHandler(),a.async=!1}):lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:b.taobaoOrderIds,payType:0}},function(b){if(b.data&&"true"==b.data.canPay){if(c.device.isAndroid&&c.device.version.android<4)return void(location.href=b.data.alipayUrl);c.ui.alipay({title:"支付",alipayUrl:b.data.alipayUrl,successFunc:function(){a.initHandler()}})}c.ui.toast.hide(),a.async=!1},function(b){c.ui.toast(b),a.async=!1}))):(c.lib.memCache.set("pay_detail",b),void c.lib.ddState({push:{ddid:"pay_detail/"+b.localstoreId,obj:{referer:"my_pay_details"}}}))},_shareMenu:function(){var a=this;h.push("share",{title:a.data.title,content:"【"+a.data.title+"】可以用淘点点买单，超级方便，推荐你也试试",image:"http://gtms04.alicdn.com/tps/i4/T1kHywFuhdXXbYfSkc-640-1738.png",url:c.config.share.jump+"store_id!/"+a.data.localstoreId})}}}var e=a("#J_my_pay_details"),f=a("#J_tpl_my_pay_details"),g=b.History,h=b.bridge;c.app.MyPayDetails=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:h,init:function(){var a=this;a.options={reserveList:{}},a.page={pz:10,p:1,total:0,pTotal:1},a.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},_renderStatic:function(){var a=this,b={swipeid:g.getState().data.referer||"my"},d=c.ui.tmpl(i.html(),b);h.html(d),e=h.find("#J_my_reserve_list").html(c.ui.tpl.load),a.pullup_el=h.find(".J_pullUp")},_renderDynamic:function(){var a=this;f.push("login",function(){a._getMyReserve("refresh")})},_getMyReserve:function(a){var b=this;lib.mtop.request({api:"mtop.dd.reserve.order.search",v:"1.0",data:{pageSize:b.page.pz,pageNo:b.page.p}},function(c){var d=c.data;d&&(b.page.total=d.count,b.page.pTotal=Math.ceil(parseInt(d.count)/b.page.pz),b._buildList(a,d))},function(d){c.ui.toast(d,b),"refresh"!==a&&b.page.p--})},_setExtraDetail:function(a){if(a.valid="22"==a.status?"":"my_reserve_logo_new","1"==a.status?(a.btnStatus="reservation_pay_btn",a.btnText="付款"):"20"==a.status||"21"==a.status||"22"==a.status?(a.btnStatus="redo_btn",a.btnText="再订"):"1201"==a.status?(a.btnStatus="pay_btn",a.btnText="买单"):"12"==a.status?(a.btnStatus="pay_btn",a.btnText="买单"):"1299"==a.status?(a.btnStatus="scan_btn",a.btnText="下单"):a.btnStatus="hide_btn",a.reserveTime){var b=a.reserveTime.match(/\d+-\d+-\d+|\d+:\d+/gi),c=new Date(b[0]).getDay(),d=["周日","周一","周二","周三","周四","周五","周六"];a.showTime=[b[0],d[c],b[1]].join(" ")}},_buildList:function(a,b){for(var d=this,f={},g=b.list.length-1;g>=0;--g)f[g]=b.list[g],d._setExtraDetail(f[g]),j[f[g].id]=f[g];var h=c.ui.tmpl(k.html(),b);"refresh"==a&&(e.html(""),d.page.p=1),d.startUp(h),"refresh"==a&&d._iScrollInit(),d._manualHandler()},_manualHandler:function(){var a=this,b=a.page;b.pTotal>1&&b.p<b.pTotal?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn"),a._scroll.refresh()},startUp:function(a){e.append(a)},events:[[c.event.click,".my_order_item","_goDetail"]],_myChildPush:function(a,b){c.lib.ddState({push:{ddid:a,obj:{referer:"my_reserve",id:b}}})},_goDetail:function(b,c){var d=this,e=b.target,g=a(c),h=a(c).attr("rel"),i=g.attr("data-swipeid");switch(!0){case a(e).hasClass("reservation_pay_btn"):d._doReservationPay(e);break;case a(e).hasClass("redo_btn"):d._doRedo(h);break;case a(e).hasClass("pay_btn"):d._doPay(h);break;default:f.push("login",function(){d._myChildPush(i,h)})}},_doRedo:function(a){c.lib.ddState({push:{ddid:"reserve_datelist/"+j[a].localstoreId,obj:{referer:"my_reserve"}}})},_doPay:function(a){var b;a&&(b=j[a])&&("12"==b.status?c.ui.toast("到达预订时间后才能买单哦"):(b.reserve=1,c.lib.memCache.set("pay_detail",b),c.lib.ddState({push:{ddid:"pay_detail/"+b.localstoreId,obj:{referer:"my_reserve"}}})))},_doReservationPay:function(b){var d=this,e=a(b).parents(".my_order_item"),f=e.length&&e.attr("rel");if(f&&j[f]){var g=j[f];g.taobaoOrderId?d._aliPay(g,0):c.ui.toast("支付宝订单不存在")}},_aliPay:function(a,b){var d=this,e=["预订支付","确定买单"],g=e[b]||"";this.async||(this.async=!0,!f.supportFunc("tradePay")&&c.ui.toast.loading(),f.supportFunc("tradePay")?f.push("tradePay",{tradeNO:a.alipayOrderId},function(a){a.resultCode&&9e3==parseInt(a.resultCode)&&d.initHandler(),d.async=!1}):lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:a.taobaoOrderId,payType:0}},function(a){a.data&&"true"==a.data.canPay&&c.ui.alipay({title:g,alipayUrl:a.data.alipayUrl,successFunc:function(){d.initHandler()}}),c.ui.toast.hide(),d.async=!1},function(a){c.ui.toast(a),d.async=!1}))},_iScrollInit:function(){var a=this;this._scroll=c.ui._scroll({wrap:"#J_my_reserve_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullDownAction:function(){{var a=this,b=a.page;b.type}b.p=1,a._getMyReserve("refresh")},_pullUpAction:function(){var a=this,b=a.page;b.p++,a._getMyReserve("add")}}}var e,f=b.bridge,g=b.History,h=a("#J_my_reserve"),i=a("#J_tpl_my_reserve"),j={},k=a("#J_tpl_my_reserve_item");c.app.MyReserve=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:h,init:function(){var a,b,d=this,e=c.lib.getUriParam(location.href,"_ddid");e&&(b=e.split("/"))&&b.length>1&&(a=b[1]),d.pages={id:g.getState().data.id||a},d.initHandler()},initHandler:function(){this._renderDynamic()},setAfterPageIn:function(){j.supportFunc("setOptionMenu")&&j.push("setOptionMenu",{icon:c.config.option_menu_icon.share})},_renderDynamic:function(){var a=this;j.push("login",function(){a._getReserveDetail()})},_goShop:function(b){var d=a(b).data("swipeid");d&&c.lib.ddState({push:{ddid:d,obj:{referer:"my_reserve_detail"}}})},_goMapMark:function(){if(e.posX&&e.posY){var b="address_map/show";a("#J_address_map").removeAttr("data-ddid");var d={push:{ddid:b,obj:{data:{posx:e.posX,posy:e.posY},referer:"store/"+e.localstoreId}}};c.lib.ddState(d)}},_getReserveDetail:function(){var a=this;c.ui.toast.loading(),lib.mtop.request({api:"mtop.dd.reserve.order.detail",v:"1.1",data:{orderNo:a.pages.id,fromAlipay:0}},function(b){var d=b.data;d&&(e=d,c.ui.toast.hide(),a._serializeData())},function(b){c.ui.toast(b,a)})},_serializeData:function(){var a=this,b=[],d=e;if(d.items){for(var f in d.items){var g={};g.itemId=d.items[f].itemId,g.itemName=d.items[f].itemName,g.count=d.items[f].cnt,g.oriPrice=d.items[f].orgPrice,g.itemPrice=d.items[f].price,g.totalPrice=d.items[f].add,d.items[f].image&&(g.picPath=d.items[f].image),g.showPic=g.picPath?"reverve_pic_icon":"",g.hasPic=g.picPath?"show_pic":"",g.itemPrice=100*g.itemPrice%100?parseFloat(g.itemPrice).toFixed(2):parseInt(g.itemPrice),b.push(g)}d.items=b}{var h,i;d.real||0}switch(d.status){case"1":h="付款",i="reservation_pay_btn";break;case"20":case"21":case"22":h="再订",i="redo_btn";break;case"12":case"1201":h="买单",i="pay_btn";break;case"1299":h="扫码下单",i="scan_btn"}if(a.auctionId=d.auctionId,d.reserveTime){var k=d.reserveTime.match(/\d+-\d+-\d+|\d+:\d+/gi),m=new Date(k[0]).getDay(),n=["周日","周一","周二","周三","周四","周五","周六"];d.reserveTimeWithWeekday=[k[0],n[m],k[1]].join(" ")}a.reserveTime=d.reserveTime,d.memo1&&(d.memo1="<p>"+d.memo1,d.memo1=d.memo1.replace(/\n/gi,"<p>")),d.btnText=h,d.btnCls=i,d.oriMoney=10;var o=c.ui.tmpl(l.html(),{detail:d});a.wrap.html(o),j.push("setTitle",{title:a.wrap.find(".hd_title").find("h2").html()||"淘点点"}),"1"==d.needTip&&d.tip&&a.showAlertWithTitle(d.tip)},initDialog:function(){this._popdialog=c.ui.dialog({cls:"reserve_dialog",title:"",wrap:"#J_my_reserve_details",content:c.ui.tpl.load,maxheight:"246"}),f=this.wrap.find(".J_dialog_content")},_showCartePop:function(a){var b=this;if(b.initDialog(),i[a])b._renderPop(i[a]);else{if(b.async)return;b.async=!0,lib.mtop.request({api:"mtop.life.diandian.getItemDetail",v:"1.1",data:{itemId:a,reserveId:b.auctionId,reserveTime:b.reserveTime,type:1},extParam:{}},function(c){i[a]=c.data,b._renderPop(i[a]),b.async=!1},function(){b.async=!1})}},_renderPop:function(a){console.log(a);a.itemPicUgcs?a.itemPicUgcs:[];a.width=.86*b.document.body.clientWidth-2;var d=c.ui.tmpl(k.html(),{data:a});f.html(d),this._popdialog.setTitle(a.itemName)},_aliPay:function(a,b){var d=this,e=["预订支付","确定买单"],f=e[b]||"";this.async||(this.async=!0,!j.supportFunc("tradePay")&&c.ui.toast.loading(),j.supportFunc("tradePay")?j.push("tradePay",{tradeNO:a.alipayOrderId},function(a){a.resultCode&&9e3==parseInt(a.resultCode)&&d.initHandler(),d.async=!1}):lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:a.taobaoOrderId,payType:0}},function(a){a.data&&"true"==a.data.canPay&&c.ui.alipay({title:f,alipayUrl:a.data.alipayUrl,successFunc:function(){d.initHandler()}}),c.ui.toast.hide(),d.async=!1},function(a){c.ui.toast(a),d.async=!1}))},_doReservationPay:function(){var a=this;e.alipayOrderId?a._aliPay(e,0):c.ui.toast("支付宝订单不存在")},showAlertWithTitle:function(a){c.ui.toast(a)},menuEvent:"_shareMenu",events:[[c.event.click,".scroll_wrap","_eventHandler"],[c.event.click,".btn_bottom_sub","_btnHandler"],[c.event.click,".J_Share","_shareMenu"]],_eventHandler:function(b){var c,d,e=this,f=b.target;f&&(d=f.className)&&(-1!=d.indexOf("shop_title_wrap")&&e._goShop(f),-1!=d.indexOf("shop_address_wrap")&&e._goMapMark(),-1!=d.indexOf("show_pic")&&e._showDetailImg(f),(c=a(f).parents(".show_pic"))&&c.length&&e._showDetailImg(c))},_btnHandler:function(b,c){var d=this,f=a(c),g=e.id;switch(!0){case f.hasClass("reservation_pay_btn"):d._doReservationPay(c);break;case f.hasClass("redo_btn"):d._doRedo(g);break;case f.hasClass("pay_btn"):d._doPay(g)}},_doPay:function(){var a,b=e.id;b&&(a=e)&&("12"==a.status?c.ui.toast("到达预订时间后才能买单哦"):(a.reserve=1,c.lib.memCache.set("pay_detail",a),c.lib.ddState({push:{ddid:"pay_detail/"+a.localstoreId+"/"+a.id,obj:{referer:"my_reserve_detail"}}})))},_doRedo:function(){c.lib.ddState({push:{ddid:"reserve_datelist/"+e.localstoreId,obj:{referer:"my_reserve"}}})},_showDetailImg:function(b){var c=a(b).data("rel");this._showCartePop(c)},_shareMenu:function(){j.push("share",{title:"淘点点一键预订，真心靠谱！",content:"用淘点点预订，支持预订的餐厅一目了然， 真心方便，靠谱！",image:"http://g.dd.alicdn.com/tps/i1/T1PV4wFy0jXXay7mDj-368-1000.png",url:c.config.share.jump+"store_id!/"+e.localstoreId})}}}var e,f,g=b.History,h=a("#J_my_reserve_details"),i={},j=b.bridge,k=a("#J_tpl_cartepop"),l=a("#J_tpl_my_reserve_details");c.app.MyReserveDetails=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:f,init:function(){var a=this;return a.reserveDate=c.lib.localStorage.get("reserve_date"),a.user_info=c.lib.localStorage.get("reserve_user_info"),a.alt=e.getState().data.referer||"reserve_datelist",a.carte_data=e.getState().data.data,a.reserveDate?void a.initHandler():void setTimeout(function(){c.lib.ddState({push:{ddid:"reserve_shops"}})},0)},initHandler:function(){this._renderStatic(),this._renderDynamic()},_renderStatic:function(){this.wrap.html(c.ui.tpl.load)},_titleLazy:!0,_renderDynamic:function(){var a=this,b=c.ui.tmpl(g.html(),{alt:a.alt,data:a.reserveDate,carte:a.carte_data,name:a.user_info?a.user_info.userName:null,phone:a.user_info?a.user_info.userPhone:null});if(this.wrap.html(b),c._hideTitleBar)try{h.push("setTitle",{title:a.reserveDate.storeInfo.localstoreName||"淘点点"})}catch(d){}},events:[[c.event.click,"#J_PayBtn","_payHandler"]],_payHandler:function(){var b=this,c={},d=a("#J_ReserveForm").serializeArray();return d.forEach(function(a){c[a.name]=a.value}),c.userName.length?c.userPhone.length?/^0?(13[0-9]|15[012356789]|18[0-9]|14[57])[0-9]{8}$/.test(parseInt(c.userPhone))?void this.submitForm(c):void b.showToast("手机号格式不正确，请重新输入！"):void b.showToast("请输入手机"):void b.showToast("请输入姓名")},showToast:function(a){h.supportFunc("toast")?h.push("toast",{content:a}):c.ui.toast(a)},submitForm:function(b){var d=this;!h.supportFunc("tradePay")&&c.ui.toast.loading();var e=d.carte_data?"mtop.dd.reserve.order.confirmReserveOrderWithPreDD":"mtop.dd.reserve.order.insert",f=d.carte_data?"1.1":"1.0";if(d.carte_data){var g=[];a.each(d.carte_data.cartViewList,function(a,b){g.push(b.itemId+":"+("0"!==b.skuId?b.skuId:"")+":"+b.quantity)}),a.extend(b,{info:g.join(";"),storeId:d.reserveDate.storeInfo.localstoreId})}lib.mtop.request({api:e,v:f,data:b,extParam:{}},function(a){lib.mtop.request({api:"mtop.dd.reserve.order.detail",v:"1.1",data:{orderNo:a.data.id},extParam:{}},function(a){c.lib.localStorage.set("reserve_user_info",{userName:b.userName,userPhone:b.userPhone}),d.orderId=a.data.id,d.doPay(a.data)},function(a){c.ui.toast(a)})},function(a){c.ui.toast(a)})},doPay:function(b){var d,e=this,f=function(){a("#J_my_reserve").removeAttr("data-ddid"),a("#J_my").removeAttr("data-ddid"),c.lib.ddState({push:{ddid:"my_reserve_details/"+e.orderId,obj:{referer:"my"},multi:!0}})},g=function(){a("#J_my_reserve").removeAttr("data-ddid"),a("#J_my").removeAttr("data-ddid"),c.lib.ddState({back:{ddid:"my_reserve_details/"+e.orderId,obj:{referer:"my"},multi:!0}})};if(!e.async)if(e.async=!0,h.supportFunc("tradePay"))h.push("tradePay",{tradeNO:b.alipayOrderId},function(a){if(a.resultCode&&9e3==parseInt(a.resultCode))d=f;else{d=g;var b="6001"==a.resultCode?"操作已取消":"支付未成功";c.ui.toast(b)}e.async=!1,setTimeout(function(){d()},1500)});else{var i=0,j=["预订支付","确定买单"],k=j[i]||"";lib.mtop.request({api:"mtop.order.doPay",v:"1.0",data:{orderId:b.taobaoOrderId,payType:0}},function(a){a.data&&"true"==a.data.canPay&&c.ui.alipay({title:k,alipayUrl:a.data.alipayUrl,successFunc:f,backFunc:g}),c.ui.toast.hide(),e.async=!1},function(a){c.ui.toast(a),e.async=!1})}}}}var e=b.History,f=a("#J_reserve_confirm"),g=a("#J_tpl_reserve_confirm"),h=b.bridge;c.app.ReserveConfirm=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a,b){var c=this;c.alt=h.getState().data.referer||"reserve_shops",c.dateObj=new Date,c.reserveMD=a,c.reserveMonth=parseInt(a.split("-")[0]),c.reserveDate=parseInt(a.split("-")[1]),c.reserveDays=parseInt(b),c.tpl=[],c.initHandler()},initHandler:function(){this._renderStatic()},setAfterPageOut:function(){setTimeout(function(){c.lib.memCache.removeValue("reserve_date_update")},0)},_renderStatic:function(){var a=this,b=c.ui.tmpl(f.html(),{alt:a.alt});a.wrap.html(b),a._initDateItem1()},_initDateItem1:function(){var a,b=this.dateObj.getFullYear(),c=this.dateObj.getMonth()+1,d=this.dateObj.getDate(),e=b+"年"+(1==c.toString().length?"0":"")+c+"月",f=this._getDayOfWeek(b+"-"+c+"-1"),g=this._geTMonthDays(c),h=g-d+1;h>=this.reserveDays?a=this.reserveDays:(a=h,this.inReserveDaysLeft=this.reserveDays-a);for(var i=d+a-1,j={},k=1;g>=k;k++)j[k]={v:b+"-"+c+"-"+k+" 00:00:00"},k>=d&&i>=k&&(j[k].canReserve=!0,c==this.reserveMonth&&k==this.reserveDate&&(j[k].reserveDate=!0)),k==d&&(j[k].today=!0),k==d+1&&(j[k].tomorrow=!0),k==d+2&&(j[k].afterTomorrow=!0);this._initDateTpl({title:e,day1stPush:f,dateReserveObj:j}),this._initDateItem2()},_initDateItem2:function(){{var a=this.dateObj.getFullYear(),b=this.dateObj.getMonth()+1;this.dateObj.getDate()}12==b?(b=1,a++):b++;for(var c=a+"年"+(1==b.toString().length?"0":"")+b+"月",d=this._getDayOfWeek(a+"-"+b+"-1"),e=this._geTMonthDays(b),f=this.inReserveDaysLeft,g={},h=1;e>=h;h++)g[h]={v:a+"-"+b+"-"+h+" 00:00:00"},f>=h&&(g[h].canReserve=!0,b==this.reserveMonth&&h==this.reserveDate&&(g[h].reserveDate=!0));this._initDateTpl({title:c,day1stPush:d,dateReserveObj:g}),this.startUp()},_getLeapYear:function(a){return a%4===0?!0:!1},_geTMonthDays:function(a){var b,c=this;switch(a.toString()){case"1":case"3":case"5":case"7":case"8":case"10":case"12":b=31;break;case"2":b=c._getLeapYear(c.dateObj.getFullYear())?29:28;break;default:b=30}return b},_getDayOfWeek:function(a){var b=new Date(Date.parse(a.replace(/-/g,"/")));return b.getDay()},_initDateTpl:function(a){var b=c.ui.tmpl(g.html(),a);this.tpl.push(b)},startUp:function(){a("#J_reserve_date_main").append(this.tpl.join(""))},events:[[c.event.click,".J_date_item","_itemHandler"]],_itemHandler:function(b,d){var e=this,f=a(d).data("date");if(a(d).hasClass("in")){c.lib.memCache.set("reserve_date_update",f);var g={back:{ddid:e.alt}};c.lib.ddState(g)}}}}var e=(b.bridge,a("#J_reserve_date")),f=a("#J_tpl_reserve_date"),g=a("#J_tpl_reserve_date_item"),h=b.History;c.app.ReserveDate=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a,b){var d=this;d.async=!1,d.role="refresh",d.cacheMisc=c.lib.memCache.get("reserve_shops_misc"),d.storeid=a;var e=new Date;d.reserveDate=b||e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" 00:00:00",d.misc_data=d.cacheMisc?d.cacheMisc.misc:void 0,d.capacity=d.cacheMisc?d.cacheMisc.capacity:0,d.reserveRang=d.cacheMisc?d.cacheMisc.reserveRang:0,d.slide_config={max:void 0,unit:void 0},d.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){var a=this,b=c.lib.memCache.get("reserve_date_update"),d=c.lib.memCache.get("reserve_shops_misc");b&&(a.reserveDate=b,a.role="refresh",a._renderDynamic()),!d||d.capacity===a.capacity&&d.reserveRang===a.reserveRang||(a.capacity=d.capacity,a.reserveRang=d.reserveRang,a.role="refresh",a._renderDynamic())},_renderStatic:function(){this.wrap.html(c.ui.tpl.load)},_renderDynamic:function(){var a=this,b=c.ui.tmpl(g.html(),{alt:History.getState().data.referer||"reserve_shops"});a.wrap.html(b),a.reserve_datelist_content=this.wrap.find("#J_reserve_datelist_content").html(c.ui.tpl.load),a.misc_data?a._getSeatData():a._getMisc()},startUp:function(a){this.reserve_datelist_seats.html(a)},events:[[c.event.click,"#J_get_calendar","_getCalendarHandler"],[c.event.click,".J_date_item","_filterDateHandler"],["change","select","_filterSelectHandler"],[c.event.click,".J_Time","_orderSeatHandler"]],_getMisc:function(){var a=this;lib.mtop.request({api:"mtop.dd.reserve.reserveMisc",v:"1.0",data:{},extParam:{}},function(b){var c=b.data;c&&(a.misc_data=c,a._getSeatData())},function(b){c.ui.toast(b,a)})},_buildFilterTpl:function(){var a=this,b=a._getFilterDate(),d=(document.body.clientWidth-45)/3,e=c.ui.tmpl(f.html(),{data:a.misc_data,date_list:b,capacity:a.capacity,reserve_range:a.reserveRang,width:d});a.reserve_datelist_content.html(e),a.reserve_datelist_seats=a.wrap.find("#J_reserve_datelist_seats").html(c.ui.tpl.load),a.reserve_filter_date_ul=a.wrap.find("#J_reserve_filter_date_ul"),a.slide_config.max=a.reserve_filter_date_ul.children().length,a.slide_config.unit=d;var g="#J_reserve_shops_date_"+a.reserveDate.split(" ")[0];a.wrap.find(g).addClass("current").siblings(".current").removeClass("current"),a._slideDate()},_getSeatData:function(){var b=this;lib.mtop.request({api:"mtop.dd.reserve.auctionlist",v:"1.1",data:{localstoreId:b.storeid,reserveDate:b.reserveDate+" 00:00:00",reserveRang:b.reserveRang,capacity:b.capacity},extParam:{}},function(c){var d=c.data;b.storeInfo=d,b.reserveDays=parseInt(d.reserveDays),a("#J_ShopName").html(d.localstoreName),d.discountInfo&&a("#J_ShopDiscount").show().html("<i></i>"+d.discountInfo),b._buildFilterTpl(),b._buildListTpl(d)},function(a){c.ui.toast(a,b)})},_buildListTpl:function(a){var b=this,d=c.ui.tmpl(h.html(),{list:b.organizeData(a)});"refresh"==this.role&&this.reserve_datelist_seats.empty(),this.startUp(d),0==a.list.length&&c.ui.toast("今天的座位都被订完啦，看看其他时间的座位吧！")},organizeData:function(b){var c=b.list;return a.each(c,function(b,c){a.each(c.timelist,function(a,b){var c=b.date.split(" ")[1],d=c.split(":");b.formatDate=d[0]+":"+d[1]})}),c},_filterDateHandler:function(b,c){var d=a(c),e=d.data("ymd");this.async||d.hasClass("current")||(this.reserveDate=e+" 00:00:00",d.addClass("current").siblings().removeClass("current"),this._slideDate(),this._filterHandler())},_filterSelectHandler:function(b,c){var d=this,e=a(c),f=e.data("name"),g=c.value;if(-1!=g&&!d.async){var h=e.siblings(".J_show_value"),i=e.children().not(function(){return!this.selected}),j=i.text();h.text(j),d[f]=g,d._filterHandler()}},_filterHandler:function(){this.reserve_datelist_seats.html(c.ui.tpl.load),this.role="refresh",this._getSeatData()},_getCalendarHandler:function(){var a=this,b=a.wrap.find(".J_date_item").filter(".current"),d=b.data("date");c.lib.ddState({push:{ddid:"reserve_date/"+d+"/"+a.reserveDays,referer:"reserve_datelist"}})},_slideDate:function(){var a,b=this.reserve_filter_date_ul.find(".current"),c=b.index();a=0==c?0:c>=this.slide_config.max-1?(c-2)*this.slide_config.unit:(c-1)*this.slide_config.unit,this.reserve_filter_date_ul[0].style.webkitTransform="translate3d(-"+a+"px, 0, 0)"},_orderSeatHandler:function(b,d){var e,f=this,g=a(d);if(!g.hasClass("none")){var h=g.attr("data-time"),i=h.split(" "),j=f._getDayOfWeek(i[0]),k=g.find("span").html(),l=g.attr("data-index");c.lib.localStorage.set("reserve_date",{seatType:g.parents("div.list_item").find("h3").html(),displayDate:i[0]+" "+j+" "+k,reserveTime:h,storeInfo:f.storeInfo,index:g.attr("data-index")}),"1"==g.attr("data-require")&&(e="carte/dian/"+f.storeid+"/"+l+"/"+k),c.lib.ddState({push:{ddid:e||"reserve_confirm",obj:{referer:"reserve_datelist/"+f.storeid+"/"+f.reserveDate}}})}},_getFilterDate:function(){var a,b,c=this,d=new Date,e=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+" 00:00:00",f=e.split(" ")[0].split("-"),g=f[0],h=f[1],i=parseInt(f[2]),j=c._geTMonthDays(h),k=j-i+1;k>=c.reserveDays?a=c.reserveDays:(a=k,b=c.reserveDays-a);for(var l=i+a-1,m=[],n=1;j>=n;n++)if(n>=i&&l>=n){var o=g+"-"+h+"-"+n,p="";n==i&&(p="今天"),n==i+1&&(p="明天"),n==i+2&&(p="后天"),m.push([h+"-"+n,o,c._getDayOfWeek(o),p])}b&&(12==h?(h=1,g++):h++);for(var q=c._geTMonthDays(h),r=1;q>=r;r++)if(b>=r){var s=g+"-"+h+"-"+r;m.push([h+"-"+r,s,c._getDayOfWeek(s)])}return m},_geTMonthDays:function(a){var b,c=this;switch(a.toString()){case"1":case"3":case"5":case"7":case"8":case"10":case"12":b=31;break;case"2":b=c.dateObj.getFullYear()%4===0?29:28;break;default:b=30}return b},_getDayOfWeek:function(a){var b=new Date(Date.parse(a.replace(/-/g,"/"))),c=["周日","周一","周二","周三","周四","周五","周六"];return c[b.getDay()]}}}{var e=a("#J_reserve_datelist"),f=a("#J_tpl_reserve_datelist_content"),g=a("#J_tpl_reserve_datelist"),h=a("#J_tpl_reserve_datelist_seats");b.bridge}c.app.ReserveDatelist=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:g,init:function(){var a=this;a.async=!1,a.role="refresh",a.misc_data=void 0;var b=new Date;a.todayObj=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()+" 00:00:00",a.shops_filter_data=a.shops_filter_data||a._filterDataReset(),a.slide_config={max:void 0,unit:void 0},a.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setBeforePageOut:function(){},setAfterPageOut:function(){},setAfterPageIn:function(){if(c.lib.memCache.get("reserve_date_update")){var a=c.lib.memCache.get("reserve_date_update");this.shops_filter_data.reserveDate=a,this.role="refresh",this._cityInit()}c.lib.memCache.get("update_city")&&this._cityInit()},_renderStatic:function(){var a=this;a.wrap.html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;return c.lib.localStorage.get("current_city")?void a._cityInit():(f.addEventListener("click",c.lib.preventAllClick,!0),void c.lib.getH5Geo({callback:function(b){f.removeEventListener("click",c.lib.preventAllClick,!0),b.latitude?a._cityInit():(a.wrap.html(c.ui.tpl.load),c.ui.toast("无法定位，请检查“定位”设置<br>",a),c.lib.ddState({push:{ddid:"city",obj:{referer:"reserve_shops"}}}))}}))},_cityInit:function(){var a=this,b=c.lib.localStorage.get("current_city");a.shops_filter_data.city=b.cityId,a.shops_filter_data.posY=b.latitude,a.shops_filter_data.posX=b.longitude,a._renderFrame(b)},_renderFrame:function(a){var b=c.ui.tmpl(h.html(),a);this.wrap.html(b),this.reserve_shops_content=this.wrap.find("#J_reserve_shops_content").html(c.ui.tpl.load),this.misc_data?this._buildFilterTpl():this._getMisc()},_filterDataReset:function(){return{reserveRang:"0",posY:"",posX:"",pageNo:1,pageSize:20,capacity:"0",reserveDate:this.todayObj,city:"",pageTotal:void 0}},_getMisc:function(){var a=this;lib.mtop.request({api:"mtop.dd.reserve.reserveMisc",v:"1.0",data:{},extParam:{}},function(b){var c=b.data;c&&(a.misc_data=c,a.reserveDays=c.reserveDays,a._buildFilterTpl())},function(b){c.ui.toast(b,a)})},_buildFilterTpl:function(){var a=this._getFilterDate(this.misc_data),b=(document.body.clientWidth-45)/3,d=c.ui.tmpl(i.html(),{data:this.misc_data,date_list:a,width:b});this.reserve_shops_content.html(d),this.reserve_shops_list=this.wrap.find("#J_reserve_shops_list").html(c.ui.tpl.load),this.reserve_filter_date_ul=this.wrap.find("#J_reserve_filter_date_ul"),this.slide_config.max=this.reserve_filter_date_ul.children().length,this.slide_config.unit=b;var e="#J_reserve_shops_date_"+this.shops_filter_data.reserveDate.split(" ")[0];this.wrap.find(e).addClass("current").siblings(".current").removeClass("current"),this._slideDate(),this.pulldown_el=this.wrap.find(".J_pulldown"),this.pullup_el=this.wrap.find(".J_pullUp"),this._getStoreList()},_getStoreList:function(){var a=this;a.async||(a.async=!0,"refresh"==a.role&&(a.shops_filter_data.pageNo=1),lib.mtop.request({api:"mtop.dd.reserve.storelist",v:"1.0",data:{reserveRang:a.shops_filter_data.reserveRang,posY:a.shops_filter_data.posY,posX:a.shops_filter_data.posX,pageNo:a.shops_filter_data.pageNo,pageSize:a.shops_filter_data.pageSize,capacity:a.shops_filter_data.capacity,reserveDate:a.shops_filter_data.reserveDate,city:a.shops_filter_data.city},extParam:{}},function(b){var c=b.data;a.async=!1,c&&(a.shops_filter_data.pageTotal=Math.ceil(parseInt(c.total)/a.shops_filter_data.pageSize),a._buildListTpl(c))},function(b){c.ui.toast(b,a),a.async=!1,"refresh"!==a.role&&a.shops_filter_data.pageNo--}))},_buildListTpl:function(a){var b=c.ui.tmpl(j.html(),a);"refresh"==this.role&&this.reserve_shops_list.empty(),this.startUp(b),"refresh"==this.role?(this.shops_filter_data.pageTotal>1?this.pullup_el.removeClass("dn"):this.pullup_el.addClass("dn"),this._scrollInit()):(this.shops_filter_data.pageNo>=this.shops_filter_data.pageTotal&&this.pullup_el.addClass("dn"),this._scroll.refresh())},startUp:function(a){this.reserve_shops_list.append(a)},events:[[c.event.click,".J_get_calendar","_getCalendarHandler"],[c.event.click,".J_date_item","_filterDateHandler"],["change","select","_filterSelectHandler"],[c.event.click,".J_date_shop_item","_shopItemHandler"]],_filterDateHandler:function(b,c){var d=a(c),e=d.data("ymd");this.async||d.hasClass("current")||(this.shops_filter_data.reserveDate=e+" 00:00:00",d.addClass("current").siblings().removeClass("current"),this._slideDate(),this._filterHandler())},_filterSelectHandler:function(b,c){var d=a(c),e=d.data("name"),f=c.value;if(!this.async){var g=d.siblings(".J_show_value"),h=d.children().not(function(){return!this.selected}),i=h.text();g.text(i),this.shops_filter_data[e]=f,this._filterHandler()}},_filterHandler:function(){this.reserve_shops_list.html(c.ui.tpl.load),this._scrollReset(),this.role="refresh",this._getStoreList()},_scrollReset:function(){this.pulldown_el.addClass("dn"),this.pullup_el.addClass("dn"),a("#J_tpl_reserve_shops_scroll").children().attr("style","")
},_getCalendarHandler:function(){var a=this,b=a.wrap.find(".J_date_item").filter(".current"),d=b.data("date");c.lib.ddState({push:{ddid:"reserve_date/"+d+"/"+a.reserveDays,referer:"reserve_shops"}})},_slideDate:function(a){var b,c=this.reserve_filter_date_ul.find(".current"),a=c.index();b=0==a?0:a>=this.slide_config.max-1?(a-2)*this.slide_config.unit:(a-1)*this.slide_config.unit,this.reserve_filter_date_ul[0].style.webkitTransform="translate3d(-"+b+"px, 0, 0)"},_shopItemHandler:function(b,d){var e=a(d),f=this.reserve_filter_date_ul.find(".current").data("ymd");c.lib.memCache.set("reserve_shops_misc",{misc:this.misc_data,capacity:this.shops_filter_data.capacity,reserveRang:this.shops_filter_data.reserveRang}),c.lib.ddState({push:{ddid:"reserve_datelist/"+e.data("id")+"/"+f,obj:{referer:"reserve_shops"}}})},_scrollInit:function(){var a=this;this._scroll=c.ui._scroll({wrap:"#J_tpl_reserve_shops_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullDownAction:function(){var a=this;a.role="refresh",a._getStoreList("refresh")},_pullUpAction:function(){var a=this;a.shops_filter_data.pageNo++,a.role="add",a._getStoreList("add")},_getFilterDate:function(){var a,b,c=this,d=c.todayObj.split(" ")[0].split("-"),e=d[0],f=d[1],g=parseInt(d[2]),h=c._geTMonthDays(f),i=h-g+1;i>=this.reserveDays?a=this.reserveDays:(a=i,b=this.reserveDays-a);for(var j=g+a-1,k=[],l=1;h>=l;l++)if(l>=g&&j>=l){var m=e+"-"+f+"-"+l,n="";l==g&&(n="今天"),l==g+1&&(n="明天"),l==g+2&&(n="后天"),k.push([f+"-"+l,m,c._getDayOfWeek(m),n])}b&&(12==f?(f=1,e++):f++);for(var o=c._geTMonthDays(f),l=1;o>=l;l++)if(b>=l){var m=e+"-"+f+"-"+l,n="";k.push([f+"-"+l,m,c._getDayOfWeek(m)])}return k},_geTMonthDays:function(a){var b,c=this;switch(a.toString()){case"1":case"3":case"5":case"7":case"8":case"10":case"12":b=31;break;case"2":b=c.dateObj.getFullYear()%4===0?29:28;break;default:b=30}return b},_getDayOfWeek:function(a){var b=new Date(Date.parse(a.replace(/-/g,"/"))),c=["周日","周一","周二","周三","周四","周五","周六"];return c[b.getDay()]}}}{var e=(b.bridge,b.document),f=e.body,g=a("#J_reserve_shops"),h=a("#J_tpl_reserve_shops"),i=a("#J_tpl_reserve_shops_content"),j=a("#J_tpl_reserve_shops_list");b.History}c.app.ReserveShops=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:a("#J_review"),tpl:a("#J_tpl_review"),init:function(b){var d=this;d.id=b,d.historyData=f.getState().data,d.swipeid=d.historyData.referer,d.wrap.html(c.ui.tpl.load),d.historyData.orderData?d.render(d.historyData.orderData):d._getOrderData(),a(document).on("tplDomRenderEnd",function(){c._hideTitleBar&&e.push("setTitle",{title:d.wrap.find(".hd_title").find("h2").html()||"淘点点"})})},events:[[c.event.click,"#J_reviewSubmit","_submitReview"],[c.event.click,".J_swipe_page_noreturn","_quitConfirm"]],_submitReview:function(){var b=this,c={},d=a("#J_ReviewForm").serializeArray();d.forEach(function(a){c[a.name]=a.value}),b.sendRequest(c)},sendRequest:function(b){var d,e,f,g=this,h=[],i=g.wrap.find(".J_praise");"my_delivery"==g.swipeid?(a.each(i,function(a,b){b.checked&&h.push(parseInt(b.name))}),h=0==h.length?"[]":"["+h.join(",")+"]",d={api:"mtop.takeout.comment.saveCommentAndDigg",v:"1.0",data:a.extend(b,{orderId:g.id,shopId:g.data.shopId,diggItemIds:h})},e=g.swipeid):"my_order_details"==g.swipeid?(f=g.historyData.orderData,a.each(i,function(a,b){var c=b.checked?"1":"0";h.push(b.name+",,,"+c)}),d={api:"mtop.life.diandian.publishReview",v:"2.0",data:{starScore:b.taste,content:b.content,localstoreId:f.storeInfo.storeId,serveOrderId:f.orderId,a:9,p:1,itemUgcs:h.join(";")}},e="my_order"):("my_pay"==g.swipeid||"pay_result"==g.swipeid)&&(f=g.historyData.orderData,d={api:"mtop.dd.review.add",v:"1.0",data:{content:b.content,orderNo:f.orderNo,feed:b.taste,localstoreId:f.localstoreId}},e="my_pay"),lib.mtop.request(d,function(){c.lib.ddState({replace:{ddid:e}})},function(a){c.ui.toast(a)})},_quitConfirm:function(b,d){"back"==a(d).data("role")&&""!==a("#J_ReviewContent").val()?e.push("confirm",{message:"真的要放弃评价吗？",okButton:"确定",cancelButton:"取消"},function(a){a.ok&&(c.navi.back=!0,c.lib.ddState({back:{ddid:"",multi:""}}))}):(c.navi.back=!0,c.lib.ddState({back:{ddid:"",multi:""}}))},render:function(b){var c=this;c._buildTmpl(c._mixData(b)),a(document).trigger("tplDomRenderEnd")},_getOrderData:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getTcOrderDetail",v:"1.0",data:{oid:a.id}},function(b){b.data&&a.render(b.data)},function(b){c.ui.toast(b,a)})},_mixData:function(a){var b=this,c=a.time||a.createTime,d=new Date(parseInt(c)),e=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"	"+d.getHours()+":"+(d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes())+":"+(d.getSeconds()<10?"0"+d.getSeconds():d.getSeconds());return b.data=a,b.data.formatTime="my_pay"!=b.swipeid&&"pay_result"!=b.swipeid||!a.gmtCreate?e:a.gmtCreate,b.data},_buildTmpl:function(a){var b=this,d=c.ui.tmpl(b.tpl.html(),{data:a,swipeid:b.swipeid});b.wrap.html(d)}}}var e=b.bridge,f=b.History;c.app.Review=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a,b){var c=this;c.type=a,"store"==c.type?c.storeid=b:"shop"==c.type&&(c.shopid=b),c.page={store:{role:"refresh",page_size:10,page_num:1,total:0,pTotal:1},shop:{role:"refresh",page_size:10,page_num:1,total:0,pTotal:1}},c.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){},setAfterPageOut:function(){},_renderStatic:function(){var a=this,b={alt:h.getState().data.referer||a.type+"/"+a.storeid||a.shopid},d=c.ui.tmpl(f.html(),b);e.html(d),a.pullup_el=e.find(".J_pullUp"),a.reviewlist_content=e.find("#J_reviewlist_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;"store"==a.type?a._getStoreReviewList():"shop"==a.type&&a._getShopReviewList()},_getStoreReviewList:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getReviewList",v:"1.0",data:{page_size:a.page.store.page_size,localstore_id:a.storeid,page_num:a.page.store.page_num},extParam:{}},function(b){var c=b.data;c&&(a.page.store.total=parseInt(c.reviewCount),a.page.store.pTotal=Math.ceil(parseInt(c.reviewCount)/a.page.store.page_size),a._buildTmpl(b.data))},function(b){c.ui.toast(b,a),"store"==a.type&&"add"==a.page.store.role&&a.page.store.page_num--})},_getShopReviewList:function(){var a=this;lib.mtop.request({api:"mtop.takeout.comment.queryCommentForPage",v:"1.0",data:{pageSize:a.page.shop.page_size,shopId:a.shopid,pageNo:a.page.shop.page_num},extParam:{}},function(b){var c=b.data;console.log(c),c&&(a.page.shop.total=parseInt(c.totalCount),a.page.shop.pTotal=parseInt(c.totalPage),a._buildTmpl(b.data))},function(b){c.ui.toast(b,a),"shop"==a.type&&"add"==a.page.shop.role&&a.page.shop.page_num--})},_buildTmpl:function(a){var b=this;"refresh"==b.page[b.type].role&&(b.reviewlist_content.html(""),b.page[b.type].page_num=1);var d={storedata:"store"==b.type?a:"",shopdata:"shop"==b.type?a:""},e=c.ui.tmpl(g.html(),d);this.reviewlist_content.append(e);var f=b.page[b.type];f.pTotal>1&&f.page_num<f.pTotal?b.pullup_el.removeClass("dn"):b.pullup_el.addClass("dn"),"refresh"==b.page[b.type].role?b._scrollInit():b._scroll.refresh()},_scrollInit:function(){var a=this;this._scroll=c.ui._scroll({wrap:"#J_reviewlist_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullUpAction:function(){var a=this;a.page[a.type].page_num++,a.page[a.type].role="add",console.log(a),"store"==a.type?a._getStoreReviewList():"shop"==a.type&&a._getShopReviewList()}}}var e=(b.bridge,a("#J_reviewlist")),f=a("#J_tpl_reviewlist"),g=a("#J_tpl_reviewlist_list"),h=b.History;c.app.ReviewList=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a){var b=this;b.type=a,b.referer=i.getState().data.referer,b.page=void 0,b.inputEl=void 0,b.inputWrap=void 0,b.searchUl=void 0,b.state=i.getState(),b.page={index:{p:1,pz:20,kw:"",total:0,pageTotal:1},dian:{p:1,pz:20,kw:"",total:0,pageTotal:1},delivery:{p:1,pz:20,kw:"",total:0,pageTotal:1},nearby:{p:1,pz:20,kw:"",total:0,pageTotal:1}},"index"==b.type&&(b.indexData=c.lib.memCache.get("index_search_data")||{},b.page.index.kw=b.indexData.kw),"dian"==b.type&&(b.dianData=c.lib.memCache.get("dian_filter_data")||{},b.page.dian.kw=b.dianData.kw),"delivery"==b.type&&(b.deliveryData=c.lib.memCache.get("delivery_filter_data")||{},b.default_address=c.lib.localStorage.get("default_address")||{},b.page.delivery.kw=b.deliveryData.key),"nearby"==b.type&&(b.nearbyData=c.lib.memCache.get("nearby_filter_data")||{},b.page.nearby.kw=b.nearbyData.kw),b.initHandler()},initHandler:function(){this.startUp()},setAfterPageIn:function(){var c=this;a(b).on("resize.search",function(){c._scroll&&c._scroll.refresh()})},setAfterPageOut:function(d){var e=this;a(b).off("resize.search"),c.lib.memCache.removeValue("update_nearby_index"),"index"==d&&(e.indexData.kw="",c.lib.memCache.set("index_search_data",e.indexData))},setBeforePageOut:function(){document.activeElement.blur()},startUp:function(){var a=this,b=c.ui.tmpl(f.html(),{key:a.page[a.type].kw});c.ui.toast.hide(),e.html(b),a.inputEl=e.find("#J_search_input"),a.searchUl=e.find("#J_search_list"),c.ui.toast.hide(),a.page[a.type].kw&&a._fireSearch(a.page[a.type].kw)},events:[["input","#J_search_input","_inputHandler"],[c.event.click,"#J_search_cancl","_canclHandler"],[c.event.click,"#J_search_sub","_subHandler"]],_inputHandler:function(b,c){var d=this,f=a.trim(c.value.replace(/<|>/g,""));return f?void(f!==d.page[d.type].kw&&d._fireSearch(f)):(d.searchUl.empty(),d.pullup_el.addClass("dn"),"index"==d.type&&(d.indexData.kw=""),"dian"==d.type&&(d.dianData.kw=""),"delivery"==d.type&&(d.deliveryData.key=""),"nearby"==d.type&&(d.nearbyData.kw=""),d.page[d.type].kw=c.value,d._scroll&&(d._scroll=null),void e.find(".list_wrap").attr("style",""))},_canclHandler:function(){var b=this;"index"==b.type?b._switchIndex():"dian"==b.type?(b.dianData.kw="",b._switchDian()):"delivery"==b.type?(b.deliveryData.key="",b._switchDelivery()):"nearby"==b.type&&(b.nearbyData.kw="",b._switchNearby()),a("#J_search").removeAttr("data-ddid").empty(),b._scroll&&(b._scroll=null)},_subHandler:function(){var a=this;"index"==a.type?a._switchIndexNearby():"delivery"==a.type?a._switchDelivery():"dian"==a.type?a._switchDian():"nearby"==a.type&&a._switchNearby()},_fireSearch:function(a){var b=this;b.page[b.type].p=1,b.page[b.type].kw=a,b.searchUl.html(c.ui.tpl.load),"index"==b.type&&b._getIndexStoreList("init"),"dian"==b.type&&b._getDianStoreList("init"),"delivery"==b.type&&b._getTakeoutStoreList("init"),"nearby"==b.type&&b._getNearbyStoreList("init")},_getIndexStoreList:function(a){var b=this;if(!b.indexData.city_data)return void c.ui.toast("请回首页选择城市");var d=b.type+"_"+b.indexData.city_data.cityId+"_"+b.page.index.kw+"_"+b.page.index.p,e=h[d];return e?(b.indexData.kw=b.page.index.kw,void b._buildList({storeList:e.storeDList},a)):void(b.async||(b.async=!0,c.ui.toast.loading(),lib.mtop.request({api:"mtop.life.diandian.getStoreList",v:"1.1",data:{p:b.page.index.p,ibf:0,city:b.indexData.city_data.cityId,kw:b.page.index.kw,pz:b.page.index.pz,f:"1,128,2048,4096,8192",o:"wfzb"},extParam:{}},function(e){var f=e.data;f&&(b.page.index.total=f.count,b.page.index.pageTotal=Math.ceil(parseInt(f.count)/b.page.index.pz),b._buildList({storeList:f.storeDList},a),b.indexData.kw=b.page.index.kw,h[d]=f),b.async=!1,c.ui.toast.hide()},function(a){b.async=!1,c.ui.toast(a)})))},_getDianStoreList:function(a){var b=this,d=b.type+"_"+b.dianData.city+"_"+b.dianData.x+"_"+b.dianData.y+"_"+b.page.dian.kw+"_"+b.dianData.o+"_"+b.page.dian.p+"_"+b.dianData.f+"_"+b.dianData.cat,e=h[d];return e?(b.dianData.kw=b.page.dian.kw,void b._buildList({storeList:e.storeDList},a)):void(b.async||(b.async=!0,lib.mtop.request({api:"mtop.life.diandian.getStoreList",v:"1.1",data:{x:b.dianData.x,y:b.dianData.y,ibf:0,f:b.dianData.f,kw:b.page.dian.kw,cat:b.dianData.cat,p:b.page.dian.p,pz:b.page.dian.pz,city:b.dianData.city,o:b.dianData.o},extParam:{}},function(c){var e=c.data;e&&(b.page.dian.total=e.count,b.page.dian.pageTotal=Math.ceil(parseInt(e.count)/b.page.dian.pz),b.dianData.kw=b.page.dian.kw,b._buildList({storeList:e.storeDList},a),h[d]=e),b.async=!1},function(d){b.async=!1,c.ui.toast(d,b),"add"==a&&b.page.dian.p--})))},_getTakeoutStoreList:function(a){var b=this,d=b.type+"_"+b.default_address.posx+"_"+b.default_address.posy+"_"+b.deliveryData.taste_id+"_"+b.deliveryData.average_price+"_"+b.page.delivery.kw+"_"+b.deliveryData.city+"_"+b.page.delivery.p,e=h[d];if(e)return b.deliveryData.key=b.page.delivery.kw,void b._buildList({storeList:e.storeList||[]},a);if(!b.async){b.async=!0;var f={remark:["page=",b.page.delivery.p,",pageSize=",b.page.delivery.pz,",src=1"].join(""),rn:lib.encode.md5(Date.now()+Math.random().toString(32)).toLowerCase()};c.ui.toast.loading(),lib.mtop.request({api:"mtop.life.diandian.takeoutStoreList",v:"1.0",data:{x:parseFloat(b.default_address.posx),y:parseFloat(b.default_address.posy),taste:parseInt(b.deliveryData.taste_id),minp:0,maxp:parseInt(b.deliveryData.average_price),o:0,key:b.page.delivery.kw,p:b.page.delivery.p,pz:b.page.delivery.pz,city:b.deliveryData.city,statisticsInfo:JSON.stringify(f)},extParam:{}},function(e){var f=e.data;f&&(b.page.delivery.total=f.totalCount,b.page.delivery.pageTotal=Math.ceil(parseInt(f.totalCount)/b.page.delivery.pz),b.deliveryData.key=b.page.delivery.kw,b._buildList({storeList:f.storeList||[]},a),h[d]=f),b.async=!1,c.ui.toast.hide()},function(a){b.async=!1,c.ui.toast(a)})}},_getNearbyStoreList:function(a){var b=this,d=b.type+"_"+b.nearbyData.city+"_"+b.nearbyData.x+"_"+b.nearbyData.y+"_"+b.page.nearby.kw+"_"+b.nearbyData.o+"_"+b.page.nearby.p,e=h[d];return e?(b.nearbyData.kw=b.page.nearby.kw,void b._buildList({storeList:e.storeDList},a)):void(b.async||(b.async=!0,c.ui.toast.loading(),lib.mtop.request({api:"mtop.life.diandian.getStoreList",v:"1.1",data:{x:b.nearbyData.x,y:b.nearbyData.y,p:b.page.nearby.p,ibf:0,city:b.nearbyData.city,kw:b.page.nearby.kw,pz:b.page.nearby.pz,f:"1,128,2048,4096,8192",o:b.nearbyData.o},extParam:{}},function(e){var f=e.data;f&&(b.page.nearby.total=f.count,b.page.nearby.pageTotal=Math.ceil(parseInt(f.count)/b.page.nearby.pz),b.nearbyData.kw=b.page.nearby.kw,b._buildList({storeList:f.storeDList},a),h[d]=f),b.async=!1,c.ui.toast.hide()},function(a){b.async=!1,c.ui.toast(a)})))},_buildList:function(a,b){var d=this;a.referer="search/"+d.type,a.type=d.type;var e=c.ui.tmpl(g.html(),a);"init"==b&&(d.searchUl.html(""),d.page.index.p=1,d.page.delivery.p=1,d.page.nearby.p=1),d.searchUl.append(e),d._scroll?d._scroll.refresh():d._iScrollInit(),d._listHandler()},_listHandler:function(){var a=this;if("index"==a.type){var b=a.page.index;b.pageTotal>1&&b.p<b.pageTotal?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn")}else if("dian"==a.type){var b=a.page.dian;b.pageTotal>1&&b.p<b.pageTotal?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn")}else if("delivery"==a.type){var b=a.page.delivery;b.pageTotal>1&&b.p<b.pageTotal?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn")}else if("nearby"==a.type){var b=a.page.nearby;b.pageTotal>1&&b.p<b.pageTotal?a.pullup_el.removeClass("dn"):a.pullup_el.addClass("dn")}a._scroll&&a._scroll.refresh()},_switchIndex:function(){c.lib.ddState({back:{ddid:"index"}})},_switchDian:function(){a("#J_dian").removeAttr("data-ddid"),c.lib.ddState({back:{ddid:"dian"}})},_switchDelivery:function(){a("#J_delivery").removeAttr("data-ddid"),c.lib.ddState({back:{ddid:"delivery"}})},_switchIndexNearby:function(){var b=this,d="nearby",e={push:{ddid:d,obj:{referer:"search/index"}}};c.lib.memCache.set("update_nearby_index",b.page.index.kw),a("#J_nearby").removeAttr("data-ddid"),c.lib.ddState(e)},_switchNearby:function(){a("#J_nearby").removeAttr("data-ddid"),c.lib.ddState({back:{ddid:"nearby"}})},_iScrollInit:function(){{var a=this;a.pullup_el=e.find(".J_pullUp")}this._scroll=c.ui._scroll({wrap:"#J_search_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullUpAction:function(){var a=this,b=a.page;"index"==a.type?(b.index.p++,a._getIndexStoreList("add")):"dian"==a.type?(b.dian.p++,a._getDianStoreList("add")):"delivery"==a.type?(b.delivery.p++,a._getTakeoutStoreList("add")):"nearby"==a.type&&(b.nearby.p++,a._getNearbyStoreList("add"))}}}var e=(b.bridge,a("#J_search")),f=a("#J_tpl_search"),g=a("#J_tpl_search_list");c.lib.memCache.set("search_cache",{});var h=c.lib.memCache.get("search_cache"),i=b.History;c.app.Search=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a){var b=this;b.id=a,b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){},_renderStatic:function(){e.html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getOtherOrderDetail",v:"1.0",data:{oid:a.id}},function(b){a._buildTmpl(b.data)},function(b){c.ui.toast(b,a)})},_buildTmpl:function(a){var b=this,d=c.ui.tmpl(f.html(),{data:a,orderId:b.id,alt:g.getState().data.referer||"delivery"});e.html(d)}}}var e=(b.bridge,a("#J_atedetails")),f=a("#J_tpl_atedetails"),g=b.History;c.app.AteDetails=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a,b){var c=this;c.type=a,"store"==c.type?c.storeid=b:"shop"==c.type&&(c.shopid=b),c.page={shop:{role:"refresh",page_size:20,page_num:1,total:0,pTotal:1}},c.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){},setAfterPageOut:function(){},_renderStatic:function(){var a=this,b={alt:h.getState().data.referer||a.type+"/"+a.shopid},d=c.ui.tmpl(f.html(),b);a.wrap.html(d),a.pullup_el=a.wrap.find(".J_pullUp"),a.atelist_content=a.wrap.find("#J_atelist_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;"shop"==a.type&&a._getShopAteList()},_getShopAteList:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getWaimaiOrderListForShop",v:"1.0",data:{pn:a.page.shop.page_num,ps:a.page.shop.page_size,id_s:a.shopid},extParam:{}},function(b){var c=b.data;a.page.shop.total=parseInt(c.total),a.page.shop.pTotal=Math.ceil(parseInt(c.total)/a.page.shop.page_size),a._buildTmpl(b.data)},function(b){c.ui.toast(b,a),"add"==a.page.shop.role&&a.page.shop.page_num--})},_buildTmpl:function(a){var b=this;"refresh"==b.page[b.type].role&&(b.atelist_content.html(""),b.page[b.type].page_num=1);var d={shopdata:"shop"==b.type?a:""},e=c.ui.tmpl(g.html(),d);this.atelist_content.append(e);var f=b.page[b.type];f.pTotal>1&&f.page_num<f.pTotal?b.pullup_el.removeClass("dn"):b.pullup_el.addClass("dn"),"refresh"==b.page[b.type].role?b._scrollInit():b._scroll.refresh()},_scrollInit:function(){var a=this;this._scroll=c.ui._scroll({wrap:"#J_atelist_scroll",pullUpAction:function(){a._pullUpAction()}})},_pullUpAction:function(){var a=this;a.page[a.type].page_num++,a.page[a.type].role="add","shop"==a.type&&a._getShopAteList()}}}var e=(b.bridge,a("#J_atelist")),f=a("#J_tplate_list"),g=a("#J_tpl_atelist_item"),h=b.History;c.app.AteList=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:f,init:function(a){var b=this;b.shopid=a,b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){e.supportFunc("setOptionMenu")&&e.push("setOptionMenu",{icon:c.config.option_menu_icon.share},function(){})},_renderStatic:function(){var a=this,b={alt:k.getState().data.referer||"index"},d=c.ui.tmpl(g.html(),b);f.html(d),a.shop_details_content=f.find("#J_shop_details_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;a._getShopInfo()},events:[[c.event.click,".shop_address_wrap","_pushMap"]],menuEvent:"_shareHandler",_pushMap:function(){var b=this;if(b.storeInfo){var d="address_map/show";a("#J_address_map").removeAttr("data-ddid");var e={push:{ddid:d,obj:{data:{posx:b.storeInfo.longitude,posy:b.storeInfo.latitude,areas:b.storeInfo.areas&&b.storeInfo.areas},referer:"store/"+b.shopid}}};c.lib.ddState(e)}},_getShopInfo:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getShopDetail",v:"1.0",data:{id_s:a.shopid,pz:"2",p:"1"},extParam:{}},function(b){b.data&&(a.storeInfo=b.data,a._buildTmpl(b.data))},function(b){c.ui.toast(b,a)})},_shareHandler:function(){var a=this,b={title:"发现了一个美食店铺！",content:a.storeInfo.name+(a.storeInfo.notice?"："+a.storeInfo.notice:""),image:(a.storeInfo.w_pic||c.config.share.default_img)+"_145x145xz.jpg",wb_image:(a.storeInfo.w_pic||c.config.share.default_img)+"_145x145xz.jpg",wb_content:"#淘点点#发现了很赞的店铺"+a.storeInfo.name+"，有时间一定要去去尝试下，详情点击：",url:"http://h5.m.taobao.com/dd/index.htm?_ddid=shop/"+a.storeInfo.shopId};e.push("share",b)},_buildTmpl:function(a){console.log(a);var b=this,d=c.ui.tmpl(h.html(),{data:a});b.startUp(d),b._getVouchers(),c.common.delivery.getTags({id:b.shopid,callback:function(a){b._buildDeliveryTags(a)}}),b._iScrollInit()},startUp:function(a){this.shop_details_content.html(a)},_buildDeliveryTags:function(a){var b=this;if(a.result&&a.result.length){var d=c.ui.tmpl(j.html(),{result:a.result});b.wrap.find("#J_shop_tags_box").html(d).show()}},_getVouchers:function(){var a=this;lib.mtop.request({api:"mtop.dd.voucher.localstore.list",v:"1.0",data:{localstoreId:a.shopid},extParam:{}},function(b){b.data&&a._buildCoupon(b.data)},function(a){c.ui.toast(a)})},_buildCoupon:function(a){console.log(a);var b=this;if(!(parseInt(a.count)<=0)){var d=c.ui.tmpl(i.html(),{data:a,shopid:b.shopid});b.wrap.find("#J_shop_coupon_box").html(d).show()}},_iScrollInit:function(){}}}var e=b.bridge,f=a("#J_shop"),g=a("#J_tpl_shop"),h=a("#J_tpl_shop_content"),i=a("#J_tpl_shop_coupon_list"),j=a("#J_tpl_shop_tags_list"),k=b.History;c.app.Shop=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:f,init:function(a){var b=this;b.wrap=f,b.storeid=a,b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){e.supportFunc("setOptionMenu")&&e.push("setOptionMenu",{icon:c.config.option_menu_icon.share},function(){})},setAfterPageOut:function(){},_renderStatic:function(){var a=this,b={alt:"dian"},d=c.ui.tmpl(g.html(),b);f.html(d),a.store_details_content=f.find("#J_store_details_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;a._getStoreInfo()},_getStoreInfo:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getDetailInfo",v:"1.0",data:{localstore_id:a.storeid},extParam:{}},function(b){b.data&&(a.storeInfo=b.data,a._buildTmpl(b.data),a._getCard(),c._hideTitleBar&&e.push("setTitle",{title:"店铺详情"}))},function(b){c.ui.toast(b,a)})},_getCard:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getMemberCardHui",v:"1.0",data:{localStoreId:a.storeid,sellerNick:a.storeInfo.sellerNick},extParam:{}},function(b){a._buildStoreCard(b.data)},function(a){c.ui.toast(a)})},_buildTmpl:function(a){var b=this;b.data=a;var d=c.ui.tmpl(h.html(),{data:a});b.startUp(d),b._getRecommend(),b._iScrollInit()},_buildStoreCard:function(b){var c=this;if(b.sellerNick){var d='<ul class="shop_preferential" id="J_store_card_item"><li class="J_swipe_page" data-swipeid="store_card/'+encodeURIComponent(b.sellerNick)+'" data-referer="store/'+c.storeInfo.storeId+'"><i class="comm_ic_arrow"></i><span class="name">'+b.huiDesc+'</span><span class="shoplist_type_md">卡</span><span class="num"><spam class="card_vip_icon"></span></span></li></ul>';a("#J_store_card_wrap").html(d).show()}},_renderRecommend:function(b){var d=this;if(b){var e=b.recommendMenuItems;if(e){e=e.split("/");for(var f="",g=0;g<e.length;g++)f+="<span>"+e[g]+"</span>";var h='<div class="comm_box_B"><h2 class="comm_down_line"><i class="comm_ic_arrow"></i>网友推荐菜<span>('+b.totalCount+')<span></h2><div class="shop_recommend_wrap clearfix">'+f+"</div></div>";a(".recommend_box").html(h).on("click",function(){c.lib.ddState({push:{ddid:"carte/dian/"+d.storeid,obj:{referer:"store/"+d.storeid}}})})}else a(".recommend_box").hide()}},_getRecommend:function(){var a=this;lib.mtop.request({api:"mtop.life.diandian.getRecommendItems",v:"1.0",data:{localstoreId:a.storeid},extParam:{}},function(b){b.data&&a._renderRecommend(b.data)},function(b){c.ui.toast(b,a)})},events:[[c.event.click,".li_address","_pushMap"]],menuEvent:"_shareHandler",_pushMap:function(){var b=this;if(b.storeInfo){var d="address_map/show";a("#J_address_map").removeAttr("data-ddid");var e={push:{ddid:d,obj:{data:{posx:b.storeInfo.posx,posy:b.storeInfo.posy},referer:"store/"+b.storeid}}};c.lib.ddState(e)}},_shareHandler:function(){var a=this,b={title:"发现了一个美食店铺！",content:a.data.storeName+(a.data.notes?"："+a.data.notes:""),image:(a.data.pictureUrl||c.config.share.default_img)+"_145x145xz.jpg",wb_image:(a.data.pictureUrl||c.config.share.default_img)+"_145x145xz.jpg",wb_content:"#淘点点#发现了很赞的店铺"+a.data.storeName+"，有时间一定要去去尝试下，详情点击：",url:"http://h5.m.taobao.com/dd/index.htm?_ddid=store/"+a.data.storeId};e.push("share",b)},startUp:function(a){this.store_details_content.html(a)},_iScrollInit:function(){}}}{var e=b.bridge,f=a("#J_store"),g=a("#J_tpl_store"),h=a("#J_tpl_store_content");b.History}c.app.Store=function(){return new d}}(Zepto,window,window.dd),function(a,b,c){function d(){return{wrap:e,init:function(a){var b=this;b.sellerNick=a,b.initHandler()},initHandler:function(){this._renderStatic(),this._renderDynamic()},setAfterPageIn:function(){},setAfterPageOut:function(){},_renderStatic:function(){var a=this,b={alt:h.getState().data.referer||"index"},d=c.ui.tmpl(f.html(),b);e.html(d),a.card_details_content=a.wrap.find("#J_card_details_content").html(c.ui.tpl.load)},_renderDynamic:function(){var a=this;a._getCard()},_getCard:function(){var a=this;a.geo_location=c.lib.memCache.get("geo_location")||{},lib.mtop.request({api:"mtop.life.diandian.getMemberCardDetail",v:"1.0",data:{sellerNick:a.sellerNick,latitude:a.geo_location.latitude||0,longitude:a.geo_location.longitude||0},extParam:{}},function(b){a._buildTmpl(b.data)},function(a){c.ui.toast(a)})},_buildTmpl:function(b){var d=this;b.relateStores&&a.each(b.relateStores,function(a,b){var e,f=c.lib.geoDistance(d.geo_location,{longitude:b.longitude,latitude:b.latitude});e=f>1e3?f/1e3>100?">100千米":c.lib.num2Fixed(f/1e3,1)+"千米":0==f?"":parseInt(f)+"米",b.dtext=e});var e=c.ui.tmpl(g.html(),{data:b,sellerNick:d.sellerNick});this.card_details_content.html(e)},events:[[c.event.click,"#J_store_card_largess_btn","_cardLargessHandler"],[c.event.click,".li_address","_pushMap"]],_cardLargessHandler:function(){var a=this;a.async||(this.async=!0,c.ui.toast.loading(),lib.mtop.request({api:"mtop.taobao.o2o.card.memberCard.ddFetch",v:"1.0",data:{sellerNick:a.sellerNick},extParam:{}},function(b){b.data.num&&a.initHandler(),this.async=!1,c.ui.toast.hide()},function(a){c.ui.toast(a),this.async=!1}))},_pushMap:function(b,d){var e=this,f=a(d);if(e.sellerNick){var g="address_map/show";a("#J_address_map").removeAttr("data-ddid");var h={push:{ddid:g,obj:{data:{posy:f.data("latitude"),posx:f.data("longitude")},referer:"store_card/"+e.sellerNick}}};c.lib.ddState(h)}}}}var e=(b.bridge,a("#J_store_card")),f=a("#J_tpl_store_card"),g=a("#J_tpl_store_card_content"),h=b.History;c.app.StoreCard=function(){return new d}}(Zepto,window,window.dd);